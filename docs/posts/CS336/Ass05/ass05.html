<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="åœ¨Assignment 05 æˆ‘ä»¬å°†ä¼šå®ç°SFTï¼Œ Expert Iterationä»¥åŠGRPOç®—æ³•ï¼Œå¯¹Qwen2.5-Math-1.5Bæ¨¡å‹è¿›è¡Œå¾®è°ƒï¼Œä»¥æå‡å…¶åœ¨MATHæ•°æ®é›†ä¸Šçš„è¡¨ç°ã€‚é€šè¿‡è¿™äº›ç®—æ³•çš„å®ç°ï¼Œæˆ‘ä»¬å°†æ·±å…¥ç†è§£LLMçš„å¯¹é½æ–¹æ³•ï¼Œå¹¶æŒæ¡å¦‚ä½•åº”ç”¨è¿™äº›æŠ€æœ¯æ¥æ”¹è¿›å¤§å‹è¯­è¨€æ¨¡å‹çš„æ€§èƒ½ã€‚">

<title>Assignment 05: LLM Alignment: SFT, Expert Iteration, GRPO &amp; DPO â€“ Learning Note</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../posts/DLFaC/index.html" rel="next">
<link href="../../../posts/CS336/Ass02/ass02.html" rel="prev">
<link href="../../.././style/icon.avif" rel="icon">
<script src="../../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-234273d1456647dabc34a594ac50e507.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dark-0348920b7671f696dc9078d39bff215e.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-234273d1456647dabc34a594ac50e507.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-01e1ab90bb0902c54ef2dc3889c8698d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../../site_libs/bootstrap/bootstrap-dark-987788bda8b0cf97ae4c62c0f40f22af.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../../../site_libs/bootstrap/bootstrap-01e1ab90bb0902c54ef2dc3889c8698d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<link href="../../../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.css" rel="stylesheet">
<script src="../../../site_libs/quarto-contrib/pseudocode-2.4.1/pseudocode.min.js"></script>
<link href="../../../site_libs/quarto-contrib/pseudocode-2.4.1/pseudocode.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-E8EJCZTZG1"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-E8EJCZTZG1', { 'anonymize_ip': true});
</script>
<link href="https://fonts.cdnfonts.com/css/cmu-sans-serif" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
<script>
    MathJax = {
        loader: {
        load: ['[tex]/boldsymbol']
        },
        tex: {
        tags: "all",
        inlineMath: [['$','$'], ['\\(','\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']],
        processEscapes: true,
        processEnvironments: true,
        packages: {
            '[+]': ['boldsymbol']
        }
        }
    };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll(".foldable-header").forEach(header => {
    header.addEventListener("click", () => {
      const block = header.closest(".foldable");
      if (block) {
        block.classList.toggle("is-open");
      }
    });

    // å¯è®¿é—®æ€§ï¼ˆé”®ç›˜ï¼‰
    header.setAttribute("tabindex", "0");
    header.addEventListener("keydown", e => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        header.click();
      }
    });
  });
});
</script>
    <style type="text/css">
    .ps-root .ps-algorithm {
      border-top: 2px solid;
      border-bottom: 2px solid;
    }
    .pseudocode-container {
      text-align: left;
    }
    </style>
  
      <style type="text/css">
      .ps-algorithm > .ps-line {
        text-align: left;
      }
      </style>
    

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar docked quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <a class="flex-grow-1 no-decor" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
          <h1 class="quarto-secondary-nav-title">Assignment 05: LLM Alignment: SFT, Expert Iteration, GRPO &amp; DPO</h1>
        </a>     
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header">
      <a href="../../../index.html" class="sidebar-logo-link">
      <img src="../../.././style/logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/YYZhang2025" title="GitHub organization" class="quarto-navigation-tool px-1" aria-label="GitHub organization"><i class="bi bi-github"></i></a>
    <a href="https://www.linkedin.com/in/zhang-yuyang/" title="LinkedIn" class="quarto-navigation-tool px-1" aria-label="LinkedIn"><i class="bi bi-linkedin"></i></a>
    <a href="https://yyzhang2025.github.io/posts/Blogs/blogs_index.html" title="Personal Blogs" class="quarto-navigation-tool px-1" aria-label="Personal Blogs"><i class="bi bi-globe"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false">
 <span class="menu-text">ğŸ“ 100 AI Papers with Code</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/100-AI-Papers/100_Papers_index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About this series</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/100-AI-Papers/01-transformer/Transformer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Transformer</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/100-AI-Papers/02-vision-transformer/Vision-Transformer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Vision Transformer</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">ğŸ“ Stanford CS336: LLM from Scratch</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About this course</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture01/lec01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 01: Introduction &amp; BPE</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture02/lec02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 02: PyTorch Basics &amp; Resource Accounts</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture03/lec03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 03: Transformer LM Architecture</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture04/lec04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 04: MoE Architecture</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture05&amp;06/lec05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 05&amp;06: GPU Optimization, Triton &amp; FlashAttention</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture07&amp;08/lec07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 07&amp;08: Parallelism</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture9&amp;11/lec9.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 09&amp;11: Scaling Laws</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture10/lec10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 10: Inference &amp; Deployment</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture12/lec12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 12: Evaluation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture13&amp;14/lec13.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 13&amp;14: Data Collection &amp; Processing</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture15/lec15.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 15: LLM Alignment SFT &amp; RLHF(PPO, DPO)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture16&amp;17/lec16.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 16 &amp; 17: LLM Alignment SFT &amp; RLVR(GRPO)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Ass01/ass01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Assignment 01: BPE Tokenizer &amp; Transformer LM</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Ass02/ass02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Assignment 02: Flash Attention &amp; Parallelism</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Ass05/ass05.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Assignment 05: SFT &amp; GRPO</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false">
 <span class="menu-text">ğŸ“– Deep Learning Foundation &amp; Concepts</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/DLFaC/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About this book</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#dataset-preparation-model-download" id="toc-dataset-preparation-model-download" class="nav-link active" data-scroll-target="#dataset-preparation-model-download"><span class="header-section-number">1</span> Dataset Preparation &amp; Model Download</a></li>
  <li><a href="#zero-shot-evaluation-vllm" id="toc-zero-shot-evaluation-vllm" class="nav-link" data-scroll-target="#zero-shot-evaluation-vllm"><span class="header-section-number">2</span> Zero-Shot Evaluation &amp; vLLM</a>
  <ul>
  <li><a href="#vllm" id="toc-vllm" class="nav-link" data-scroll-target="#vllm"><span class="header-section-number">2.1</span> vLLM</a></li>
  </ul></li>
  <li><a href="#supervised-fine-tuning" id="toc-supervised-fine-tuning" class="nav-link" data-scroll-target="#supervised-fine-tuning"><span class="header-section-number">3</span> Supervised Fine Tuning</a>
  <ul>
  <li><a href="#tokenize-prompt-and-output" id="toc-tokenize-prompt-and-output" class="nav-link" data-scroll-target="#tokenize-prompt-and-output"><span class="header-section-number">3.1</span> Tokenize Prompt and Output</a></li>
  <li><a href="#per-token-entropy" id="toc-per-token-entropy" class="nav-link" data-scroll-target="#per-token-entropy"><span class="header-section-number">3.2</span> Per Token Entropy</a></li>
  <li><a href="#getting-log-probs-from-model" id="toc-getting-log-probs-from-model" class="nav-link" data-scroll-target="#getting-log-probs-from-model"><span class="header-section-number">3.3</span> Getting Log Probs from Model</a></li>
  <li><a href="#masked-normalize" id="toc-masked-normalize" class="nav-link" data-scroll-target="#masked-normalize"><span class="header-section-number">3.4</span> Masked Normalize</a></li>
  <li><a href="#sft-micro-batch-training-step" id="toc-sft-micro-batch-training-step" class="nav-link" data-scroll-target="#sft-micro-batch-training-step"><span class="header-section-number">3.5</span> SFT Micro-batch Training Step</a></li>
  <li><a href="#sft-trainer" id="toc-sft-trainer" class="nav-link" data-scroll-target="#sft-trainer"><span class="header-section-number">3.6</span> SFT Trainer</a></li>
  <li><a href="#sft-experiment" id="toc-sft-experiment" class="nav-link" data-scroll-target="#sft-experiment"><span class="header-section-number">3.7</span> SFT Experiment</a></li>
  </ul></li>
  <li><a href="#expert-iteration" id="toc-expert-iteration" class="nav-link" data-scroll-target="#expert-iteration"><span class="header-section-number">4</span> Expert Iteration</a>
  <ul>
  <li><a href="#ei-experiment" id="toc-ei-experiment" class="nav-link" data-scroll-target="#ei-experiment"><span class="header-section-number">4.1</span> EI Experiment</a></li>
  </ul></li>
  <li><a href="#grpo" id="toc-grpo" class="nav-link" data-scroll-target="#grpo"><span class="header-section-number">5</span> GRPO</a>
  <ul>
  <li><a href="#grpo-experiment" id="toc-grpo-experiment" class="nav-link" data-scroll-target="#grpo-experiment"><span class="header-section-number">5.1</span> GRPO Experiment</a></li>
  <li><a href="#other-experiments" id="toc-other-experiments" class="nav-link" data-scroll-target="#other-experiments"><span class="header-section-number">5.2</span> Other Experiments</a>
  <ul>
  <li><a href="#learning-rate-tuning" id="toc-learning-rate-tuning" class="nav-link" data-scroll-target="#learning-rate-tuning"><span class="header-section-number">5.2.1</span> Learning Rate Tuning</a></li>
  <li><a href="#effect-of-baseline" id="toc-effect-of-baseline" class="nav-link" data-scroll-target="#effect-of-baseline"><span class="header-section-number">5.2.2</span> Effect of Baseline</a></li>
  <li><a href="#length-normalization" id="toc-length-normalization" class="nav-link" data-scroll-target="#length-normalization"><span class="header-section-number">5.2.3</span> Length Normalization</a></li>
  <li><a href="#normalization-with-group-std" id="toc-normalization-with-group-std" class="nav-link" data-scroll-target="#normalization-with-group-std"><span class="header-section-number">5.2.4</span> Normalization with group std</a></li>
  <li><a href="#off-policy-vs.-on-policy" id="toc-off-policy-vs.-on-policy" class="nav-link" data-scroll-target="#off-policy-vs.-on-policy"><span class="header-section-number">5.2.5</span> Off-Policy vs.&nbsp;On-Policy</a></li>
  <li><a href="#off-policy-clipping" id="toc-off-policy-clipping" class="nav-link" data-scroll-target="#off-policy-clipping"><span class="header-section-number">5.2.6</span> Off Policy Clipping</a></li>
  <li><a href="#different-prompts" id="toc-different-prompts" class="nav-link" data-scroll-target="#different-prompts"><span class="header-section-number">5.2.7</span> Different Prompts</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#dpo" id="toc-dpo" class="nav-link" data-scroll-target="#dpo"><span class="header-section-number">6</span> DPO</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Assignment 05: LLM Alignment: SFT, Expert Iteration, GRPO &amp; DPO</h1>
</div>

<div>
  <div class="description">
    åœ¨Assignment 05 æˆ‘ä»¬å°†ä¼šå®ç°SFTï¼Œ Expert Iterationä»¥åŠGRPOç®—æ³•ï¼Œå¯¹Qwen2.5-Math-1.5Bæ¨¡å‹è¿›è¡Œå¾®è°ƒï¼Œä»¥æå‡å…¶åœ¨MATHæ•°æ®é›†ä¸Šçš„è¡¨ç°ã€‚é€šè¿‡è¿™äº›ç®—æ³•çš„å®ç°ï¼Œæˆ‘ä»¬å°†æ·±å…¥ç†è§£LLMçš„å¯¹é½æ–¹æ³•ï¼Œå¹¶æŒæ¡å¦‚ä½•åº”ç”¨è¿™äº›æŠ€æœ¯æ¥æ”¹è¿›å¤§å‹è¯­è¨€æ¨¡å‹çš„æ€§èƒ½ã€‚
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="dataset-preparation-model-download" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Dataset Preparation &amp; Model Download</h1>
<div class="tldr foldable is-open">
<div class="tldr-header foldable-header">
<p>TL;DR: å¿«é€Ÿç‰ˆ</p>
</div>
<div class="tldr-container foldable-content">
<p>åªéœ€å°†è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼ŒWe are ready to GOï¼ï¼ï¼</p>
<p>ä¸‹è½½ä»£ç </p>
<div class="sourceCode" id="cb1" data-code-line-numbers=""><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">git</span> clone https://github.com/YYZhang2025/Stanford-CS336.git</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="bu">cd</span> Stanford-CS336/assignment5-alignment</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>å®‰è£…ä¾èµ–ï¼Œä¸‹è½½æ•°æ®é›†å’Œæ¨¡å‹</p>
<div class="sourceCode" id="cb2" data-code-line-numbers=""><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="ex">pip</span> install uv </span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="ex">uv</span> sync <span class="at">--no-install-package</span> flash-attn</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="ex">uv</span> sync</span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="bu">source</span> .venv/bin/activate</span>
<span id="cb2-5"><a href="#cb2-5"></a></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="ex">hf</span> download YuYangZhang/Reasoning-Dataset  <span class="at">--repo-type</span> dataset <span class="at">--local-dir</span> data</span>
<span id="cb2-7"><a href="#cb2-7"></a></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="ex">python</span> download_model.py <span class="dt">\</span></span>
<span id="cb2-9"><a href="#cb2-9"></a>  <span class="at">--repo-id</span> Qwen/Qwen2.5-Math-1.5B <span class="dt">\</span></span>
<span id="cb2-10"><a href="#cb2-10"></a>  <span class="at">--save-dir</span> models/Qwen2.5-Math-1.5B <span class="dt">\</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>  <span class="at">--method</span> snapshot <span class="at">--no-symlinks</span> <span class="at">--verify</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>æˆ‘ä»¬å…ˆæ¥ä¸‹è½½æ¨¡å‹æƒé‡ï¼Œåªéœ€ä¸€ä¸ªå‘½ä»¤ï¼š</p>
<div class="sourceCode" id="cb3" data-code-line-numbers=""><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="ex">python</span> download_model.py <span class="dt">\</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>  <span class="at">--repo-id</span> Qwen/Qwen2.5-Math-1.5B <span class="dt">\</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>  <span class="at">--save-dir</span> models/Qwen2.5-Math-1.5B <span class="dt">\</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>  <span class="at">--method</span> snapshot <span class="at">--no-symlinks</span> <span class="at">--verify</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>é€šè¿‡ä¸Šé¢çš„å‘½ä»¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠQwen2.5-Math-1.5Bæ¨¡å‹ä¸‹è½½åˆ°<code>models/Qwen2.5-Math-1.5B</code>ç›®å½•ä¸‹ã€‚</p>
<hr>
<p>åœ¨è¿™ä¸ªAssignmentä¸­ï¼Œæˆ‘ä»¬å°†ä¼šç”¨åˆ°Math Datasetï¼Œä¸è¿‡Assignmentä¸­ï¼Œç”±äºç‰ˆæƒé—®é¢˜ï¼Œå¹¶æ²¡æœ‰æä¾›å®Œæ•´çš„æ•°æ®ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è‡ªè¡Œä¸‹è½½æ•°æ®é›†ï¼Œåœ¨è¿™ä¸ªAssignmentä¸­ï¼Œæˆ‘ä»¬ä¸»è¦ä¼šç”¨åˆ°ä»¥ä¸‹ä¸¤ä¸ªæ•°æ®é›†ï¼š</p>
<ul>
<li><strong>GSM8K Dataset</strong>ï¼šä¸€ä¸ªåŒ…å«8,500å¤šä¸ªé«˜ä¸­æ°´å¹³æ•°å­¦é—®é¢˜çš„æ•°æ®é›†ï¼Œä¸“æ³¨äºé€æ­¥æ¨ç†å’Œè§£å†³æ–¹æ¡ˆç”Ÿæˆã€‚ï¼ˆè¿™ä¸ªæ•°æ®é›†åœ¨Assignmentä¸­å·²ç»æä¾› <code>data/gsm8k</code>ï¼‰</li>
<li><strong>MATH Dataset</strong>: è¿™ä¸ªæ•°æ®é›†åŒ…å«12,500å¤šä¸ªé«˜ä¸­å’Œå¤§å­¦æ°´å¹³çš„æ•°å­¦é—®é¢˜ï¼Œæ¶µç›–å¤šä¸ªä¸»é¢˜å’Œéš¾åº¦çº§åˆ« <a href="https://huggingface.co/datasets/nlile/hendrycks-MATH-benchmark">Link</a>ã€‚</li>
</ul>
<p>æˆ‘ä»¬ç°åœ¨ä¸‹è½½MATH:</p>
<div class="sourceCode" id="cb4" data-code-line-numbers=""><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1"></a><span class="ex">hf</span> download nlile/hendrycks-MATH-benchmark <span class="dt">\</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>  <span class="at">--repo-type</span> dataset <span class="dt">\</span></span>
<span id="cb4-3"><a href="#cb4-3"></a>  <span class="at">--local-dir</span> ./data/hendrycks-MATH-benchmark</span>
<span id="cb4-4"><a href="#cb4-4"></a></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="fu">mv</span> ./data/hendrycks-MATH-benchmark  ./data/math</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥é¢„å¤„ç†ä¸€ä¸‹è¿™äº›æ•°æ®é›†ï¼Œå› ä¸ºä¸åŒçš„æ•°æ®é›†æ ¼å¼ä¸ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦æŠŠä»–ä»¬å¤„ç†æˆç»Ÿä¸€çš„æ ¼å¼ï¼Œ ä»¥ä¾¿æˆ‘ä»¬åç»­çš„è®­ç»ƒã€‚å…ˆæ¥çœ‹<code>GSM8K</code>æ•°æ®é›†çš„æ ¼å¼ï¼š</p>
<div class="sourceCode" id="cb5" data-code-line-numbers=""><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb5-1"><a href="#cb5-1"></a><span class="fu">{</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>  <span class="dt">"question"</span><span class="fu">:</span> <span class="st">"Natalia sold clips to 48 of her friends in April, and then she sold half as many clips in May. How many clips did Natalia sell altogether in April and May?"</span><span class="fu">,</span> </span>
<span id="cb5-3"><a href="#cb5-3"></a>  <span class="dt">"answer"</span><span class="fu">:</span> <span class="st">"Natalia sold 48/2 = &lt;&lt;48/2=24&gt;&gt;24 clips in May.</span><span class="ch">\n</span><span class="st">Natalia sold 48+24 = &lt;&lt;48+24=72&gt;&gt;72 clips altogether in April and May.</span><span class="ch">\n</span><span class="st">#### 72"</span><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>æ¯ä¸ªæ ·æœ¬åŒ…å« <code>question</code> å’Œ <code>answer</code> ä¸¤ä¸ªå­—æ®µï¼Œæˆ‘ä»¬éœ€è¦æŠŠä»–ä»¬å¤„ç†æˆ <code>prompt</code> å’Œ <code>cot</code> çš„æ ¼å¼ï¼Œå¹¶ä¸”æå–å‡ºé‡Œé¢çš„ç­”æ¡ˆï¼š</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>assignment5-alignment/cs336_alignment/dataset_utils/gsm8k.py</strong></pre>
</div>
<div class="sourceCode" id="cb6" data-filename="assignment5-alignment/cs336_alignment/dataset_utils/gsm8k.py" data-code-line-numbers=""><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw">def</span> extract_gsm8k_answer(answer: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb6-2"><a href="#cb6-2"></a>    ANS_RE <span class="op">=</span> re.<span class="bu">compile</span>(<span class="vs">r"####</span><span class="dv">\s</span><span class="op">*</span><span class="kw">(</span><span class="pp">[</span><span class="ch">\-</span><span class="pp">0-9</span><span class="ch">\.\,</span><span class="pp">]</span><span class="op">+</span><span class="kw">)</span><span class="vs">"</span>)</span>
<span id="cb6-3"><a href="#cb6-3"></a>    match <span class="op">=</span> ANS_RE.search(answer)</span>
<span id="cb6-4"><a href="#cb6-4"></a>    <span class="cf">if</span> match:</span>
<span id="cb6-5"><a href="#cb6-5"></a>        <span class="cf">return</span> match.group(<span class="dv">1</span>).strip().replace(<span class="st">","</span>, <span class="st">""</span>)</span>
<span id="cb6-6"><a href="#cb6-6"></a>    <span class="cf">return</span> <span class="st">"[invalid]"</span></span>
<span id="cb6-7"><a href="#cb6-7"></a></span>
<span id="cb6-8"><a href="#cb6-8"></a></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="kw">def</span> process_row(row: Dict[<span class="bu">str</span>, Any]):</span>
<span id="cb6-10"><a href="#cb6-10"></a>    problem <span class="op">=</span> row[<span class="st">"question"</span>]</span>
<span id="cb6-11"><a href="#cb6-11"></a>    cot <span class="op">=</span> row[<span class="st">"answer"</span>]</span>
<span id="cb6-12"><a href="#cb6-12"></a>    clean_cot <span class="op">=</span> re.sub(<span class="vs">r"</span><span class="dv">\s</span><span class="op">*</span><span class="ch">\n</span><span class="vs">####</span><span class="dv">\s</span><span class="op">*</span><span class="vs">-</span><span class="op">?</span><span class="dv">\d</span><span class="op">+</span>(?:<span class="ch">\.</span><span class="dv">\d</span><span class="op">+</span>)<span class="op">?</span><span class="dv">\s</span><span class="op">*</span><span class="dv">$</span><span class="vs">"</span>, <span class="st">""</span>, cot)</span>
<span id="cb6-13"><a href="#cb6-13"></a>    answer <span class="op">=</span> extract_gsm8k_answer(row[<span class="st">"answer"</span>])</span>
<span id="cb6-14"><a href="#cb6-14"></a></span>
<span id="cb6-15"><a href="#cb6-15"></a>    clean_cot <span class="op">=</span> wrap_cot_with_answer(clean_cot, answer)</span>
<span id="cb6-16"><a href="#cb6-16"></a></span>
<span id="cb6-17"><a href="#cb6-17"></a>    <span class="cf">return</span> problem, <span class="bu">str</span>(clean_cot), <span class="bu">str</span>(answer).lower() <span class="cf">if</span> answer <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>åœ¨é¢„å¤„ç†ä¹‹åï¼Œæˆ‘ä»¬ä¼šæŠŠæ•°æ®é›†å¤„ç†æˆä¸‹é¢çš„æ ¼å¼ï¼š</p>
<div class="sourceCode" id="cb7" data-code-line-numbers=""><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb7-1"><a href="#cb7-1"></a><span class="fu">{</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>  <span class="dt">"question"</span><span class="fu">:</span> <span class="st">"Natalia sold clips to 48 of her friends in April, and then she sold half as many clips in May. How many clips did Natalia sell altogether in April and May?"</span><span class="fu">,</span> </span>
<span id="cb7-3"><a href="#cb7-3"></a>  <span class="dt">"cot"</span><span class="fu">:</span> <span class="st">"Natalia sold 48/2 = &lt;&lt;48/2=24&gt;&gt;24 clips in May.</span><span class="ch">\n</span><span class="st">Natalia sold 48+24 = &lt;&lt;48+24=72&gt;&gt;72 clips altogether in April and May.</span><span class="ch">\n</span><span class="st">&lt;/think&gt; &lt;answer&gt;72&lt;/answer&gt;"</span><span class="fu">,</span> </span>
<span id="cb7-4"><a href="#cb7-4"></a>  <span class="dt">"answer"</span><span class="fu">:</span> <span class="st">"72"</span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>ç±»ä¼¼åœ°ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦å¯¹MATHæ•°æ®é›†è¿›è¡Œé¢„å¤„ç†ï¼ŒMATHæ•°æ®é›†çš„æ ¼å¼å¦‚ä¸‹ï¼š</p>
<div class="sourceCode" id="cb8" data-code-line-numbers=""><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb8-1"><a href="#cb8-1"></a><span class="fu">{</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>  <span class="dt">"problem"</span><span class="fu">:</span> <span class="st">"How many vertical asymptotes does the graph of $y=</span><span class="ch">\\</span><span class="st">frac{2}{x^2+x-6}$ have?"</span><span class="fu">,</span> </span>
<span id="cb8-3"><a href="#cb8-3"></a>  <span class="dt">"solution"</span><span class="fu">:</span> <span class="st">"The denominator of the rational function factors into $x^2+x-6=(x-2)(x+3)$. Since the numerator is always nonzero, there is a vertical asymptote whenever the denominator is $0$, which occurs for $x = 2$ and $x = -3$.  Therefore, the graph has $</span><span class="ch">\\</span><span class="st">boxed{2}$ vertical asymptotes."</span><span class="fu">,</span> </span>
<span id="cb8-4"><a href="#cb8-4"></a>  <span class="dt">"answer"</span><span class="fu">:</span> <span class="st">"2"</span></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>assignment5-alignment/cs336_alignment/dataset_utils/math.py</strong></pre>
</div>
<div class="sourceCode" id="cb9" data-filename="assignment5-alignment/cs336_alignment/dataset_utils/math.py" data-code-line-numbers=""><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw">def</span> process_row(row: Dict[<span class="bu">str</span>, Any]):</span>
<span id="cb9-2"><a href="#cb9-2"></a>    problem <span class="op">=</span> row[<span class="st">"problem"</span>]</span>
<span id="cb9-3"><a href="#cb9-3"></a>    cot <span class="op">=</span> row[<span class="st">"solution"</span>]</span>
<span id="cb9-4"><a href="#cb9-4"></a></span>
<span id="cb9-5"><a href="#cb9-5"></a>    <span class="cf">if</span> row[<span class="st">"answer"</span>] <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb9-6"><a href="#cb9-6"></a>        answer <span class="op">=</span> extract_final_answer_from_text(cot)</span>
<span id="cb9-7"><a href="#cb9-7"></a>    <span class="cf">else</span>:</span>
<span id="cb9-8"><a href="#cb9-8"></a>        answer <span class="op">=</span> row[<span class="st">"answer"</span>]</span>
<span id="cb9-9"><a href="#cb9-9"></a>        cot <span class="op">=</span> wrap_cot_with_answer(cot, answer)</span>
<span id="cb9-10"><a href="#cb9-10"></a></span>
<span id="cb9-11"><a href="#cb9-11"></a>    <span class="cf">return</span> problem, <span class="bu">str</span>(cot), <span class="bu">str</span>(answer).lower() <span class="cf">if</span> answer <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>åœ¨å¤„ç†ä¹‹åï¼Œæˆ‘ä»¬ä¼šæŠŠMATHæ•°æ®é›†å¤„ç†æˆä¸‹é¢çš„æ ¼å¼ï¼š</p>
<div class="sourceCode" id="cb10" data-code-line-numbers=""><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb10-1"><a href="#cb10-1"></a><span class="fu">{</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>  <span class="dt">"question"</span><span class="fu">:</span> <span class="st">"How many vertical asymptotes does the graph of $y=</span><span class="ch">\\</span><span class="st">frac{2}{x^2+x-6}$ have?"</span><span class="fu">,</span> </span>
<span id="cb10-3"><a href="#cb10-3"></a>  <span class="dt">"cot"</span><span class="fu">:</span> <span class="st">"The denominator of the rational function factors into $x^2+x-6=(x-2)(x+3)$. Since the numerator is always nonzero, there is a vertical asymptote whenever the denominator is $0$, which occurs for $x = 2$ and $x = -3$.  Therefore, the graph has $</span><span class="ch">\\</span><span class="st">boxed{2}$ vertical asymptotes.</span><span class="ch">\n</span><span class="st">&lt;/think&gt; &lt;answer&gt;2&lt;/answer&gt;"</span><span class="fu">,</span> </span>
<span id="cb10-4"><a href="#cb10-4"></a>  <span class="dt">"answer"</span><span class="fu">:</span> <span class="st">"2"</span></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>å…·ä½“çš„ç»†èŠ‚ï¼Œçœ‹<code>assignment5-alignment/cs336_alignment/dataset_utils</code> æ–‡ä»¶å¤¹ä¸‹çš„ä»£ç ã€‚ä»¥åŠ <code>assignment5-alignment/preprocess.py</code> è¿™ä¸ªè„šæœ¬ã€‚åœ¨è¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚å¤„ç†å®Œä¹‹åï¼Œæˆ‘ä»¬ä¼šæœ‰ï¼š</p>
<div class="sourceCode" id="cb11" data-code-line-numbers=""><pre class="sourceCode numberSource text number-lines code-with-copy"><code class="sourceCode"><span id="cb11-1"><a href="#cb11-1"></a>data/</span>
<span id="cb11-2"><a href="#cb11-2"></a>â”œâ”€â”€ alpaca_eval/</span>
<span id="cb11-3"><a href="#cb11-3"></a>â”œâ”€â”€ gsm8k/</span>
<span id="cb11-4"><a href="#cb11-4"></a>â”œâ”€â”€ math/</span>
<span id="cb11-5"><a href="#cb11-5"></a>â”œâ”€â”€ mmlu/</span>
<span id="cb11-6"><a href="#cb11-6"></a>â”œâ”€â”€ pre-processed/</span>
<span id="cb11-7"><a href="#cb11-7"></a>â”‚   â”œâ”€â”€ gsm8k/</span>
<span id="cb11-8"><a href="#cb11-8"></a>â”‚   â”‚   â”œâ”€â”€ test.jsonl</span>
<span id="cb11-9"><a href="#cb11-9"></a>â”‚   â”‚   â””â”€â”€ train.jsonl</span>
<span id="cb11-10"><a href="#cb11-10"></a>â”‚   â””â”€â”€ math/</span>
<span id="cb11-11"><a href="#cb11-11"></a>â”‚       â”œâ”€â”€ test.jsonl</span>
<span id="cb11-12"><a href="#cb11-12"></a>â”‚       â””â”€â”€ train.jsonl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>å½“ç„¶ï¼Œå¤§å®¶ä¹Ÿå¯ä»¥é€‰æ‹©ç›´æ¥ä½¿ç”¨æˆ‘å·²ç»å¤„ç†å¥½çš„æ•°æ®é›†ï¼Œ ç›´æ¥ä»<a href="https://huggingface.co/datasets/YuYangZhang/Reasoning-Dataset">è¿™é‡Œ</a>ä¸‹è½½å³å¯ã€‚æˆ–è€…ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼š</p>
<div class="sourceCode" id="cb12" data-code-line-numbers=""><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1"></a><span class="ex">hf</span> download YuYangZhang/Reasoning-Dataset  <span class="at">--repo-type</span> dataset <span class="at">--local-dir</span> data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="zero-shot-evaluation-vllm" class="level1 page-columns page-full" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Zero-Shot Evaluation &amp; vLLM</h1>
<section id="vllm" class="level2 page-columns page-full" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="vllm"><span class="header-section-number">2.1</span> vLLM</h2>
<p>åœ¨è¿™ä¸ªAssignmentä¸­ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨vLLM æ¥è¿›è¡Œæ¨¡å‹çš„æ¨ç†ï¼Œ ä»¥ä¾¿æˆ‘ä»¬å¯ä»¥æ›´å¿«çš„è¿›è¡Œè¯„ä¼°å’Œè®­ç»ƒã€‚ ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•ï¼š</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>assignment5-alignment/cs336_alignment/vllm_utils.py</strong></pre>
</div>
<div class="sourceCode" id="cb13" data-filename="assignment5-alignment/cs336_alignment/vllm_utils.py" data-code-line-numbers=""><pre class="sourceCode numberSource Python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a><span class="kw">def</span> init_vllm(model_id: <span class="bu">str</span>, device: <span class="bu">str</span>, seed: <span class="bu">int</span>, gpu_memory_utilization: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.85</span>):</span>
<span id="cb13-2"><a href="#cb13-2"></a>    vllm_set_random_seed(seed)</span>
<span id="cb13-3"><a href="#cb13-3"></a>    world_size_patch <span class="op">=</span> patch(<span class="st">"torch.distributed.get_world_size"</span>, return_value<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb13-4"><a href="#cb13-4"></a>    profiling_patch <span class="op">=</span> patch(</span>
<span id="cb13-5"><a href="#cb13-5"></a>        <span class="st">"vllm.worker.worker.Worker._assert_memory_footprint_increased_during_profiling"</span>, return_value<span class="op">=</span><span class="va">None</span></span>
<span id="cb13-6"><a href="#cb13-6"></a>    )</span>
<span id="cb13-7"><a href="#cb13-7"></a>    <span class="cf">with</span> world_size_patch, profiling_patch:</span>
<span id="cb13-8"><a href="#cb13-8"></a>        <span class="cf">return</span> LLM(</span>
<span id="cb13-9"><a href="#cb13-9"></a>            model<span class="op">=</span>model_id,</span>
<span id="cb13-10"><a href="#cb13-10"></a>            device<span class="op">=</span>device,</span>
<span id="cb13-11"><a href="#cb13-11"></a>            dtype<span class="op">=</span>torch.bfloat16,</span>
<span id="cb13-12"><a href="#cb13-12"></a>            enable_prefix_caching<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb13-13"><a href="#cb13-13"></a>            gpu_memory_utilization<span class="op">=</span>gpu_memory_utilization,</span>
<span id="cb13-14"><a href="#cb13-14"></a>        )</span>
<span id="cb13-15"><a href="#cb13-15"></a></span>
<span id="cb13-16"><a href="#cb13-16"></a><span class="kw">def</span> load_policy_into_vllm_instance(policy: PreTrainedModel, llm: LLM):</span>
<span id="cb13-17"><a href="#cb13-17"></a>    state_dict <span class="op">=</span> policy.state_dict()</span>
<span id="cb13-18"><a href="#cb13-18"></a>    llm_model <span class="op">=</span> llm.llm_engine.model_executor.driver_worker.model_runner.model</span>
<span id="cb13-19"><a href="#cb13-19"></a>    llm_model.load_weights(state_dict.items())</span>
<span id="cb13-20"><a href="#cb13-20"></a>  </span>
<span id="cb13-21"><a href="#cb13-21"></a><span class="kw">def</span> generate_responses(vllm: LLM, prompts: <span class="bu">list</span>[<span class="bu">str</span>], sampling_params) <span class="op">-&gt;</span> <span class="bu">list</span>[<span class="bu">str</span>]:</span>
<span id="cb13-22"><a href="#cb13-22"></a>    outputs <span class="op">=</span> vllm.generate(</span>
<span id="cb13-23"><a href="#cb13-23"></a>        prompts,</span>
<span id="cb13-24"><a href="#cb13-24"></a>        sampling_params<span class="op">=</span>sampling_params,</span>
<span id="cb13-25"><a href="#cb13-25"></a>    )</span>
<span id="cb13-26"><a href="#cb13-26"></a>    responses <span class="op">=</span> [output.outputs[<span class="dv">0</span>].text <span class="cf">for</span> output <span class="kw">in</span> outputs]</span>
<span id="cb13-27"><a href="#cb13-27"></a>    <span class="cf">return</span> responses</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>å½“æˆ‘ä»¬éœ€è¦ä½¿ç”¨vLLMè¿›è¡Œæ¨ç†æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦å…ˆåˆå§‹åŒ–vLLMå®ä¾‹ï¼Œ ä¹‹åæŠŠæ¨¡å‹æƒé‡loadè¿›å»ï¼Œ æœ€åè°ƒç”¨<code>generate_responses</code>å‡½æ•°å³å¯å®Œæˆæ¨ç†ï¼š</p>
<div class="sourceCode" id="cb14" data-code-line-numbers=""><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1"></a>vllm <span class="op">=</span> init_vllm(</span>
<span id="cb14-2"><a href="#cb14-2"></a>    model_id<span class="op">=</span>MODEL_NAME,</span>
<span id="cb14-3"><a href="#cb14-3"></a>    device<span class="op">=</span><span class="bu">str</span>(get_device(rank<span class="op">=</span><span class="dv">1</span>)),</span>
<span id="cb14-4"><a href="#cb14-4"></a>    seed<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb14-5"><a href="#cb14-5"></a>    gpu_memory_utilization<span class="op">=</span><span class="fl">0.85</span>,</span>
<span id="cb14-6"><a href="#cb14-6"></a>)</span>
<span id="cb14-7"><a href="#cb14-7"></a>sampling_params <span class="op">=</span> SamplingParams(</span>
<span id="cb14-8"><a href="#cb14-8"></a>    max_tokens<span class="op">=</span><span class="dv">1024</span>, temperature<span class="op">=</span><span class="dv">1</span>, top_p<span class="op">=</span><span class="dv">1</span>, stop<span class="op">=</span>[<span class="st">"&lt;/answer&gt;"</span>], include_stop_str_in_output<span class="op">=</span><span class="va">True</span></span>
<span id="cb14-9"><a href="#cb14-9"></a>)</span>
<span id="cb14-10"><a href="#cb14-10"></a>load_policy_into_vllm_instance(policy, vllm)</span>
<span id="cb14-11"><a href="#cb14-11"></a>responses <span class="op">=</span> generate_responses(</span>
<span id="cb14-12"><a href="#cb14-12"></a>    vllm,</span>
<span id="cb14-13"><a href="#cb14-13"></a>    prompts,</span>
<span id="cb14-14"><a href="#cb14-14"></a>    sampling_params<span class="op">=</span>sampling_params,</span>
<span id="cb14-15"><a href="#cb14-15"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å…ˆæ¥è¯„ä¼°ä¸€ä¸‹Qwen2.5-Math-1.5Båœ¨MATHå’ŒGSM8Kæ•°æ®é›†ä¸Šçš„è¡¨ç°ï¼Œ å…·ä½“çš„è¯„ä¼°ä»£ç åœ¨ <code>assignment5-alignment/eval.py</code> ä»¥åŠ <code>assignment5-alignment/cs336_alignment/eval.py</code>ï¼Œ è¿è¡Œä¸‹é¢çš„å‘½ä»¤å³å¯ï¼š</p>
<div class="sourceCode" id="cb15" data-code-line-numbers=""><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1"></a><span class="ex">python</span> eval.py  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>æ¥çœ‹ä¸€ä¸‹è¯„ä¼°ç»“æœï¼š</p>
<div class="column-page">
<div id="tbl-kl-mc-estimation" class="hover quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<div aria-describedby="tbl-kl-mc-estimation-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="table-hover table">
<colgroup>
<col style="width: 17%">
<col style="width: 5%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 8%">
<col style="width: 26%">
<col style="width: 15%">
</colgroup>
<thead>
<tr class="header">
<th>dataset_path</th>
<th>total</th>
<th>answer_correct</th>
<th>format_correct</th>
<th>reward_1</th>
<th>formatted_but_answer_wrong</th>
<th>answer_accuracy</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>math/train.jsonl</td>
<td>12000</td>
<td>359</td>
<td>2038</td>
<td>359</td>
<td>1679</td>
<td>0.029</td>
</tr>
<tr class="even">
<td>math/test.jsonl</td>
<td>500</td>
<td>13</td>
<td>77</td>
<td>13</td>
<td>64</td>
<td>0.026</td>
</tr>
<tr class="odd">
<td>gsm8k/train.jsonl</td>
<td>7473</td>
<td>232</td>
<td>1433</td>
<td>232</td>
<td>1201</td>
<td>0.031</td>
</tr>
<tr class="even">
<td>gsm8k/test.jsonl</td>
<td>1319</td>
<td>41</td>
<td>258</td>
<td>41</td>
<td>217</td>
<td>0.031</td>
</tr>
</tbody>
</table>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-tbl" id="tbl-kl-mc-estimation-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Qwen2.5-Math-1.5B Zero-Shot Evaluation Results on MATH and GSM8K Datasets
</figcaption>
</figure>
</div>
</div>
<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨<a href="https://en.wikipedia.org/wiki/Zero-shot_learning">Zero-Shot</a>çš„æƒ…å†µä¸‹ï¼ŒQwen2.5-Math-1.5Båœ¨MATHå’ŒGSM8Kæ•°æ®é›†ä¸Šçš„è¡¨ç°éƒ½éå¸¸å·®ï¼Œåªæœ‰å¤§çº¦2.6%åˆ°3.1%çš„å‡†ç¡®ç‡ã€‚è¿™ä¹Ÿç¬¦åˆé¢„æœŸï¼Œå› ä¸ºQwen2.5-Math-1.5Bè™½ç„¶æ˜¯ä¸€ä¸ªå¼ºå¤§çš„è¯­è¨€æ¨¡å‹ï¼Œä½†åœ¨æ²¡æœ‰ç»è¿‡ä¸“é—¨å¾®è°ƒçš„æƒ…å†µä¸‹ï¼Œå…¶åœ¨å¤æ‚æ•°å­¦é—®é¢˜ä¸Šçš„è¡¨ç°ä»ç„¶æœ‰é™ã€‚</p>
</section>
</section>
<section id="supervised-fine-tuning" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Supervised Fine Tuning</h1>
<p>é¦–å…ˆç¬¬ä¸€ä¸ªç®—æ³•å°±æ˜¯Supervised Fine Tuningï¼ˆSFTï¼‰ã€‚åœ¨ Alignment è®­ç»ƒé‡Œï¼ŒSFT å¾€å¾€è¢«çœ‹ä½œâ€œç¬¬ä¸€é˜¶æ®µâ€ï¼šç”¨äººå·¥æ ‡æ³¨çš„é«˜è´¨é‡æ•°æ®ï¼ŒæŠŠ base model ä»â€œä¼šè¯´è¯â€æ¨åˆ°â€œæ›´åƒåŠ©ç†ã€æ›´ä¼šæŒ‰æŒ‡ä»¤åšäº‹â€ã€‚åœ¨Post-Trainingä¸­ä¸»è¦èµ·åˆ°ä¸€ä¸ª <span class="hilite-teal">warm-start</span> çš„ä½œç”¨ã€‚ä¸ºä¹‹åçš„Reinforcement Learning ç®—æ³•åšä¸€ä¸ªé“ºå«ï¼Œè¿™æ ·åšçš„ä¸»è¦ç›®çš„æœ‰ä¸¤ä¸ªï¼š</p>
<ol type="1">
<li>Warm-startï¼šè®©æ¨¡å‹å…ˆå˜â€œåƒåŠ©ç†â€</li>
</ol>
<p>base model å¯èƒ½ä¼šä¹±æ ¼å¼ã€è·‘é¢˜ã€ç­”éæ‰€é—®ã€‚SFT ç›´æ¥ç”¨ç¤ºèŒƒæ•°æ®æ•™å®ƒï¼š â€¢ çœ‹åˆ° prompt è¯¥æ€ä¹ˆç»„ç»‡è¾“å‡º â€¢ è¯¥ä¸è¯¥å†™æ¨ç†ã€æ€ä¹ˆå†™ â€¢ æœ€ç»ˆç­”æ¡ˆè¦æ”¾åˆ° <answer> é‡Œ è¿™ä¼šæ˜¾è‘—æé«˜ format correctness / instruction followingï¼Œä¹Ÿæ˜¯ä½ è¯„ä¼°è¡¨é‡Œæœ€å…ˆèƒ½è¢«æ‹‰èµ·æ¥çš„æŒ‡æ ‡ã€‚</answer></p>
<ol start="2" type="1">
<li>ç¨³å®šã€æ ·æœ¬æ•ˆç‡é«˜ï¼ˆæ¯” RL å¥½è®­ï¼‰</li>
</ol>
<p>SFT å°±æ˜¯æœ€å¤§ä¼¼ç„¶/äº¤å‰ç†µï¼Œè®­ç»ƒç›®æ ‡æ˜ç¡®ã€æ¢¯åº¦ç¨³å®šã€æ”¶æ•›æ›´å¯æ§ï¼š â€¢ ä¸éœ€è¦ reward model â€¢ ä¸éœ€è¦ rolloutã€ä¼˜åŠ¿ä¼°è®¡ã€clip/KL ç­‰ä¸€å †è¶…å‚ â€¢ åŒæ ·è®¡ç®—é‡ä¸‹ï¼Œé€šå¸¸æ¯” RL æ›´â€œçœäº‹ã€çœç®—åŠ›â€</p>
<ol start="3" type="1">
<li>å­¦ä¼šâ€œæ­£ç¡®çš„è¾“å‡ºåˆ†å¸ƒâ€ï¼Œå‡å°‘ RL çš„æ¢ç´¢éš¾åº¦</li>
</ol>
<p>RL åªç»™â€œå¥½/ä¸å¥½â€çš„ä¿¡å·ï¼ˆç”šè‡³åªæœ‰æœ€ç»ˆå¯¹é”™ï¼‰ï¼Œå¦‚æœæ¨¡å‹ä¸€å¼€å§‹è¾“å‡ºå¾ˆä¹±ï¼ŒRL ä¼šéå¸¸éš¾å­¦ã€æ–¹å·®å¾ˆå¤§ã€‚ SFT å…ˆæŠŠç­–ç•¥å¸¦åˆ°ä¸€ä¸ªåˆç†åŒºåŸŸï¼ŒRL æ‰æ›´å®¹æ˜“åœ¨æ­¤åŸºç¡€ä¸Šåšæå‡ï¼ˆä¾‹å¦‚æå‡æ­£ç¡®ç‡ã€å‡å°‘å•°å—¦ã€å¯¹é½åå¥½ï¼‰ã€‚</p>
<ol start="4" type="1">
<li>ç”¨ response_mask åªä¼˜åŒ–å›ç­”ï¼Œä¸é€¼æ¨¡å‹â€œèƒŒ promptâ€</li>
</ol>
<p>ä½ å†™çš„ response_mask å¾ˆå…³é”®ï¼šSFT æŠŠ prompt å½“æ¡ä»¶ï¼Œåªåœ¨ response token ä¸Šç®— lossï¼š â€¢ é¿å…æ¨¡å‹èŠ± capacity å»é‡å»º prompt â€¢ è®­ç»ƒä¿¡å·æ›´èšç„¦åœ¨â€œè¯¥æ€ä¹ˆå›ç­”â€ è¿™åœ¨é•¿ prompt/é•¿ä¸Šä¸‹æ–‡æ—¶ç‰¹åˆ«é‡è¦ã€‚</p>
<ol start="5" type="1">
<li>æä¾›â€œè¡Œä¸ºå…ˆéªŒâ€ï¼Œé˜²æ­¢ RL è®­ç»ƒå´©å</li>
</ol>
<p>åœ¨ PPO/GRPO é‡Œç»å¸¸ä¼šæ‹…å¿ƒ reward hackingã€æ¨¡å¼åå¡Œã€è¾“å‡ºé€€åŒ–ã€‚ SFT æä¾›ä¸€ä¸ªå¼ºå…ˆéªŒï¼šå³ä½¿ RL æ›´æ–°è¿‡çŒ›ï¼ŒKL/å‚è€ƒæ¨¡å‹é€šå¸¸ä¹ŸæŠŠå®ƒæ‹‰å› SFT é™„è¿‘ï¼Œè®©è®­ç»ƒæ›´ç¨³ã€‚</p>
<p>SFTçš„ç®—æ³•å¦‚ä¸‹</p>
<div id="algo-sft" class="pseudocode-container quarto-float" data-pseudocode-number="1" data-caption-prefix="Algorithm" data-line-number="true" data-comment-delimiter="#" data-line-number-punc=":" data-no-end="false" data-indent-size="1.2em">
<div class="pseudocode">
\begin{algorithm} \caption{Supervised Fine-Tuning (SFT)} \begin{algorithmic} \Require Initial policy model $\pi_{\theta_{\text{init}}}$ \Require SFT dataset $\mathcal{D}$ (promptâ€“response pairs) \Require Number of SFT steps $n_{\text{sft\_steps}}$ \Require Learning rate $\alpha$ \State $\pi_{\theta} \gets \pi_{\theta_{\text{init}}}$ \For{$\text{step} = 1$ \textbf{to} $n_{\text{sft\_steps}}$} \State Sample a minibatch $\mathcal{D}_b = \{(x_j, y_j)\}_{j=1}^{B}$ from $\mathcal{D}$ \Comment{$x$: prompt/question, $y$: target response} \State $\mathcal{L}_{\text{CE}}(\theta) \gets -\mathbb{E}_{(x,y)\sim \mathcal{D}_b}\left[\sum_{t=1}^{|y|}\log \pi_{\theta}(y_t \mid x, y_{&lt;t})\right]$ \Comment{Teacher-forcing cross-entropy / NLL} \State $\theta \gets \theta - \alpha \nabla_{\theta}\mathcal{L}_{\text{CE}}(\theta)$ \EndFor \State \Return $\pi_{\theta}$ \end{algorithmic} \end{algorithm}
</div>
</div>
<p>å…¶å®ï¼ŒSFT å¯ä»¥è§†ä½œä¸€ä¸ª<strong>Imitation Learning</strong>ï¼Œå…¶è¿‡ç¨‹å°±æ˜¯</p>
<ol type="1">
<li>ç»™å®šä¸€ä¸ªPrompt <span class="math inline">\(P\)</span>ï¼Œ ä»¥åŠä¸€ä¸ªå¯¹åº”çš„Response <span class="math inline">\(R\)</span>ï¼Œ</li>
<li>å°†Promptä¼ å…¥æ¨¡å‹ï¼Œæˆ‘ä»¬å¸Œæœ›å¯ä»¥æ¨¡å‹å¯ä»¥æ ¹æ®è¿™ä¸ªPromptï¼Œ æ¥ç”Ÿæˆå‡ºä¸å¯¹åº”Response ä¸€æ ·çš„å›ç­”ã€‚</li>
</ol>
<p>è¿™ä¸ªä¹Ÿå°±æ˜¯ç”¨è¿‡ Maximize Likelihood æ¥å­¦ä¹ ï¼Œä¹Ÿå°±æ˜¯æœ€å°åŒ–Loss Functionï¼Œåœ¨è¿™ä¸ªæƒ…æ™¯ä¸­ï¼Œä¹Ÿå°±æ˜¯ Cross Entropy Lossã€‚ <span id="eq-sft-loss"><span class="math display">\[
\mathcal{L}_{\text{SFT}}(\theta) = - \sum_{t=1}^{|R|} \log p_\theta(R_t \mid P, R_{&lt;t})
\tag{1}\]</span></span></p>
<p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬å…ˆå®šä¹‰ä¸€äº›helper å‡½æ•°ï¼Œæ¥å¸®æˆ‘ä»¬å®Œæˆè¿™ä¸€ç³»åˆ—ï¼š</p>
<section id="tokenize-prompt-and-output" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="tokenize-prompt-and-output"><span class="header-section-number">3.1</span> Tokenize Prompt and Output</h2>
<p>é¦–å…ˆæˆ‘ä»¬è¦å®šä¹‰çš„ç¬¬ä¸€ä¸ªå‡½æ•°å°±æ˜¯ <code>tokenize_prompt_and_output()</code>, å®ƒçš„ä½œç”¨ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯æ¥æ”¶ä¸€ç³»åˆ—çš„promptsï¼Œå’Œ Responseï¼Œå¹¶ä¸”tokenizeä»–ä»¬ï¼Œå¹¶ä¸”è¿”å›ä»–ä»¬çš„idsã€‚ä¸è¿‡ï¼Œéœ€è¦æ³¨æ„çš„ä¸€ç‚¹ï¼Œä¹Ÿæ˜¯å¾ˆé‡è¦çš„ä¸€ç‚¹å°±æ˜¯ï¼Œ<span class="hilite-pink">æˆ‘ä»¬è¦åŒæ—¶è¿”å›Response Mask</span>ã€‚ æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¿™ä¸ªResponse Maskçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼š</p>
<hr>
<p>å‡å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ª <span class="math inline">\(q\)</span> å’Œ <span class="math inline">\(o\)</span>, æˆ‘ä»¬å°†å®ƒå¹¶åœ¨ä¸€èµ·ï¼Œå¾—åˆ°äº†æˆ‘ä»¬çš„å‡½æ•° <span class="math inline">\([q, o ]\)</span>, æˆ‘ä»¬å°†æ•´æ®µä¼ å…¥Modelï¼Œåœ¨æ²¡æœ‰Response Maskçš„æƒ…å†µä¸‹ï¼Œæ¨¡å‹å°±æ˜¯å¯¹æ‰€æœ‰çš„tokenè®¡ç®—lossï¼Œè¿™æ ·æ¨¡å‹å°±ä¼šè¢«è¿«å»é¢„æµ‹ï¼š</p>
<ol type="1">
<li>prompt é‡Œçš„ä¸‹ä¸€ä¸ª tokenï¼ˆæœ¬è´¨æ˜¯åœ¨â€œå¤è¿°/é‡å»º promptâ€ï¼‰</li>
<li>output é‡Œçš„ tokenï¼ˆè¿™æ‰æ˜¯æˆ‘ä»¬çœŸæ­£å…³å¿ƒçš„ï¼‰</li>
</ol>
<p>ä½†æ˜¯åœ¨SFTè®­ç»ƒçš„é˜¶æ®µï¼Œ prompt æ˜¯è¾“å…¥æ¡ä»¶ï¼Œæˆ‘ä»¬å¹¶ä¸å¸Œæœ›ä¼˜åŒ–æ¨¡å‹å»â€œèƒŒ prompt çš„åˆ†å¸ƒâ€ï¼Œåªå¸Œæœ›å®ƒåœ¨ç»™å®š prompt åç”Ÿæˆæ­£ç¡®è¾“å‡ºã€‚æ‰€ä»¥ç”¨ response_mask æŠŠ loss é™å®šåœ¨ output token ä¸Šï¼š <span class="hilite-pink">è®­ç»ƒä¿¡å·åªæ¥è‡ªå›ç­”éƒ¨åˆ†</span>ã€‚å½“ç„¶ï¼Œé™¤æ­¤ä¹‹å¤–ï¼ŒResponse Maskè¿˜å¯¹åº”ç€pad tokens ä¸¾ä¸ªç›´è§‚çš„ä¾‹å­ï¼š</p>
<p>å‡è®¾è¾“å…¥æ˜¯ï¼š</p>
<ul>
<li>q: â€œ2+2=?â€</li>
<li>o: â€œ4â€</li>
</ul>
<p>æ‹¼æ¥å token åºåˆ—æ˜¯ï¼š<code>[q_tokens][o_tokens][pad...]</code></p>
<p>response_mask ä¼šåƒè¿™æ ·ï¼š</p>
<ul>
<li>q_tokens â†’ False False False â€¦</li>
<li>o_tokens â†’ True True â€¦</li>
<li>pad â†’ False False â€¦</li>
</ul>
<div class="sourceCode" id="cb16" data-code-line-numbers=""><pre class="sourceCode numberSource text number-lines code-with-copy"><code class="sourceCode"><span id="cb16-1"><a href="#cb16-1"></a>Tokens:        [ 2 , + , 2 , = , ? , 4 , &lt;pad&gt; , &lt;pad&gt; ]</span>
<span id="cb16-2"><a href="#cb16-2"></a>Response_mask: [ F , F , F , F , F , T ,   F   ,   F   ] </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>ç»“æœï¼šloss åªåœ¨ â€œ4â€ çš„ token ä¸Šç®—ï¼Œprompt éƒ¨åˆ†å®Œå…¨ä¸å‚ä¸ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹ä»£ç æ˜¯æ€ä¹ˆå®ç°çš„ï¼š</p>
<p>é¦–å…ˆç¬¬ä¸€æ­¥è‡ªç„¶æ˜¯Tokenize Promptså’ŒResponseï¼š</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>assignment5-alignment/cs336_alignment/algs/utils.py</strong></pre>
</div>
<div class="sourceCode" id="cb17" data-filename="assignment5-alignment/cs336_alignment/algs/utils.py" data-code-line-numbers=""><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1"></a>prompt_tokens <span class="op">=</span> tokenizer(</span>
<span id="cb17-2"><a href="#cb17-2"></a>    prompt_strs,</span>
<span id="cb17-3"><a href="#cb17-3"></a>    add_special_tokens<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb17-4"><a href="#cb17-4"></a>    padding<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb17-5"><a href="#cb17-5"></a>    truncation<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb17-6"><a href="#cb17-6"></a>    return_attention_mask<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb17-7"><a href="#cb17-7"></a>)</span>
<span id="cb17-8"><a href="#cb17-8"></a></span>
<span id="cb17-9"><a href="#cb17-9"></a>output_tokens <span class="op">=</span> tokenizer(</span>
<span id="cb17-10"><a href="#cb17-10"></a>    output_strs,</span>
<span id="cb17-11"><a href="#cb17-11"></a>    add_special_tokens<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb17-12"><a href="#cb17-12"></a>    padding<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb17-13"><a href="#cb17-13"></a>    truncation<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb17-14"><a href="#cb17-14"></a>    return_attention_mask<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb17-15"><a href="#cb17-15"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>æ³¨æ„! åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¹¶ä¸ä¼šè¿”å›<code>Tensor</code> è¿”å›çš„æ˜¯Listï¼Œ å¹¶ä¸”Listé‡Œé¢æ¯ä¸ªå…ƒç´ çš„é•¿åº¦æ˜¯ä¸ä¸€æ ·çš„ï¼Œ</p>
<p>æ¥ä¸‹æ¥ï¼Œ æˆ‘ä»¬æŠŠè¿™ä¸¤ä¸ªListä¸­çš„å†…å®¹ concat åœ¨ä¸€èµ·ï¼Œå¾—åˆ° <code>[q, o]</code>ï¼Œ å¹¶ä¸”è®¡ç®—å‡ºæˆ‘ä»¬çš„Response Mask</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>assignment5-alignment/cs336_alignment/algs/utils.py</strong></pre>
</div>
<div class="sourceCode" id="cb18" data-filename="assignment5-alignment/cs336_alignment/algs/utils.py" data-code-line-numbers=""><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1"></a>input_ids <span class="op">=</span> []</span>
<span id="cb18-2"><a href="#cb18-2"></a>response_mask <span class="op">=</span> []</span>
<span id="cb18-3"><a href="#cb18-3"></a></span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="cf">for</span> p_ids, o_ids <span class="kw">in</span> <span class="bu">zip</span>(prompt_tokens[<span class="st">"input_ids"</span>], output_tokens[<span class="st">"input_ids"</span>]):</span>
<span id="cb18-5"><a href="#cb18-5"></a>    combined_ids <span class="op">=</span> p_ids <span class="op">+</span> o_ids</span>
<span id="cb18-6"><a href="#cb18-6"></a>    input_ids.append(combined_ids)</span>
<span id="cb18-7"><a href="#cb18-7"></a></span>
<span id="cb18-8"><a href="#cb18-8"></a>    mask <span class="op">=</span> ([<span class="va">False</span>] <span class="op">*</span> <span class="bu">len</span>(p_ids)) <span class="op">+</span> ([<span class="va">True</span>] <span class="op">*</span> <span class="bu">len</span>(o_ids))</span>
<span id="cb18-9"><a href="#cb18-9"></a>    response_mask.append(mask)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œinput_ids å’Œ response_mask é‡Œé¢çš„<u>å†…å®¹é•¿åº¦ä¸ä¸€æ ·é•¿</u>ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å°†å®ƒPad åˆ°åŒæ ·çš„é•¿åº¦ï¼Œè¿™æ ·æ‰å¯ä»¥ä¼ å…¥æ¨¡å‹ï¼š</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>assignment5-alignment/cs336_alignment/algs/utils.py</strong></pre>
</div>
<div class="sourceCode" id="cb19" data-filename="assignment5-alignment/cs336_alignment/algs/utils.py" data-code-line-numbers=""><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1"></a>MAX_LEN <span class="op">=</span> <span class="bu">max</span>(<span class="bu">len</span>(ids) <span class="cf">for</span> ids <span class="kw">in</span> input_ids)</span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="co"># 151643 for Qwen/Qwen2.5-Math-1.5B</span></span>
<span id="cb19-3"><a href="#cb19-3"></a>pad_id <span class="op">=</span> tokenizer.pad_token_id <span class="cf">if</span> tokenizer.pad_token_id <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> tokenizer.eos_token_id</span>
<span id="cb19-4"><a href="#cb19-4"></a></span>
<span id="cb19-5"><a href="#cb19-5"></a><span class="kw">def</span> pad_to(x, value):</span>
<span id="cb19-6"><a href="#cb19-6"></a>    <span class="cf">return</span> x <span class="op">+</span> [value] <span class="op">*</span> (MAX_LEN <span class="op">-</span> <span class="bu">len</span>(x))</span>
<span id="cb19-7"><a href="#cb19-7"></a></span>
<span id="cb19-8"><a href="#cb19-8"></a>full <span class="op">=</span> torch.tensor([pad_to(x, pad_id) <span class="cf">for</span> x <span class="kw">in</span> input_ids], dtype<span class="op">=</span>torch.<span class="bu">long</span>)</span>
<span id="cb19-9"><a href="#cb19-9"></a>response_mask <span class="op">=</span> torch.tensor([pad_to(x, <span class="va">False</span>) <span class="cf">for</span> x <span class="kw">in</span> response_mask], dtype<span class="op">=</span>torch.<span class="bu">bool</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>æ¥ä¸‹æ¥å°±æ„å»ºæˆ‘ä»¬çš„inputå’Œlabelsï¼Œ Labelsä¸­è®°å½•çš„æ˜¯inputsä¸­çš„ä¸‹ä¸€ä¸ªï¼š</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>assignment5-alignment/cs336_alignment/algs/utils.py</strong></pre>
</div>
<div class="sourceCode" id="cb20" data-filename="assignment5-alignment/cs336_alignment/algs/utils.py" data-code-line-numbers=""><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1"></a>input_ids <span class="op">=</span> full[:, :<span class="op">-</span><span class="dv">1</span>].contiguous()</span>
<span id="cb20-2"><a href="#cb20-2"></a>labels <span class="op">=</span> full[:, <span class="dv">1</span>:].contiguous()</span>
<span id="cb20-3"><a href="#cb20-3"></a>response_mask <span class="op">=</span> response_mask[:, <span class="dv">1</span>:].contiguous()</span>
<span id="cb20-4"><a href="#cb20-4"></a></span>
<span id="cb20-5"><a href="#cb20-5"></a></span>
<span id="cb20-6"><a href="#cb20-6"></a><span class="cf">return</span> {</span>
<span id="cb20-7"><a href="#cb20-7"></a>        <span class="st">"input_ids"</span>: input_ids,</span>
<span id="cb20-8"><a href="#cb20-8"></a>        <span class="st">"labels"</span>: labels,</span>
<span id="cb20-9"><a href="#cb20-9"></a>        <span class="st">"response_mask"</span>: response_mask,</span>
<span id="cb20-10"><a href="#cb20-10"></a>    }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ Response Maskä¸­æ˜¯Labelsä¸­çš„maskï¼Œè€Œä¸æ˜¯inputs_idsä¸­çš„maskã€‚</p>
<div class="tldr foldable is-open">
<div class="tldr-header foldable-header">
<p>TL;DR: Tokenization &amp; Prompts</p>
</div>
<div class="tldr-container foldable-content">
<p>åœ¨è¿™é‡Œå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦åšä¸¤ä»¶äº‹æƒ…ï¼š</p>
<ol type="1">
<li>Tokenize Prompt å’Œ Outputï¼Œè¿™é‡Œçš„Promptæ˜¯æˆ‘ä»¬æ·»åŠ äº†Templateä¹‹å</li>
<li>Concat Tokenized Promptï¼Œ Outputä¸€èµ·ï¼Œå¹¶ä¸”ç”ŸæˆResponse Mask</li>
<li>Paddingåˆ°ç›¸åŒçš„é•¿åº¦</li>
<li>å°†Concatä¹‹åçš„å†…å®¹ç§»ä¸€ä½ï¼Œå¾—åˆ°inputså’Œlabels</li>
</ol>
</div>
</div>
</section>
<section id="per-token-entropy" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="per-token-entropy"><span class="header-section-number">3.2</span> Per Token Entropy</h2>
<p>å¯¹äºæ¯ä¸€ä¸ªä½ç½®<span class="math inline">\(t\)</span>, æ¨¡å‹ä¼šç»™å‡ºä¸€ä¸‹ä¸ªtokençš„åˆ†å¸ƒï¼Œä¹Ÿå°±æ˜¯ <span class="math inline">\(p_{t}(x) = \text{softmax}(\text{logits}_{t})\)</span>, Entropyå®šä¹‰ä¸ºï¼š</p>
<p><span id="eq-entropy"><span class="math display">\[
H(p) = - \sum_{x \in \mathcal{X}} p(x) \log p(x)
\tag{2}\]</span></span></p>
<ul>
<li><strong>Entropy é«˜</strong>ï¼š åˆ†å¸ƒæ›´â€œå¹³â€ï¼Œæ¨¡å‹ä¸é‚£ä¹ˆç¡®å®šï¼ˆæ¢ç´¢æ›´å¼ºï¼‰ï¼ˆå¯¹äºCategory Distributionï¼Œ<span class="math inline">\(p(x) = \frac{1}{| x| }\)</span> æœ‰æœ€é«˜çš„Entropy</li>
<li><strong>Entropy ä½</strong>ï¼šåˆ†å¸ƒæ›´â€œå°–â€ï¼Œæ¨¡å‹æ›´ç¡®å®šï¼ˆå¯èƒ½å˜å¾—è¿‡åº¦è‡ªä¿¡ã€æ¨¡å¼åç¼©ï¼ˆmodel collapseï¼‰</li>
</ul>
<p>åœ¨ RL é‡Œå¦‚æœä½ çœ‹åˆ° entropy å¾ˆå¿«æ‰åˆ°å¾ˆä½ï¼Œå¸¸è§å«ä¹‰æ˜¯ï¼š</p>
<ul>
<li>ç­–ç•¥å˜å¾—å¤ªç¡®å®šï¼ˆexploration å˜å·®ï¼‰</li>
<li>è®­ç»ƒå¯èƒ½å¼€å§‹â€œé’» reward æ¼æ´â€æˆ–è¾“å‡ºå•ä¸€æ¨¡æ¿</li>
<li>å­¦ä¹ å¯èƒ½ä¸ç¨³å®šï¼ˆå°¤å…¶å’Œ KL/clip é…åˆä¸å½“æ—¶ï¼‰</li>
</ul>
<p>è®¡ç®—entropyä¹Ÿå¾ˆç®€å•çš„ï¼Œ</p>
<p><span id="eq-entropy-compute"><span class="math display">\[
\begin{split}
\ell &amp;= \text{logits} \\
\log p &amp;= \log\text{softmax}(\ell) \\
p &amp;= \exp(\log p) \\
H(p) &amp;= - \sum_{x \in \mathcal{X}} p(x) \log p(x)
\end{split}
\tag{3}\]</span></span></p>
<p>ç”¨ä¸Šé¢çš„å…¬å¼ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªå‡½æ•° <code>compute_entropy</code> æ¥è®¡ç®—entropyï¼š</p>
<div class="sourceCode" id="cb21" data-code-line-numbers=""><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1"></a><span class="kw">def</span> compute_entropy(logits: torch.Tensor) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb21-2"><a href="#cb21-2"></a>    <span class="co">"""</span></span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="co">    Compute the entropy of the probability distribution defined by the logits.</span></span>
<span id="cb21-4"><a href="#cb21-4"></a><span class="co">    """</span></span>
<span id="cb21-5"><a href="#cb21-5"></a>    log_probs <span class="op">=</span> F.log_softmax(logits, dim<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb21-6"><a href="#cb21-6"></a>    probs <span class="op">=</span> torch.exp(log_probs)</span>
<span id="cb21-7"><a href="#cb21-7"></a>    entropy <span class="op">=</span> <span class="op">-</span>torch.<span class="bu">sum</span>(probs <span class="op">*</span> log_probs, dim<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb21-8"><a href="#cb21-8"></a></span>
<span id="cb21-9"><a href="#cb21-9"></a>    <span class="cf">return</span> entropy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="getting-log-probs-from-model" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="getting-log-probs-from-model"><span class="header-section-number">3.3</span> Getting Log Probs from Model</h2>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥å®šä¹‰å¦ä¸€ä¸ªHelper Function <code>get_response_log_probs</code> å®ƒçš„ä½œç”¨æ˜¯ï¼š<strong>æŠŠâ€œæ¨¡å‹å¯¹æ¯ä¸ªä½ç½®çœŸå® token çš„æ¡ä»¶æ¦‚ç‡â€ç®—å‡ºæ¥ï¼ˆä»¥ log å½¢å¼ï¼‰ï¼Œå¹¶æŒ‰ token ç²’åº¦è¿”å›</strong> å¯èƒ½ç°åœ¨ç†è§£è¿™ä¸ªæœ‰ç‚¹å›°éš¾ï¼Œåœ¨ä¹‹åSFT å’Œ RL çš„ç®—æ³•ä¸­ï¼Œæˆ‘ä»¬ä¼šå…·ä½“è®²è§£ä¸€ä¸‹çš„ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸‹è¿™ä¸ªå‡½æ•° æˆ‘ä»¬çŸ¥é“ï¼ŒSFT çš„Loss <a href="#eq-sft-loss" class="quarto-xref">Equation&nbsp;1</a> ä¸­éœ€è¦ç”¨åˆ° <span class="math inline">\(\log p_\theta(R_t \mid P, R_{&lt;t})\)</span>ï¼Œ ä¹Ÿå°±æ˜¯æ¨¡å‹åœ¨ä½ç½®<span class="math inline">\(t\)</span>ä¸Šï¼Œ å¯¹çœŸå®token <span class="math inline">\(R_t\)</span>çš„log probã€‚ å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥è®¡ç®—è¿™ä¸ªå€¼ï¼š</p>
<div class="sourceCode" id="cb22" data-code-line-numbers=""><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1"></a><span class="kw">def</span> get_response_log_probs(</span>
<span id="cb22-2"><a href="#cb22-2"></a>    model, input_ids: torch.Tensor, labels: torch.Tensor, return_token_entropy: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span></span>
<span id="cb22-3"><a href="#cb22-3"></a>) <span class="op">-&gt;</span> <span class="bu">dict</span>[<span class="bu">str</span>, torch.Tensor]:</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>å¯¹äºæ¨¡å‹è¾“å‡º <span class="math inline">\(f_{\theta}(x)\)</span>, å…¶è¾“å‡ºçš„æ˜¯Logitsï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰normalizedçš„distributionï¼Œæˆ‘ä»¬ç¬¬ä¸€æ­¥è‡ªç„¶æ˜¯åˆ©ç”¨softmaxæ¥å°†å…¶å˜ä¸ºåˆ†å¸ƒï¼Œ ä¹‹åæˆ‘ä»¬å†æ ¹æ®æˆ‘ä»¬éœ€è¦çš„labelï¼Œä½œä¸ºç´¢å¼•ï¼Œæ¥æå–å‡ºæˆ‘ä»¬éœ€è¦çš„log-probs</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>assignment5-alignment/cs336_alignment/algs/utils.py</strong></pre>
</div>
<div class="sourceCode" id="cb23" data-filename="assignment5-alignment/cs336_alignment/algs/utils.py" data-code-line-numbers="10"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1"></a><span class="kw">def</span> get_response_log_probs(</span>
<span id="cb23-2"><a href="#cb23-2"></a>    model, </span>
<span id="cb23-3"><a href="#cb23-3"></a>    input_ids: torch.Tensor, <span class="co"># ï¼ˆB, Tï¼‰</span></span>
<span id="cb23-4"><a href="#cb23-4"></a>    labels: torch.Tensor, <span class="co"># ï¼ˆB, Tï¼‰</span></span>
<span id="cb23-5"><a href="#cb23-5"></a>    return_token_entropy: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span></span>
<span id="cb23-6"><a href="#cb23-6"></a>) <span class="op">-&gt;</span> <span class="bu">dict</span>[<span class="bu">str</span>, torch.Tensor]:</span>
<span id="cb23-7"><a href="#cb23-7"></a>    logits <span class="op">=</span> model(input_ids<span class="op">=</span>input_ids).logits <span class="co"># (B, T, V)</span></span>
<span id="cb23-8"><a href="#cb23-8"></a></span>
<span id="cb23-9"><a href="#cb23-9"></a>    logp <span class="op">=</span> F.log_softmax(logits, dim<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb23-10"><a href="#cb23-10"></a>    log_probs <span class="op">=</span> logp.gather(<span class="op">-</span><span class="dv">1</span>, labels.unsqueeze(<span class="op">-</span><span class="dv">1</span>)).squeeze(<span class="op">-</span><span class="dv">1</span>) </span>
<span id="cb23-11"><a href="#cb23-11"></a></span>
<span id="cb23-12"><a href="#cb23-12"></a>    res <span class="op">=</span> {</span>
<span id="cb23-13"><a href="#cb23-13"></a>        <span class="st">"log_probs"</span>: log_probs,</span>
<span id="cb23-14"><a href="#cb23-14"></a>    }</span>
<span id="cb23-15"><a href="#cb23-15"></a>    <span class="cf">if</span> return_token_entropy:</span>
<span id="cb23-16"><a href="#cb23-16"></a>        entropy <span class="op">=</span> compute_entropy(logits)</span>
<span id="cb23-17"><a href="#cb23-17"></a>        res[<span class="st">"token_entropy"</span>] <span class="op">=</span> entropy</span>
<span id="cb23-18"><a href="#cb23-18"></a>    <span class="cf">return</span> res</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>è¿™ä¸ªå‡½æ•°æœ€å…³é”®çš„éƒ¨åˆ†å°±æ˜¯ç¬¬10è¡Œï¼Œ é€šè¿‡ <code>gather</code> å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®labelsï¼Œæ¥æå–å‡ºæˆ‘ä»¬éœ€è¦çš„log_probsã€‚<code>logp</code>çš„shapeæ˜¯(B, T, V)ï¼Œ å…¶ä¸­Bæ˜¯Batch Sizeï¼Œ Tæ˜¯Sequence Lengthï¼Œ Væ˜¯Vocabulary Sizeï¼Œè€Œlabelsçš„shapeæ˜¯(B, T)ï¼Œ å› æ­¤é€šè¿‡ <code>gather</code> å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°æ¯ä¸ªä½ç½®ä¸Šï¼ŒçœŸå®tokençš„log_probsï¼Œ æœ€ç»ˆå¾—åˆ°çš„<code>log_probs</code> shapeæ˜¯ (B, T)ï¼Œ ä¹Ÿå°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœã€‚</p>
<div class="warning foldable is-open">
<div class="warning-header foldable-header">
<p>WARNING: About Response Mask</p>
</div>
<div class="warning-container foldable-content">
<p>æˆ‘ä»¬åœ¨è¿™ä¸€æ­¥ï¼Œå¹¶æ²¡ç”¨ç”¨åˆ°Response Maskï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¿”å›æ‰€æœ‰ä½ç½®çš„Log Probsï¼Œ åŒ…æ‹¬Promptéƒ¨åˆ†å’ŒPadéƒ¨åˆ†ã€‚æˆ‘ä»¬éœ€è¦åœ¨ä¹‹åçš„Lossè®¡ç®—ä¸­ <code>masked_normalize</code>ï¼Œä½¿ç”¨Response Maskæ¥Maskæ‰Promptå’ŒPadéƒ¨åˆ†ã€‚</p>
</div>
</div>
<p>å› æ­¤ï¼Œåœ¨SFT ä¸­ï¼ŒLog Probs æˆ‘ä»¬é€šè¿‡ <code>log_probs.sum(dim=-1)</code> å¯ä»¥è®¡ç®—å‡ºLossï¼Œå½“ç„¶ï¼Œåœ¨åšè¿™ä¸ªè®¡ç®—ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦Maskæ‰Promptsï¼Œæˆ‘ä»¬æ¥ä¸‹å»æ¥å®ç°å®ƒï¼š</p>
</section>
<section id="masked-normalize" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="masked-normalize"><span class="header-section-number">3.4</span> Masked Normalize</h2>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥å®ç° <code>masked_normalize</code> å‡½æ•°ï¼Œ è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯ï¼š<strong>æ ¹æ®Maskï¼Œå¯¹Tensorè¿›è¡ŒMaskï¼Œå¹¶ä¸”è¿›è¡ŒNormalize</strong></p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>assignment5-alignment/cs336_alignment/algs/utils.py</strong></pre>
</div>
<div class="sourceCode" id="cb24" data-filename="assignment5-alignment/cs336_alignment/algs/utils.py" data-code-line-numbers=""><pre class="sourceCode numberSource Python number-lines code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1"></a><span class="kw">def</span> masked_normalize(</span>
<span id="cb24-2"><a href="#cb24-2"></a>    tensor: torch.Tensor, <span class="co"># (B, T)</span></span>
<span id="cb24-3"><a href="#cb24-3"></a>    mask: torch.Tensor,  <span class="co"># (B, T)</span></span>
<span id="cb24-4"><a href="#cb24-4"></a>    normalize_constant: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.0</span>, </span>
<span id="cb24-5"><a href="#cb24-5"></a>    dim: <span class="bu">int</span> <span class="op">|</span> <span class="va">None</span> <span class="op">=</span> <span class="va">None</span></span>
<span id="cb24-6"><a href="#cb24-6"></a>) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb24-7"><a href="#cb24-7"></a>    <span class="cf">assert</span> tensor.shape <span class="op">==</span> mask.shape, <span class="st">"Tensor and mask must have the same shape"</span></span>
<span id="cb24-8"><a href="#cb24-8"></a></span>
<span id="cb24-9"><a href="#cb24-9"></a>    masked_f <span class="op">=</span> mask.type_as(tensor)</span>
<span id="cb24-10"><a href="#cb24-10"></a>    masked_tensor <span class="op">=</span> tensor <span class="op">*</span> masked_f</span>
<span id="cb24-11"><a href="#cb24-11"></a>    masked_sum <span class="op">=</span> torch.<span class="bu">sum</span>(masked_tensor, dim<span class="op">=</span>dim) <span class="cf">if</span> dim <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> torch.<span class="bu">sum</span>(masked_tensor)</span>
<span id="cb24-12"><a href="#cb24-12"></a></span>
<span id="cb24-13"><a href="#cb24-13"></a>    <span class="cf">return</span> masked_sum <span class="op">/</span> normalize_constant</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>è¿™ä¸ªå‡½æ•°å¾ˆç®€å•ï¼Œé¦–å…ˆæˆ‘ä»¬ä¼šæ ¹æ®Maskæ¥Maskæ‰Tensorä¸­ä¸éœ€è¦çš„éƒ¨åˆ†ï¼Œ ä¹‹åæˆ‘ä»¬ä¼šå¯¹å‰©ä¸‹çš„éƒ¨åˆ†è¿›è¡ŒSumï¼Œ æœ€åæˆ‘ä»¬ä¼šæ ¹æ®normalize_constantæ¥è¿›è¡ŒNormalizeã€‚ ä¼ å…¥masked_normalizeçš„tensorï¼Œä¸€èˆ¬æ˜¯Log Probsï¼Œ è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è®¡ç®—å‡ºMasked Log Probsçš„å’Œ, ä¹Ÿå°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„Lossã€‚å…¶ä¸­æˆ‘è®¤ä¸ºä¸€ä¸ªå¾ˆå·§å¦™çš„è®¾è®¡æ˜¯ <code>normalize_constant</code> å’Œ <code>dim</code> å‚æ•°ï¼Œ é€šè¿‡è¿™ä¸¤ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥çµæ´»çš„æ§åˆ¶æˆ‘ä»¬æƒ³è¦çš„Normalizeæ–¹å¼ï¼Œ ä»¥åŠæƒ³è¦Sumçš„ç»´åº¦ï¼Œ æ¯”å¦‚ï¼š</p>
<ul>
<li>å¦‚æœæˆ‘ä»¬æƒ³è¦è®¡ç®—Batchä¸­æ‰€æœ‰Tokençš„Lossï¼Œæˆ‘ä»¬å¯ä»¥ä¼ å…¥ <code>dim=None</code>ï¼Œ å¹¶ä¸” <code>normalize_constant = mask.sum()</code>ï¼Œ è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°Batchä¸­æ‰€æœ‰Tokençš„å¹³å‡Lossã€‚ (Token Level Loss)</li>
<li>å¦‚æœæˆ‘ä»¬æƒ³è¦è®¡ç®—Batchä¸­æ¯ä¸ªSequenceçš„Lossï¼Œæˆ‘ä»¬å¯ä»¥ä¼ å…¥ <code>dim=-1</code>ï¼Œ å¹¶ä¸” <code>normalize_constant = mask.sum(dim = -1)</code>ï¼Œ è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°Batchä¸­æ¯ä¸ªSequenceçš„Lossã€‚ (Sequence Level Loss)</li>
</ul>
</section>
<section id="sft-micro-batch-training-step" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="sft-micro-batch-training-step"><span class="header-section-number">3.5</span> SFT Micro-batch Training Step</h2>
<p>æœ‰äº†è¿™äº›Helper Functionsï¼Œæˆ‘ä»¬å¯ä»¥æ¥å®ç°SFTçš„è®­ç»ƒ, ç”±äºQwen2.5-Math-1.5Bçš„æ¨¡å‹æ¯”è¾ƒå¤§ï¼Œ æˆ‘ä»¬ä¸èƒ½å®Œå…¨å®ç°Batch Sizeè¾ƒå¤§çš„ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡<a href="https://www.hopsworks.ai/dictionary/gradient-accumulation">Gradient Accumulation</a>çš„æŠ€æœ¯ï¼Œæ¥ä½¿å¾—è®­ç»ƒå˜å¾—å¯èƒ½ï¼Œæˆ‘ä»¬å…ˆæ¥å®šä¹‰ä¸€å°æ­¥ï¼š</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>assignment5-alignment/cs336_alignment/algs/sft.py</strong></pre>
</div>
<div class="sourceCode" id="cb25" data-filename="assignment5-alignment/cs336_alignment/algs/sft.py" data-code-line-numbers=""><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1"></a><span class="kw">def</span> sft_microbatch_train_step(</span>
<span id="cb25-2"><a href="#cb25-2"></a>    policy_log_probs: torch.Tensor,</span>
<span id="cb25-3"><a href="#cb25-3"></a>    response_mask: torch.Tensor,</span>
<span id="cb25-4"><a href="#cb25-4"></a>    gradient_accumulation_steps: <span class="bu">int</span>,</span>
<span id="cb25-5"><a href="#cb25-5"></a>    normalize_constant: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span id="cb25-6"><a href="#cb25-6"></a>) <span class="op">-&gt;</span> <span class="bu">tuple</span>[torch.Tensor, <span class="bu">dict</span>[<span class="bu">str</span>, torch.Tensor]]:</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>å…¶å®å¾ˆç®€å•ï¼Œè¿™ä¸ªå‡½æ•°å°±åšä¸¤ä»¶äº‹æƒ…ï¼š</p>
<ol type="1">
<li>è®¡ç®—Loss</li>
<li>Backward è®¡ç®—Gradient</li>
</ol>
<p><span id="eq-sft-batch-sum-loss"><span class="math display">\[
\mathcal{L}_{\text{SFT}}^{\text{batch-sum}}
=
-\sum_{i=1}^{B}\sum_{t=1}^{T}
m^{(i)}_t\;
\log p_\theta\!\big(y^{(i)}_t \mid x^{(i)}_{&lt;t}\big)
\tag{4}\]</span></span></p>
<p>å…¶ä¸­ <span class="math inline">\(m_{t}^{(i)}\)</span> è¡¨ç¤ºçš„æ˜¯Maskå€¼</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>assignment5-alignment/cs336_alignment/algs/sft.py</strong></pre>
</div>
<div class="sourceCode" id="cb26" data-filename="assignment5-alignment/cs336_alignment/algs/sft.py" data-code-line-numbers="9"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1"></a>loss_unscaled <span class="op">=</span> masked_normalize(</span>
<span id="cb26-2"><a href="#cb26-2"></a>    policy_log_probs,</span>
<span id="cb26-3"><a href="#cb26-3"></a>    response_mask,</span>
<span id="cb26-4"><a href="#cb26-4"></a>    normalize_constant<span class="op">=</span>normalize_constant,</span>
<span id="cb26-5"><a href="#cb26-5"></a>    dim<span class="op">=-</span><span class="dv">1</span>,</span>
<span id="cb26-6"><a href="#cb26-6"></a>) <span class="co"># æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ dim=-1ï¼Œ è€Œä¸” normalize_constant = 1.0ï¼Œ ä¹Ÿå°±æ˜¯Sequence Level Loss</span></span>
<span id="cb26-7"><a href="#cb26-7"></a></span>
<span id="cb26-8"><a href="#cb26-8"></a>loss_unscaled <span class="op">=</span> <span class="op">-</span>loss_unscaled.mean()</span>
<span id="cb26-9"><a href="#cb26-9"></a>loss_scaled <span class="op">=</span> loss_unscaled <span class="op">/</span> gradient_accumulation_steps </span>
<span id="cb26-10"><a href="#cb26-10"></a>loss_scaled.backward()</span>
<span id="cb26-11"><a href="#cb26-11"></a></span>
<span id="cb26-12"><a href="#cb26-12"></a>metadata <span class="op">=</span> {</span>
<span id="cb26-13"><a href="#cb26-13"></a>    <span class="st">"loss_unscaled"</span>: loss_unscaled.detach(),</span>
<span id="cb26-14"><a href="#cb26-14"></a>}</span>
<span id="cb26-15"><a href="#cb26-15"></a><span class="cf">return</span> loss_scaled.detach(), metadata</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Gradient Accumulationçš„å®ç°ä¹Ÿå¾ˆç®€å•ï¼Œ æˆ‘ä»¬åªéœ€è¦åœ¨è®¡ç®—Lossä¹‹åï¼Œ é™¤ä»¥ <code>gradient_accumulation_steps</code> å³å¯ã€‚ è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ä¹‹åçš„SFT Trainerä¸­ï¼Œ å®ç°Gradient Accumulationçš„åŠŸèƒ½äº†ã€‚</p>
</section>
<section id="sft-trainer" class="level2" data-number="3.6">
<h2 data-number="3.6" class="anchored" data-anchor-id="sft-trainer"><span class="header-section-number">3.6</span> SFT Trainer</h2>
<p>æœ‰äº†è¿™äº›Helper Functionsï¼Œæˆ‘ä»¬å°±å¯ä»¥å®šä¹‰æˆ‘ä»¬çš„SFT Traineräº†ã€‚ç›¸å½“çš„ç›´è§‚</p>
<div class="sourceCode" id="cb27" data-code-line-numbers=""><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1"></a><span class="kw">class</span> SFTTrainer:</span>
<span id="cb27-2"><a href="#cb27-2"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="cb27-3"><a href="#cb27-3"></a>        <span class="va">self</span>,</span>
<span id="cb27-4"><a href="#cb27-4"></a>        model: PreTrainedModel,</span>
<span id="cb27-5"><a href="#cb27-5"></a>        train_config: SFTTrainingConfig,</span>
<span id="cb27-6"><a href="#cb27-6"></a>        device: torch.device,</span>
<span id="cb27-7"><a href="#cb27-7"></a>        dataset_dir_base: <span class="bu">str</span> <span class="op">=</span> <span class="st">"./data/pre-processed"</span>,</span>
<span id="cb27-8"><a href="#cb27-8"></a>    ): </span>
<span id="cb27-9"><a href="#cb27-9"></a>        ...</span>
<span id="cb27-10"><a href="#cb27-10"></a>    </span>
<span id="cb27-11"><a href="#cb27-11"></a>    <span class="kw">def</span> train_step(</span>
<span id="cb27-12"><a href="#cb27-12"></a>        <span class="va">self</span>,</span>
<span id="cb27-13"><a href="#cb27-13"></a>    ) <span class="op">-&gt;</span> <span class="bu">tuple</span>[<span class="bu">float</span>, <span class="bu">float</span>]: </span>
<span id="cb27-14"><a href="#cb27-14"></a>        ... </span>
<span id="cb27-15"><a href="#cb27-15"></a>        </span>
<span id="cb27-16"><a href="#cb27-16"></a>    <span class="kw">def</span> train(<span class="va">self</span>, vllm<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb27-17"><a href="#cb27-17"></a>        ...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>åœ¨è¿™é‡Œå°±ä¸è¿‡å¤šçš„èµ˜è¿°äº†ï¼Œæœ‰éœ€è¦çš„åŒå­¦è¯·è‡ªè¡ŒæŸ¥çœ‹ä»£ç  <a href="https://github.com/YYZhang2025/Stanford-CS336/blob/main/assignment5-alignment/cs336_alignment/algs/sft.py"><code>assignment5-alignment/cs336_alignment/algs/sft.py</code></a> ä»¥åŠå®ƒçš„è®­ç»ƒä»£ç  <a href="https://github.com/YYZhang2025/Stanford-CS336/blob/main/assignment5-alignment/train_sft.py"><code>assignment5-alignment/train_sft.py</code></a></p>
</section>
<section id="sft-experiment" class="level2" data-number="3.7">
<h2 data-number="3.7" class="anchored" data-anchor-id="sft-experiment"><span class="header-section-number">3.7</span> SFT Experiment</h2>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹SFT çš„è®­ç»ƒç»“æœï¼š</p>
<div id="fig-rlhf-vs-rlvr" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-rlhf-vs-rlvr-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-rlhf-vs-rlvr" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-sft-accuracy" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-sft-accuracy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/sft-accuracy.png" class="img-fluid figure-img" data-ref-parent="fig-rlhf-vs-rlvr">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-sft-accuracy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Accuracy
</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-rlhf-vs-rlvr" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-sft-format" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-sft-format-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/sft-format.png" class="img-fluid figure-img" data-ref-parent="fig-rlhf-vs-rlvr">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-sft-format-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Format Reward
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-rlhf-vs-rlvr-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Result of SFT on Qwen2.5-Math-1.5B
</figcaption>
</figure>
</div>
<p>å¯ä»¥çœ‹åˆ°ï¼Œç»è¿‡SFTè®­ç»ƒä¹‹åï¼Œæ¨¡å‹åœ¨MATH, GSM8Kæ•°æ®é›†ä¸Šçš„è¡¨ç°éƒ½æœ‰äº†æ˜¾è‘—çš„æå‡ï¼Œå°¤å…¶æ˜¯åœ¨Format Rewardä¸Šï¼Œæå‡éå¸¸æ˜æ˜¾ï¼Œè¿™ä¹Ÿç¬¦åˆæˆ‘ä»¬ä¹‹å‰æåˆ°çš„SFTçš„ä½œç”¨ï¼Œ è®©æ¨¡å‹å˜å¾—æ›´åƒåŠ©ç†ï¼Œæ›´ä¼šæŒ‰æŒ‡ä»¤åšäº‹ã€‚å¹¶ä¸”Accuracyä¹Ÿæœ‰äº†æ˜¾è‘—çš„æå‡ï¼Œ è¿™ä¹Ÿè¯´æ˜SFTåœ¨æå‡æ¨¡å‹èƒ½åŠ›æ–¹é¢æ˜¯æœ‰æ•ˆçš„ã€‚</p>
</section>
</section>
<section id="expert-iteration" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Expert Iteration</h1>
<div id="algo-ei" class="pseudocode-container quarto-float" data-pseudocode-number="2" data-caption-prefix="Algorithm" data-line-number="true" data-comment-delimiter="#" data-line-number-punc=":" data-no-end="false" data-indent-size="1.2em">
<div class="pseudocode">
\begin{algorithm} \caption{Expert Iteration (EI)} \begin{algorithmic} \Require Initial policy model $\pi_{\theta_{\text{init}}}$ \Require Reward function $R(q, o)$ \Require Task question set $\mathcal{D}$ \Require Number of EI steps $n_{\text{ei\_steps}}$ \Require Number of samples per prompt $G$ \State $\pi_{\theta} \gets \pi_{\theta_{\text{init}}}$ \For{$\text{step} = 1$ \textbf{to} $n_{\text{ei\_steps}}$} \State Sample a batch of questions $\mathcal{D}_b \subset \mathcal{D}$ \State $\pi_{\theta_{\text{old}}} \gets \pi_{\theta}$ \Comment{freeze current policy as expert} \For{\textbf{each} question $q \in \mathcal{D}_b$} \State Sample $G$ candidate outputs $\{o^{(i)}\}_{i=1}^G \sim \pi_{\theta_{\text{old}}}(\cdot \mid q)$ \State Compute rewards $\{r^{(i)}\}_{i=1}^G$, where $r^{(i)} = R(q, o^{(i)})$ \EndFor \State $\mathcal{D}_{\text{sft}} \gets \{(q, o^{(i)}) \mid r^{(i)} &gt; 0\}$ \Comment{keep only correct / high-reward samples} \State $\pi_{\theta} \gets \text{SFT}(\pi_{\theta}, \mathcal{D}_{\text{sft}})$ \Comment{Algorithm 1: supervised fine-tuning on filtered data} \EndFor \State \Return $\pi_{\theta}$ \end{algorithmic} \end{algorithm}
</div>
</div>
<p>Expert Iteration, åœ¨SFTçš„åŸºç¡€ä¸Šï¼Œåªå¤šäº†å‡ æ­¥é‡‡æ ·çš„æ­¥éª¤ï¼Œé€šè¿‡è¿™å‡ ä¸ªæ­¥éª¤ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°æ›´å¤šçš„Prompt-Reponse Parisï¼Œ ä»¥ä¾¿æˆ‘ä»¬æ›´å¥½çš„è®­ç»ƒSFTã€‚åŒæ—¶ï¼Œé‡Œé¢çš„Functionsï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨GRPOä¸­å¤ç”¨ï¼Œå¯ä»¥çœ‹ä½œæ˜¯ä¸ºGRPOåšå¥½å‡†å¤‡ã€‚</p>
<p>åœ¨è¿™é‡Œï¼Œé‡‡æ ·çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šå…ˆé‡å¤ prompts å’Œ answersï¼Œ ä»¥ä¾¿æˆ‘ä»¬å¯ä»¥å¯¹æ¯ä¸ªprompté‡‡æ ·å¤šä¸ªresponseï¼š</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>assignment5-alignment/cs336_alignment/algs/ei.py</strong></pre>
</div>
<div class="sourceCode" id="cb28" data-filename="assignment5-alignment/cs336_alignment/algs/ei.py" data-code-line-numbers=""><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1"></a><span class="kw">def</span> get_ei_batch(</span>
<span id="cb28-2"><a href="#cb28-2"></a>    prompts: <span class="bu">list</span>[<span class="bu">str</span>],</span>
<span id="cb28-3"><a href="#cb28-3"></a>    answers: <span class="bu">list</span>[<span class="bu">str</span>],</span>
<span id="cb28-4"><a href="#cb28-4"></a>    batch_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">512</span>,</span>
<span id="cb28-5"><a href="#cb28-5"></a>    num_responses_per_prompt: <span class="bu">int</span> <span class="op">=</span> <span class="dv">4</span>,</span>
<span id="cb28-6"><a href="#cb28-6"></a>):</span>
<span id="cb28-7"><a href="#cb28-7"></a>    random_index <span class="op">=</span> random.sample(<span class="bu">range</span>(<span class="bu">len</span>(prompts)), k<span class="op">=</span>batch_size)</span>
<span id="cb28-8"><a href="#cb28-8"></a>    random_prompts <span class="op">=</span> [prompts[i] <span class="cf">for</span> i <span class="kw">in</span> random_index]</span>
<span id="cb28-9"><a href="#cb28-9"></a>    random_answers <span class="op">=</span> [answers[i] <span class="cf">for</span> i <span class="kw">in</span> random_index]</span>
<span id="cb28-10"><a href="#cb28-10"></a></span>
<span id="cb28-11"><a href="#cb28-11"></a>    all_prompts <span class="op">=</span> []</span>
<span id="cb28-12"><a href="#cb28-12"></a>    <span class="cf">for</span> prompt <span class="kw">in</span> random_prompts:</span>
<span id="cb28-13"><a href="#cb28-13"></a>        all_prompts.extend([prompt] <span class="op">*</span> num_responses_per_prompt)</span>
<span id="cb28-14"><a href="#cb28-14"></a>    all_true_answers <span class="op">=</span> []</span>
<span id="cb28-15"><a href="#cb28-15"></a>    <span class="cf">for</span> answer <span class="kw">in</span> random_answers:</span>
<span id="cb28-16"><a href="#cb28-16"></a>        all_true_answers.extend([answer] <span class="op">*</span> num_responses_per_prompt)</span>
<span id="cb28-17"><a href="#cb28-17"></a></span>
<span id="cb28-18"><a href="#cb28-18"></a>    <span class="cf">return</span> {</span>
<span id="cb28-19"><a href="#cb28-19"></a>        <span class="st">"prompts"</span>: <span class="bu">list</span>(all_prompts),</span>
<span id="cb28-20"><a href="#cb28-20"></a>        <span class="st">"true_answers"</span>: <span class="bu">list</span>(all_true_answers),</span>
<span id="cb28-21"><a href="#cb28-21"></a>    }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>æœ‰äº†prompts å’Œ answersä¹‹åï¼Œ æˆ‘ä»¬å°±å¯ä»¥è¿›è¡Œé‡‡æ ·äº†ï¼Œ é‡‡æ ·çš„ä»£ç å’Œä¹‹å‰çš„vLLMæ¨ç†ä»£ç æ˜¯ä¸€æ ·çš„ï¼š</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>assignment5-alignment/cs336_alignment/algs/ei.py</strong></pre>
</div>
<div class="sourceCode" id="cb29" data-filename="assignment5-alignment/cs336_alignment/algs/ei.py" data-code-line-numbers=""><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1"></a>sampled_responses <span class="op">=</span> generate_responses(vllm, sampled_prompts, <span class="va">self</span>.sampling_params)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>ä¹‹åæˆ‘ä»¬å°±å¯ä»¥è®¡ç®—Rewardï¼Œ ä»¥åŠè¿‡æ»¤å‡ºé«˜è´¨é‡çš„Prompt-Response Pairsï¼Œ ä»¥ä¾¿æˆ‘ä»¬è¿›è¡ŒSFTè®­ç»ƒï¼š</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>assignment5-alignment/cs336_alignment/algs/ei.py</strong></pre>
</div>
<div class="sourceCode" id="cb30" data-filename="assignment5-alignment/cs336_alignment/algs/ei.py" data-code-line-numbers=""><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1"></a>rewards_dict <span class="op">=</span> compute_rewards_from_responses(</span>
<span id="cb30-2"><a href="#cb30-2"></a>    sampled_responses,</span>
<span id="cb30-3"><a href="#cb30-3"></a>    true_answers,</span>
<span id="cb30-4"><a href="#cb30-4"></a>    reward_fn<span class="op">=</span>REWARD_FN_MAP[<span class="va">self</span>.train_config.reward_fn],</span>
<span id="cb30-5"><a href="#cb30-5"></a>)</span>
<span id="cb30-6"><a href="#cb30-6"></a></span>
<span id="cb30-7"><a href="#cb30-7"></a><span class="co"># 7. Filter responses by reward</span></span>
<span id="cb30-8"><a href="#cb30-8"></a>filtered_prompts, filtered_responses, filtered_answers <span class="op">=</span> filter_by_reward(</span>
<span id="cb30-9"><a href="#cb30-9"></a>    sampled_prompts,</span>
<span id="cb30-10"><a href="#cb30-10"></a>    sampled_responses,</span>
<span id="cb30-11"><a href="#cb30-11"></a>    true_answers,</span>
<span id="cb30-12"><a href="#cb30-12"></a>    rewards_dict,</span>
<span id="cb30-13"><a href="#cb30-13"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>å…·ä½“çš„ç»†èŠ‚ï¼Œå¤§å®¶å¯ä»¥æŸ¥çœ‹ä»£ç  <a href="https://github.com/YYZhang2025/Stanford-CS336/blob/main/assignment5-alignment/cs336_alignment/algs/ei.py"><code>assignment5-alignment/cs336_alignment/algs/ei.py</code></a> ä»¥åŠå®ƒçš„è®­ç»ƒä»£ç  <a href="https://github.com/YYZhang2025/Stanford-CS336/blob/main/assignment5-alignment/train_ei.py"><code>assignment5-alignment/train_ei.py</code></a></p>
<section id="ei-experiment" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="ei-experiment"><span class="header-section-number">4.1</span> EI Experiment</h2>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹EI çš„è®­ç»ƒç»“æœï¼š</p>
<div id="fig-ei-exp" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ei-exp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-ei-exp" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-ei-gsm8k-accuracy" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-ei-gsm8k-accuracy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/ei-gsm8k-accuracy.png" class="img-fluid figure-img" data-ref-parent="fig-ei-exp">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-ei-gsm8k-accuracy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) GSM8K Accuracy
</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-ei-exp" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-ei-math-accuracy" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-ei-math-accuracy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/ei-math-accuracy.png" class="img-fluid figure-img" data-ref-parent="fig-ei-exp">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-ei-math-accuracy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Format Reward
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ei-exp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Result of EI on Qwen2.5-Math-1.5B on MATH and GSM8K Datasets
</figcaption>
</figure>
</div>
<p>å¯ä»¥çœ‹åˆ°ï¼Œç»è¿‡EIè®­ç»ƒä¹‹åï¼Œæ¨¡å‹åœ¨MATH, GSM8Kæ•°æ®é›†ä¸Šçš„è¡¨ç°éƒ½æœ‰äº†æ˜¾è‘—çš„æå‡ï¼Œå°¤å…¶æ˜¯åœ¨Accuracyä¸Šï¼Œæå‡éå¸¸æ˜æ˜¾ï¼Œè¿™ä¹Ÿç¬¦åˆæˆ‘ä»¬ä¹‹å‰æåˆ°çš„EIçš„ä½œç”¨ï¼Œé€šè¿‡é‡‡æ ·æ›´å¤šçš„Prompt-Response Pairsï¼Œæ¥æå‡æ¨¡å‹çš„èƒ½åŠ›ã€‚å¹¶ä¸”Format Rewardä¹Ÿæœ‰äº†æ˜¾è‘—çš„æå‡ï¼Œ è¿™ä¹Ÿè¯´æ˜EIåœ¨æå‡æ¨¡å‹èƒ½åŠ›æ–¹é¢æ˜¯æœ‰æ•ˆçš„ã€‚</p>
</section>
</section>
<section id="grpo" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> GRPO</h1>
<p>ç»è¿‡å‰ä¸¤è½®çš„çƒ­èº«ï¼Œç»ˆäºåˆ°äº†æˆ‘ä»¬æœ¬æ¬¡Assignmentçš„é‡å¤´æˆï¼šGRPOã€‚ GRPOçš„ç®—æ³•å¦‚ä¸‹ï¼š</p>
<div id="algo-grpo" class="pseudocode-container quarto-float" data-pseudocode-number="3" data-caption-prefix="Algorithm" data-line-number="true" data-comment-delimiter="#" data-line-number-punc=":" data-no-end="false" data-indent-size="1.2em">
<div class="pseudocode">
\begin{algorithm} \caption{Group Relative Policy Optimization (GRPO)} \begin{algorithmic} \Require Initial policy $\pi_{\theta_{\text{init}}}$, reward function $R$, dataset of prompts/questions $\mathcal{D}$ \State Initialize policy $\pi_\theta \leftarrow \pi_{\theta_{\text{init}}}$ \For{$\text{step}=1,\dots,n_{\text{grpo\_steps}}$} \State Sample a minibatch of questions $\mathcal{D}_b \subset \mathcal{D}$ \State Snapshot old policy $\pi_{\theta_{\text{old}}} \leftarrow \pi_\theta$ \ForAll{$q \in \mathcal{D}_b$} \State Sample $G$ candidate outputs $\{o^{(i)}\}_{i=1}^{G} \sim \pi_{\theta_{\text{old}}}(\cdot \mid q)$ \State Compute rewards $r^{(i)} \leftarrow R\!\left(q, o^{(i)}\right)$ for $i=1,\dots,G$ \State Compute group-normalized advantages $A^{(i)}$ from $\{r^{(i)}\}_{i=1}^G$ (group normalization) \For{$\text{train\_step}=1,\dots,n_{\text{train\_steps\_per\_rollout\_batch}}$} \State Update $\pi_\theta$ by maximizing the GRPO-Clip objective using $\pi_{\theta_{\text{old}}}$ and $\{(o^{(i)},A^{(i)})\}_{i=1}^G$ \EndFor \EndFor \EndFor \State \Return $\pi_\theta$ \end{algorithmic} \end{algorithm}
</div>
</div>
<p>åœ¨å®ç°ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹GRPOçš„å‡ ä¸ªå…³é”®æ­¥éª¤ï¼š</p>
<ol type="1">
<li><strong>é‡‡æ ·</strong>ï¼šå’ŒEIç±»ä¼¼ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ¯ä¸ªprompté‡‡æ ·å¤šä¸ªresponseï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥è®¡ç®—rewardã€‚</li>
<li><strong>è®¡ç®—Reward</strong>ï¼šæˆ‘ä»¬éœ€è¦è®¡ç®—æ¯ä¸ªresponseçš„rewardï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥è¿›è¡Œåç»­çš„ä¼˜åŒ–ã€‚</li>
<li><strong>è®¡ç®—Log Probs</strong>ï¼šæˆ‘ä»¬éœ€è¦è®¡ç®—æ¯ä¸ªresponseçš„log probsï¼ŒåŒ…æ‹¬Old Policyå’ŒNew Policyçš„log probsã€‚</li>
<li><strong>è®¡ç®—Advantage</strong>ï¼šæˆ‘ä»¬éœ€è¦è®¡ç®—æ¯ä¸ªresponseçš„advantageã€‚</li>
<li><strong>è®¡ç®—Loss</strong>ï¼šæˆ‘ä»¬éœ€è¦è®¡ç®—GRPOçš„Lossï¼Œå¹¶ä¸”è¿›è¡ŒBackwardã€‚</li>
<li><strong>æ›´æ–°Old Policy</strong>ï¼šæˆ‘ä»¬éœ€è¦åœ¨æ¯ä¸ªStepç»“æŸåï¼Œæ›´æ–°Old Policyä¸ºå½“å‰çš„New Policyã€‚</li>
</ol>
<p>æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥çœ‹ã€‚é¦–å…ˆæ˜¯é‡‡æ ·å’Œè®¡ç®—Rewardï¼Œè¿™éƒ¨åˆ†å’ŒEIæ˜¯ä¸€æ ·çš„ï¼Œæˆ‘ä»¬å°±ä¸èµ˜è¿°äº†ï¼Œæˆ‘è¿™é‡Œé‡‡ç”¨çš„æ–¹æ³•ï¼Œä¹Ÿæ˜¯å…ˆé‡å¤prompts å’Œ answersï¼Œ ä»¥ä¾¿æˆ‘ä»¬å¯ä»¥å¯¹æ¯ä¸ªprompté‡‡æ ·å¤šä¸ªresponseï¼š</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>assignment5-alignment/cs336_alignment/algs/grpo.py</strong></pre>
</div>
<div class="sourceCode" id="cb31" data-filename="assignment5-alignment/cs336_alignment/algs/grpo.py" data-code-line-numbers=""><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1"></a><span class="kw">def</span> sample_batch_questions(</span>
<span id="cb31-2"><a href="#cb31-2"></a>    prompts: <span class="bu">list</span>[<span class="bu">str</span>],</span>
<span id="cb31-3"><a href="#cb31-3"></a>    answers: <span class="bu">list</span>[<span class="bu">str</span>],</span>
<span id="cb31-4"><a href="#cb31-4"></a>    batch_size: <span class="bu">int</span>,</span>
<span id="cb31-5"><a href="#cb31-5"></a>    group_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">8</span>,</span>
<span id="cb31-6"><a href="#cb31-6"></a>) <span class="op">-&gt;</span> <span class="bu">tuple</span>[<span class="bu">list</span>[<span class="bu">str</span>], <span class="bu">list</span>[<span class="bu">str</span>]]:</span>
<span id="cb31-7"><a href="#cb31-7"></a>    index <span class="op">=</span> random.sample(<span class="bu">range</span>(<span class="bu">len</span>(prompts)), k<span class="op">=</span>batch_size)</span>
<span id="cb31-8"><a href="#cb31-8"></a>    sampled_prompts <span class="op">=</span> [prompts[i] <span class="cf">for</span> i <span class="kw">in</span> index]</span>
<span id="cb31-9"><a href="#cb31-9"></a>    sampled_answers <span class="op">=</span> [answers[i] <span class="cf">for</span> i <span class="kw">in</span> index]</span>
<span id="cb31-10"><a href="#cb31-10"></a></span>
<span id="cb31-11"><a href="#cb31-11"></a>    batch_prompts <span class="op">=</span> []</span>
<span id="cb31-12"><a href="#cb31-12"></a>    batch_answers <span class="op">=</span> []</span>
<span id="cb31-13"><a href="#cb31-13"></a>    <span class="cf">for</span> p, a <span class="kw">in</span> <span class="bu">zip</span>(sampled_prompts, sampled_answers):</span>
<span id="cb31-14"><a href="#cb31-14"></a>        batch_prompts.extend([p] <span class="op">*</span> group_size)</span>
<span id="cb31-15"><a href="#cb31-15"></a>        batch_answers.extend([a] <span class="op">*</span> group_size)</span>
<span id="cb31-16"><a href="#cb31-16"></a></span>
<span id="cb31-17"><a href="#cb31-17"></a>    <span class="cf">return</span> batch_prompts, batch_answers</span>
<span id="cb31-18"><a href="#cb31-18"></a></span>
<span id="cb31-19"><a href="#cb31-19"></a>rollout_responses <span class="op">=</span> generate_responses(vllm, sample_prompts, <span class="va">self</span>.sampling_params)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>æœ‰äº†é‡‡æ ·çš„responsesä¹‹åï¼Œ æˆ‘ä»¬å°±å¯ä»¥è®¡ç®—Rewardäº†ï¼š</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>assignment5-alignment/cs336_alignment/algs/grpo.py</strong></pre>
</div>
<div class="sourceCode" id="cb32" data-filename="assignment5-alignment/cs336_alignment/algs/grpo.py" data-code-line-numbers=""><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1"></a><span class="kw">def</span> compute_group_normalized_rewards(</span>
<span id="cb32-2"><a href="#cb32-2"></a>    reward_fn: Callable,</span>
<span id="cb32-3"><a href="#cb32-3"></a>    rollout_responses: <span class="bu">list</span>[<span class="bu">str</span>],</span>
<span id="cb32-4"><a href="#cb32-4"></a>    repeated_ground_truths: <span class="bu">list</span>[<span class="bu">str</span>],</span>
<span id="cb32-5"><a href="#cb32-5"></a>    group_size: <span class="bu">int</span>,</span>
<span id="cb32-6"><a href="#cb32-6"></a>    advantage_eps: <span class="bu">float</span>,</span>
<span id="cb32-7"><a href="#cb32-7"></a>    normalized_by_std: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span>,</span>
<span id="cb32-8"><a href="#cb32-8"></a>):</span>
<span id="cb32-9"><a href="#cb32-9"></a>    formatted_rewards <span class="op">=</span> []</span>
<span id="cb32-10"><a href="#cb32-10"></a>    answer_correct_rewards <span class="op">=</span> []</span>
<span id="cb32-11"><a href="#cb32-11"></a>    rewards <span class="op">=</span> []</span>
<span id="cb32-12"><a href="#cb32-12"></a>    <span class="cf">for</span> response, true_answer <span class="kw">in</span> <span class="bu">zip</span>(rollout_responses, repeated_ground_truths):</span>
<span id="cb32-13"><a href="#cb32-13"></a>        reward_info <span class="op">=</span> reward_fn(response, true_answer)</span>
<span id="cb32-14"><a href="#cb32-14"></a>        rewards.append(reward_info[<span class="st">"reward"</span>])</span>
<span id="cb32-15"><a href="#cb32-15"></a>        formatted_rewards.append(reward_info[<span class="st">"format_reward"</span>])</span>
<span id="cb32-16"><a href="#cb32-16"></a>        answer_correct_rewards.append(reward_info[<span class="st">"answer_reward"</span>])</span>
<span id="cb32-17"><a href="#cb32-17"></a></span>
<span id="cb32-18"><a href="#cb32-18"></a>    advs <span class="op">=</span> []</span>
<span id="cb32-19"><a href="#cb32-19"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(rewards), group_size):</span>
<span id="cb32-20"><a href="#cb32-20"></a>        group_rewards <span class="op">=</span> rewards[i : i <span class="op">+</span> group_size]</span>
<span id="cb32-21"><a href="#cb32-21"></a>        group_rewards_tensor <span class="op">=</span> torch.tensor(group_rewards)</span>
<span id="cb32-22"><a href="#cb32-22"></a>        group_mean <span class="op">=</span> torch.mean(group_rewards_tensor)</span>
<span id="cb32-23"><a href="#cb32-23"></a>        <span class="cf">if</span> normalized_by_std:</span>
<span id="cb32-24"><a href="#cb32-24"></a>            group_std <span class="op">=</span> torch.std(group_rewards_tensor) <span class="op">+</span> advantage_eps</span>
<span id="cb32-25"><a href="#cb32-25"></a>            normalized_rewards <span class="op">=</span> (group_rewards_tensor <span class="op">-</span> group_mean) <span class="op">/</span> group_std</span>
<span id="cb32-26"><a href="#cb32-26"></a>        <span class="cf">else</span>:</span>
<span id="cb32-27"><a href="#cb32-27"></a>            normalized_rewards <span class="op">=</span> group_rewards_tensor <span class="op">-</span> group_mean</span>
<span id="cb32-28"><a href="#cb32-28"></a>        advs.extend(normalized_rewards.tolist())</span>
<span id="cb32-29"><a href="#cb32-29"></a></span>
<span id="cb32-30"><a href="#cb32-30"></a>    meta_info <span class="op">=</span> {}</span>
<span id="cb32-31"><a href="#cb32-31"></a></span>
<span id="cb32-32"><a href="#cb32-32"></a>    <span class="cf">return</span> advs, rewards, meta_info</span>
<span id="cb32-33"><a href="#cb32-33"></a>advantages, raw_rewards, metadata <span class="op">=</span> compute_group_normalized_rewards(</span>
<span id="cb32-34"><a href="#cb32-34"></a>    reward_fn<span class="op">=</span><span class="va">self</span>.reward_fn,</span>
<span id="cb32-35"><a href="#cb32-35"></a>    rollout_responses<span class="op">=</span>rollout_responses,</span>
<span id="cb32-36"><a href="#cb32-36"></a>    repeated_ground_truths<span class="op">=</span>repeated_ground_truths,</span>
<span id="cb32-37"><a href="#cb32-37"></a>    group_size<span class="op">=</span><span class="va">self</span>.train_config.group_size,</span>
<span id="cb32-38"><a href="#cb32-38"></a>    advantage_eps<span class="op">=</span><span class="va">self</span>.train_config.advantage_eps,</span>
<span id="cb32-39"><a href="#cb32-39"></a>    normalized_by_std<span class="op">=</span><span class="va">self</span>.train_config.norm_by_std,</span>
<span id="cb32-40"><a href="#cb32-40"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œ æˆ‘ä»¬è®¡ç®—äº†æ¯ä¸ªresponseçš„rewardï¼Œ ä¹‹åæˆ‘ä»¬æ ¹æ®group sizeï¼Œ æ¥è®¡ç®—group normalized advantagesã€‚ å…·ä½“æ¥è¯´ï¼Œ æˆ‘ä»¬ä¼šå°†æ¯ä¸ªgroupä¸­çš„rewardsï¼Œ è®¡ç®—meanå’Œstdï¼Œ ä¹‹åæˆ‘ä»¬ä¼šæ ¹æ®meanå’Œstdæ¥è®¡ç®—normalized rewardsï¼Œ ä¹Ÿå°±æ˜¯advantagesã€‚ è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œ å¯ä»¥å‡å°‘ä¸åŒgroupä¹‹é—´çš„reward scaleå·®å¼‚ï¼Œ ä½¿å¾—è®­ç»ƒæ›´åŠ ç¨³å®šã€‚</p>
<p>æœ‰äº†advantagesä¹‹åï¼Œ æˆ‘ä»¬å°±å¯ä»¥è®¡ç®—Log Probsäº†ï¼Œ</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>assignment5-alignment/cs336_alignment/algs/grpo.py</strong></pre>
</div>
<div class="sourceCode" id="cb33" data-filename="assignment5-alignment/cs336_alignment/algs/grpo.py" data-code-line-numbers=""><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1"></a>input_ids <span class="op">=</span> tokenized[<span class="st">"input_ids"</span>].to(<span class="va">self</span>.device, non_blocking<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-2"><a href="#cb33-2"></a>labels <span class="op">=</span> tokenized[<span class="st">"labels"</span>].to(<span class="va">self</span>.device, non_blocking<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-3"><a href="#cb33-3"></a>response_mask <span class="op">=</span> tokenized[<span class="st">"response_mask"</span>].to(<span class="va">self</span>.device, non_blocking<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-4"><a href="#cb33-4"></a>ave_length <span class="op">=</span> response_mask.<span class="bu">sum</span>(dim<span class="op">=</span><span class="dv">1</span>).<span class="bu">float</span>().mean().item()</span>
<span id="cb33-5"><a href="#cb33-5"></a></span>
<span id="cb33-6"><a href="#cb33-6"></a>old_log_probs <span class="op">=</span> []</span>
<span id="cb33-7"><a href="#cb33-7"></a><span class="va">self</span>.model.<span class="bu">eval</span>()</span>
<span id="cb33-8"><a href="#cb33-8"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb33-9"><a href="#cb33-9"></a>    <span class="cf">for</span> i <span class="kw">in</span> trange(<span class="dv">0</span>, input_ids.size(<span class="dv">0</span>), <span class="va">self</span>.train_config.micro_batch_size):</span>
<span id="cb33-10"><a href="#cb33-10"></a>        batch_input_ids <span class="op">=</span> input_ids[i : i <span class="op">+</span> <span class="va">self</span>.train_config.micro_batch_size]</span>
<span id="cb33-11"><a href="#cb33-11"></a>        batch_labels <span class="op">=</span> labels[i : i <span class="op">+</span> <span class="va">self</span>.train_config.micro_batch_size]</span>
<span id="cb33-12"><a href="#cb33-12"></a></span>
<span id="cb33-13"><a href="#cb33-13"></a>        <span class="cf">with</span> <span class="va">self</span>.ctx:</span>
<span id="cb33-14"><a href="#cb33-14"></a>            policy_outputs <span class="op">=</span> get_response_log_probs(</span>
<span id="cb33-15"><a href="#cb33-15"></a>                <span class="va">self</span>.model,</span>
<span id="cb33-16"><a href="#cb33-16"></a>                input_ids<span class="op">=</span>batch_input_ids,</span>
<span id="cb33-17"><a href="#cb33-17"></a>                labels<span class="op">=</span>batch_labels,</span>
<span id="cb33-18"><a href="#cb33-18"></a>                return_token_entropy<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb33-19"><a href="#cb33-19"></a>            )</span>
<span id="cb33-20"><a href="#cb33-20"></a>            batch_log_probs <span class="op">=</span> policy_outputs[<span class="st">"log_probs"</span>]</span>
<span id="cb33-21"><a href="#cb33-21"></a></span>
<span id="cb33-22"><a href="#cb33-22"></a>        old_log_probs.append(batch_log_probs.cpu())</span>
<span id="cb33-23"><a href="#cb33-23"></a>old_log_probs <span class="op">=</span> torch.cat(old_log_probs, dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb33-24"><a href="#cb33-24"></a><span class="va">self</span>.model.train()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>åœ¨è¿™é‡Œï¼Œæˆ‘ä¹Ÿç”¨äº†ç±»ä¼¼äºGradient Accumulationçš„æŠ€æœ¯ï¼Œ æ¥è®¡ç®—Old Policyçš„Log Probsï¼Œ ä»¥ä¾¿èŠ‚çœæ˜¾å­˜ã€‚ è®¡ç®—New Policyçš„Log Probsä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œ è¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚</p>
<p>æœ‰äº†Old Policyå’ŒNew Policyçš„Log Probsä¹‹åï¼Œ æˆ‘ä»¬å°±å¯ä»¥è®¡ç®—GRPOçš„Lossäº†ï¼š</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>assignment5-alignment/cs336_alignment/algs/grpo.py</strong></pre>
</div>
<div class="sourceCode" id="cb34" data-filename="assignment5-alignment/cs336_alignment/algs/grpo.py" data-code-line-numbers=""><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1"></a><span class="kw">def</span> grpo_microbatch_train_step(</span>
<span id="cb34-2"><a href="#cb34-2"></a>    policy_log_probs: torch.Tensor,</span>
<span id="cb34-3"><a href="#cb34-3"></a>    response_mask: torch.Tensor,</span>
<span id="cb34-4"><a href="#cb34-4"></a>    gradient_accumulation_steps: <span class="bu">int</span>,</span>
<span id="cb34-5"><a href="#cb34-5"></a>    loss_type: Literal[<span class="st">"no_baseline"</span>, <span class="st">"reinforce_with_baseline"</span>, <span class="st">"grpo_clip"</span>],</span>
<span id="cb34-6"><a href="#cb34-6"></a>    raw_rewards: torch.Tensor <span class="op">|</span> <span class="va">None</span> <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb34-7"><a href="#cb34-7"></a>    advantages: torch.Tensor <span class="op">|</span> <span class="va">None</span> <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb34-8"><a href="#cb34-8"></a>    old_log_probs: torch.Tensor <span class="op">|</span> <span class="va">None</span> <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb34-9"><a href="#cb34-9"></a>    cliprange: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span id="cb34-10"><a href="#cb34-10"></a>) <span class="op">-&gt;</span> <span class="bu">tuple</span>[torch.Tensor, <span class="bu">dict</span>]:</span>
<span id="cb34-11"><a href="#cb34-11"></a>    <span class="co">"""</span></span>
<span id="cb34-12"><a href="#cb34-12"></a><span class="co">    Compute the GRPO loss over microbatches for training.</span></span>
<span id="cb34-13"><a href="#cb34-13"></a><span class="co">    """</span></span>
<span id="cb34-14"><a href="#cb34-14"></a>    loss, metadata <span class="op">=</span> compute_policy_gradient_loss(</span>
<span id="cb34-15"><a href="#cb34-15"></a>        policy_log_probs<span class="op">=</span>policy_log_probs,</span>
<span id="cb34-16"><a href="#cb34-16"></a>        loss_type<span class="op">=</span>loss_type,</span>
<span id="cb34-17"><a href="#cb34-17"></a>        raw_rewards<span class="op">=</span>raw_rewards,</span>
<span id="cb34-18"><a href="#cb34-18"></a>        advantages<span class="op">=</span>advantages,</span>
<span id="cb34-19"><a href="#cb34-19"></a>        old_log_probs<span class="op">=</span>old_log_probs,</span>
<span id="cb34-20"><a href="#cb34-20"></a>        cliprange<span class="op">=</span>cliprange,</span>
<span id="cb34-21"><a href="#cb34-21"></a>    )</span>
<span id="cb34-22"><a href="#cb34-22"></a></span>
<span id="cb34-23"><a href="#cb34-23"></a>    masked_loss <span class="op">=</span> masked_mean(</span>
<span id="cb34-24"><a href="#cb34-24"></a>        tensor<span class="op">=</span>loss,</span>
<span id="cb34-25"><a href="#cb34-25"></a>        mask<span class="op">=</span>response_mask,</span>
<span id="cb34-26"><a href="#cb34-26"></a>        dim<span class="op">=-</span><span class="dv">1</span>,</span>
<span id="cb34-27"><a href="#cb34-27"></a>    )</span>
<span id="cb34-28"><a href="#cb34-28"></a></span>
<span id="cb34-29"><a href="#cb34-29"></a>    masked_loss <span class="op">=</span> masked_loss.mean()</span>
<span id="cb34-30"><a href="#cb34-30"></a>    masked_loss <span class="op">=</span> masked_loss <span class="op">/</span> gradient_accumulation_steps</span>
<span id="cb34-31"><a href="#cb34-31"></a>    masked_loss.backward()</span>
<span id="cb34-32"><a href="#cb34-32"></a></span>
<span id="cb34-33"><a href="#cb34-33"></a>    <span class="cf">return</span> masked_loss, metadata</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œ æˆ‘ä»¬è®¡ç®—äº†GRPOçš„Lossï¼Œ å…·ä½“æ¥è¯´ï¼Œ æˆ‘ä»¬ä¼šæ ¹æ®ä¼ å…¥çš„loss typeï¼Œ æ¥è®¡ç®—ä¸åŒç±»å‹çš„Lossï¼Œ ä¹‹åæˆ‘ä»¬ä¼šæ ¹æ®Response Maskæ¥Maskæ‰ä¸éœ€è¦çš„éƒ¨åˆ†ï¼Œ æœ€åæˆ‘ä»¬ä¼šè¿›è¡ŒBackwardã€‚</p>
<p>æœ€åï¼Œ åœ¨æ¯ä¸ªStepç»“æŸåï¼Œ æˆ‘ä»¬éœ€è¦æ›´æ–°Old Policyä¸ºå½“å‰çš„New Policyï¼Œ è¿™éƒ¨åˆ†ä»£ç ä¹Ÿå¾ˆç®€å•ï¼Œ ç›´æ¥èµ‹å€¼å³å¯.</p>
<div class="highlight">
<p>å…¶å®ç†Ÿæ‚‰äº† GRPO çš„ç®—æ³•ä¹‹åï¼Œåœ¨å›è¿‡å¤´çœ‹è¿™ä¸ªç®—æ³•å®ç°ï¼Œ ä½ ä¼šå‘ç°ï¼Œ GRPOçš„å®ç°å…¶å®å¹¶ä¸å¤æ‚ï¼Œ ä¸»è¦æ˜¯æŠŠä¹‹å‰SFTå’ŒEIçš„ä»£ç è¿›è¡Œäº†ä¸€äº›å¤ç”¨ï¼Œ ä»¥åŠå¢åŠ äº†ä¸€äº›æ–°çš„åŠŸèƒ½ï¼Œ æ¯”å¦‚è®¡ç®—Advantageï¼Œ ä»¥åŠè®¡ç®—ä¸åŒç±»å‹çš„Lossã€‚ åªè¦ç†è§£äº†è¿™äº›å…³é”®æ­¥éª¤ï¼Œ å®ç°èµ·æ¥å…¶å®å¹¶ä¸éš¾ã€‚</p>
</div>
<section id="grpo-experiment" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="grpo-experiment"><span class="header-section-number">5.1</span> GRPO Experiment</h2>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹GRPO çš„è®­ç»ƒç»“æœï¼š</p>
<div id="fig-grpo-exp" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-grpo-exp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-grpo-exp" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-grpo-gsm8k-accuracy" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-grpo-gsm8k-accuracy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/grpo-accureacy.png" class="img-fluid figure-img" data-ref-parent="fig-grpo-exp">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-grpo-gsm8k-accuracy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) GRPO Accuracy
</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-grpo-exp" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-grpo-gsm8k-entropy" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-grpo-gsm8k-entropy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/grpo-gsm8k-token-entropy.png" class="img-fluid figure-img" data-ref-parent="fig-grpo-exp">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-grpo-gsm8k-entropy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) GSM8K Token Entropy
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-grpo-exp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Result of GRPO on Qwen2.5-Math-1.5B on GSM8K Dataset
</figcaption>
</figure>
</div>
</section>
<section id="other-experiments" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="other-experiments"><span class="header-section-number">5.2</span> Other Experiments</h2>
<p>åœ¨Assignmentä¸­ï¼Œ æˆ‘è¿˜å®ç°äº†ä¸€äº›å…¶ä»–çš„å®éªŒï¼Œ æ¯”å¦‚ä¸åŒçš„Reward Functionï¼Œ ä¸åŒçš„Loss Typeï¼Œ ä»¥åŠä¸åŒçš„Group Sizeã€‚ç”±äºæ—¶é—´çš„å…³ç³»ï¼Œæˆ‘å¹¶æ²¡æœ‰åšè¿™äº›å®éªŒï¼Œä¸è¿‡åœ¨ä»£ç ä¸­ï¼Œå¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°è¿™äº›å®éªŒã€‚</p>
<section id="learning-rate-tuning" class="level3" data-number="5.2.1">
<h3 data-number="5.2.1" class="anchored" data-anchor-id="learning-rate-tuning"><span class="header-section-number">5.2.1</span> Learning Rate Tuning</h3>
<p>é¦–å…ˆç¬¬ä¸€ä¸ªå®éªŒå°±æ˜¯å­¦ä¹ ç‡çš„è°ƒèŠ‚ï¼Œ ç”±äºGRPOçš„è®­ç»ƒæ¯”è¾ƒä¸ç¨³å®šï¼Œ å› æ­¤å­¦ä¹ ç‡çš„é€‰æ‹©éå¸¸é‡è¦ã€‚ æˆ‘å°è¯•äº†ä¸åŒçš„å­¦ä¹ ç‡ï¼Œ å‘ç°0.0001æ˜¯ä¸€ä¸ªæ¯”è¾ƒåˆé€‚çš„é€‰æ‹©ï¼Œ è¿‡é«˜çš„å­¦ä¹ ç‡ä¼šå¯¼è‡´è®­ç»ƒä¸ç¨³å®šï¼Œ è¿‡ä½çš„å­¦ä¹ ç‡ä¼šå¯¼è‡´è®­ç»ƒæ”¶æ•›æ…¢ã€‚</p>
</section>
<section id="effect-of-baseline" class="level3" data-number="5.2.2">
<h3 data-number="5.2.2" class="anchored" data-anchor-id="effect-of-baseline"><span class="header-section-number">5.2.2</span> Effect of Baseline</h3>
<p>Baselineçš„ä½œç”¨æ˜¯å‡å°‘è®­ç»ƒçš„æ–¹å·®ï¼Œ å› æ­¤æˆ‘å°è¯•äº†ä¸åŒçš„Baselineï¼Œ å‘ç°ä½¿ç”¨Baselineå¯ä»¥æ˜¾è‘—æå‡è®­ç»ƒçš„ç¨³å®šæ€§ï¼Œ å¹¶ä¸”å¯ä»¥æå‡æ¨¡å‹çš„æ€§èƒ½ã€‚</p>
</section>
<section id="length-normalization" class="level3" data-number="5.2.3">
<h3 data-number="5.2.3" class="anchored" data-anchor-id="length-normalization"><span class="header-section-number">5.2.3</span> Length Normalization</h3>
<p>åœ¨è®¡ç®—Log Probsçš„æ—¶å€™ï¼Œæ ¹æ®ä¸åŒçš„Length Normalizationæ–¹å¼ï¼Œ ä¹Ÿä¼šå¯¹è®­ç»ƒäº§ç”Ÿå½±å“ã€‚ æˆ‘å°è¯•äº†ä¸åŒçš„Normalizationæ–¹å¼ï¼Œ å‘ç°ä½¿ç”¨Token Level Normalizationå¯ä»¥æå‡æ¨¡å‹çš„æ€§èƒ½ã€‚</p>
</section>
<section id="normalization-with-group-std" class="level3" data-number="5.2.4">
<h3 data-number="5.2.4" class="anchored" data-anchor-id="normalization-with-group-std"><span class="header-section-number">5.2.4</span> Normalization with group std</h3>
<p>åœ¨è®¡ç®—Advantageçš„æ—¶å€™ï¼Œ æˆ‘å°è¯•äº†æ˜¯å¦ä½¿ç”¨Group Stdæ¥è¿›è¡ŒNormalizationï¼Œ</p>
</section>
<section id="off-policy-vs.-on-policy" class="level3" data-number="5.2.5">
<h3 data-number="5.2.5" class="anchored" data-anchor-id="off-policy-vs.-on-policy"><span class="header-section-number">5.2.5</span> Off-Policy vs.&nbsp;On-Policy</h3>
<p>è¦æƒ³æŠŠGRPO è®­ç»ƒå¥½ï¼Œ è¿˜æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„ç‚¹å°±æ˜¯Off-Policy å’Œ On-Policyçš„é€‰æ‹©ã€‚ åœ¨GRPOä¸­ï¼Œ æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯On-Policyçš„æ–¹å¼ï¼Œ ä¹Ÿå°±æ˜¯ä½¿ç”¨Old Policyæ¥é‡‡æ ·æ•°æ®ï¼Œ ç„¶åä½¿ç”¨New Policyæ¥è¿›è¡Œä¼˜åŒ–ã€‚ è¿™ç§æ–¹å¼å¯ä»¥æå‡è®­ç»ƒçš„ç¨³å®šæ€§ï¼Œ å¹¶ä¸”å¯ä»¥æå‡æ¨¡å‹çš„æ€§èƒ½ã€‚è¦æƒ³æŠŠå®ƒæ”¹æˆOff-Policyä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œ ä½†æ˜¯éœ€è¦æ³¨æ„ä¸€äº›ç»†èŠ‚ï¼Œ æ¯”å¦‚Importance Samplingç­‰ã€‚</p>
</section>
<section id="off-policy-clipping" class="level3" data-number="5.2.6">
<h3 data-number="5.2.6" class="anchored" data-anchor-id="off-policy-clipping"><span class="header-section-number">5.2.6</span> Off Policy Clipping</h3>
</section>
<section id="different-prompts" class="level3" data-number="5.2.7">
<h3 data-number="5.2.7" class="anchored" data-anchor-id="different-prompts"><span class="header-section-number">5.2.7</span> Different Prompts</h3>
<p>å½“ç„¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å°è¯•ä¸åŒçš„Promptsï¼Œ ä»¥ä¾¿æå‡æ¨¡å‹çš„æ€§èƒ½ã€‚ ä¸åŒçš„Promptä¼šå¯¹æ¨¡å‹çš„æ€§èƒ½äº§ç”Ÿå½±å“ï¼Œ å› æ­¤é€‰æ‹©åˆé€‚çš„Promptä¹Ÿæ˜¯å¾ˆé‡è¦çš„ã€‚å½“Promptsæ”¹å˜æ—¶ï¼Œå¯¹åº”çš„Reward Functionä¹Ÿéœ€è¦ç›¸åº”çš„è°ƒæ•´ï¼Œ ä»¥ä¾¿æ›´å¥½çš„é€‚åº”æ–°çš„Promptã€‚</p>
</section>
</section>
</section>
<section id="dpo" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> DPO</h1>
<p>è¿™ä¸ªéƒ¨åˆ†ï¼Œæ˜¯Assignment05 çš„è¡¥å……å†…å®¹ï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯äº†è§£DPOç®—æ³•çš„åŸºæœ¬æ€æƒ³å’Œå®ç°æ–¹å¼ã€‚ ç”±äºæ—¶é—´çš„å…³ç³»ï¼Œ æˆ‘å¹¶æ²¡æœ‰å®ç°DPOçš„å®Œæ•´ä»£ç ï¼Œ ä½†æ˜¯æˆ‘ä¼šä»‹ç»DPOçš„åŸºæœ¬æ€æƒ³å’Œå®ç°æ–¹å¼ã€‚DPOçš„ç®—æ³•å¦‚ä¸‹ï¼š</p>
<div id="algo-ei" class="pseudocode-container quarto-float" data-pseudocode-number="4" data-caption-prefix="Algorithm" data-line-number="true" data-comment-delimiter="#" data-line-number-punc=":" data-no-end="false" data-indent-size="1.2em">
<div class="pseudocode">
\begin{algorithm} \caption{Direct Preference Optimization (DPO)} \begin{algorithmic} \Require Initial policy model $\pi_{\theta_{\text{init}}}$ \Require Reference policy $\pi_{\text{ref}}$ (e.g., SFT model; fixed) \Require Preference dataset $\mathcal{D}=\{(x, y^{+}, y^{-})\}$ \Require Inverse temperature $\beta &gt; 0$ \Require Number of DPO steps $n_{\text{dpo\_steps}}$ \State $\pi_{\theta} \gets \pi_{\theta_{\text{init}}}$ \For{$\text{step} = 1$ \textbf{to} $n_{\text{dpo\_steps}}$} \State Sample a minibatch $\mathcal{B} \subset \mathcal{D}$ of triples $(x, y^{+}, y^{-})$ \For{\textbf{each} $(x, y^{+}, y^{-}) \in \mathcal{B}$} \State Compute log-likelihood ratios vs reference: \State $s^{+} \gets \log \pi_{\theta}(y^{+}\mid x) - \log \pi_{\text{ref}}(y^{+}\mid x)$ \State $s^{-} \gets \log \pi_{\theta}(y^{-}\mid x) - \log \pi_{\text{ref}}(y^{-}\mid x)$ \State Compute preference margin: \State $\Delta \gets \beta \, (s^{+} - s^{-})$ \State Compute DPO loss: \State $\ell \gets -\log \sigma(\Delta)$ \Comment{$\sigma(\cdot)$ is the logistic sigmoid} \EndFor \State Update $\theta$ by minimizing mean loss: \State $\theta \gets \theta - \eta \nabla_{\theta}\left(\frac{1}{|\mathcal{B}|}\sum_{(x,y^+,y^-)\in\mathcal{B}} \ell\right)$ \EndFor \State \Return $\pi_{\theta}$ \end{algorithmic} \end{algorithm}
</div>
</div>


</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/yyzhang2025\.github\.io\/LearningNotes");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark_dimmed">
<script>
  function loadGiscus() {
    // Function to get the theme based on body class
    const getTheme = () => {
      let baseTheme = document.getElementById('giscus-base-theme').value;
      let altTheme = document.getElementById('giscus-alt-theme').value;
      if (authorPrefersDark) {
          [baseTheme, altTheme] = [altTheme, baseTheme];
      }
      return document.body.classList.contains('quarto-dark') ? altTheme : baseTheme;
    };
    const script = document.createElement("script");
    script.src = "https://giscus.app/client.js";
    script.async = true;
    script.dataset.repo = "YYZhang2025/YYZhang2025.github.io";
    script.dataset.repoId = "R_kgDOQlDTcQ";
    script.dataset.category = "General";
    script.dataset.categoryId = "DIC_kwDOQlDTcc4C2MRz";
    script.dataset.mapping = "title";
    script.dataset.reactionsEnabled = "1";
    script.dataset.emitMetadata = "0";
    script.dataset.inputPosition = "top";
    script.dataset.theme = getTheme();
    script.dataset.lang = "en";
    script.crossOrigin = "anonymous";
    // Append the script to the desired div instead of at the end of the body
    document.getElementById("quarto-content").appendChild(script);
  }
  loadGiscus();
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../../posts/CS336/Ass02/ass02.html" class="pagination-link" aria-label="Assignment 02: Flash Attention &amp; Parallelism">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Assignment 02: Flash Attention &amp; Parallelism</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../../posts/DLFaC/index.html" class="pagination-link" aria-label="About this book">
        <span class="nav-page-text">About this book</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Â© CC-By Yuyang, 2025</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>This page is built with â¤ï¸ and <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>
    <script type="text/javascript">
    (function(d) {
      d.querySelectorAll(".pseudocode-container").forEach(function(el) {
        let pseudocodeOptions = {
          indentSize: el.dataset.indentSize,
          commentDelimiter: el.dataset.commentDelimiter,
          lineNumber: el.dataset.lineNumber.toLowerCase() === "true",
          lineNumberPunc: el.dataset.lineNumberPunc,
          noEnd: el.dataset.noEnd.toLowerCase() === "true",
          titlePrefix: el.dataset.captionPrefix
        };
        pseudocode.renderElement(el.querySelector(".pseudocode"), pseudocodeOptions);
      });
    })(document);
    (function(d) {
      d.querySelectorAll(".pseudocode-container").forEach(function(el) {
        let captionSpan = el.querySelector(".ps-root > .ps-algorithm > .ps-line > .ps-keyword")
        if (captionSpan !== null) {
          let captionPrefix = el.dataset.captionPrefix + " ";
          let captionNumber = "";
          if (el.dataset.pseudocodeNumber) {
            captionNumber = el.dataset.pseudocodeNumber + " ";
            if (el.dataset.chapterLevel) {
              captionNumber = el.dataset.chapterLevel + "." + captionNumber;
            }
          }
          captionSpan.innerHTML = captionPrefix + captionNumber;
        }
      });
    })(document);
    </script>
  




<script src="../../../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.js" defer="true"></script>
</body></html>