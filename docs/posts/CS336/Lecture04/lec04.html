<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Lecture 04 ä»‹ç»äº† MoEï¼ˆMixture of Expertsï¼‰çš„åŸºæœ¬æ¦‚å¿µå’ŒåŸç†ã€‚ä»æ¨¡å‹æ¶æ„ã€è·¯ç”±æœºåˆ¶ã€è®­ç»ƒæ–¹æ³•ç­‰æ–¹é¢è¿›è¡Œäº†è¯¦ç»†è®²è§£ï¼Œå¹¶è®¨è®ºäº† MoE åœ¨è‡ªç„¶è¯­è¨€å¤„ç†ä¸­çš„åº”ç”¨å’Œä¼˜åŠ¿ã€‚">

<title>Lecture 04: Introduction to MoE â€“ Learning Note</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../posts/CS336/Lecture05&amp;06/lec05.html" rel="next">
<link href="../../../posts/CS336/Lecture03/lec03.html" rel="prev">
<script src="../../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-234273d1456647dabc34a594ac50e507.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dark-0348920b7671f696dc9078d39bff215e.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-234273d1456647dabc34a594ac50e507.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-d955a6f9d49e1ec5ed65a13bb8102cd7.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../../site_libs/bootstrap/bootstrap-dark-54ea7a8788961299870a163422834ed2.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../../../site_libs/bootstrap/bootstrap-d955a6f9d49e1ec5ed65a13bb8102cd7.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<link href="../../../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.css" rel="stylesheet">
<script src="../../../site_libs/quarto-contrib/pseudocode-2.4.1/pseudocode.min.js"></script>
<link href="../../../site_libs/quarto-contrib/pseudocode-2.4.1/pseudocode.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="https://fonts.cdnfonts.com/css/cmu-sans-serif" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
<script>
    MathJax = {
        loader: {
        load: ['[tex]/boldsymbol']
        },
        tex: {
        tags: "all",
        inlineMath: [['$','$'], ['\\(','\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']],
        processEscapes: true,
        processEnvironments: true,
        packages: {
            '[+]': ['boldsymbol']
        }
        }
    };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll(".foldable-header").forEach(header => {
    header.addEventListener("click", () => {
      const block = header.closest(".foldable");
      if (block) {
        block.classList.toggle("is-open");
      }
    });

    // å¯è®¿é—®æ€§ï¼ˆé”®ç›˜ï¼‰
    header.setAttribute("tabindex", "0");
    header.addEventListener("keydown", e => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        header.click();
      }
    });
  });
});
</script>
    <style type="text/css">
    .ps-root .ps-algorithm {
      border-top: 2px solid;
      border-bottom: 2px solid;
    }
    .pseudocode-container {
      text-align: left;
    }
    </style>
  
      <style type="text/css">
      .ps-algorithm > .ps-line {
        text-align: left;
      }
      </style>
    

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar docked quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../../posts/CS336/index.html">ğŸ“ Stanford CS336: LLM from Scratch</a></li><li class="breadcrumb-item"><a href="../../../posts/CS336/Lecture04/lec04.html">Lecture 04: MoE Architecture</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header">
      <a href="../../../index.html" class="sidebar-logo-link">
      <img src="../../.././style/logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/YYZhang2025" title="GitHub organization" class="quarto-navigation-tool px-1" aria-label="GitHub organization"><i class="bi bi-github"></i></a>
    <a href="https://www.linkedin.com/in/zhang-yuyang/" title="LinkedIn" class="quarto-navigation-tool px-1" aria-label="LinkedIn"><i class="bi bi-linkedin"></i></a>
    <a href="https://yyzhang2025.github.io/posts/Blogs/blogs_index.html" title="Personal Blogs" class="quarto-navigation-tool px-1" aria-label="Personal Blogs"><i class="bi bi-globe"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false">
 <span class="menu-text">ğŸ“ 100 AI Papers with Code</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/100-AI-Papers/100_Papers_index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About this series</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/100-AI-Papers/01-transformer/Transformer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Transformer</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/100-AI-Papers/02-vision-transformer/Vision-Transformer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Vision Transformer</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">ğŸ“ Stanford CS336: LLM from Scratch</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About this course</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture01/lec01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 01: Introduction &amp; BPE</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture02/lec02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 02: PyTorch Basics &amp; Resource Accounts</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture03/lec03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 03: Transformer LM Architecture</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture04/lec04.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Lecture 04: MoE Architecture</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture05&amp;06/lec05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 05&amp;06: GPU Optimization, Triton &amp; FlashAttention</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture07&amp;08/lec07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 07&amp;08: Parallelism</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture9&amp;11/lec9.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 09&amp;11: Scaling Laws</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture10/lec10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 10: Inference &amp; Deployment</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture12/lec12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 12: Evaluation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture13&amp;14/lec13.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 13&amp;14: Data Collection &amp; Processing</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture15/lec15.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 15: LLM Alignment SFT &amp; RLHF(PPO, DPO)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture16&amp;17/lec16.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 16 &amp; 17: LLM Alignment SFT &amp; RLVR(GRPO)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Ass01/ass01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Assignment 01: BPE Tokenizer &amp; Transformer LM</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Ass02/ass02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Assignment 02: Flash Attention &amp; Parallelism</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Ass05/ass05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Assignment 05: SFT &amp; GRPO</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false">
 <span class="menu-text">ğŸ“– Deep Learning Foundation &amp; Concepts</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/DLFaC/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About this book</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#what-is-mixture-of-experts-moe" id="toc-what-is-mixture-of-experts-moe" class="nav-link active" data-scroll-target="#what-is-mixture-of-experts-moe"><span class="header-section-number">1</span> What is Mixture of Experts (MoE)?</a></li>
  <li><a href="#moe-architecture" id="toc-moe-architecture" class="nav-link" data-scroll-target="#moe-architecture"><span class="header-section-number">2</span> MoE Architecture</a>
  <ul>
  <li><a href="#routing-function" id="toc-routing-function" class="nav-link" data-scroll-target="#routing-function"><span class="header-section-number">2.1</span> Routing Function</a>
  <ul>
  <li><a href="#token-choice-router" id="toc-token-choice-router" class="nav-link" data-scroll-target="#token-choice-router"><span class="header-section-number">2.1.1</span> Token-choice Router</a>
  <ul class="collapse">
  <li><a href="#top-k-gating" id="toc-top-k-gating" class="nav-link" data-scroll-target="#top-k-gating"><span class="header-section-number">2.1.1.1</span> Top-K Gating</a></li>
  <li><a href="#top-k-variants" id="toc-top-k-variants" class="nav-link" data-scroll-target="#top-k-variants"><span class="header-section-number">2.1.1.2</span> Top-K Variants</a></li>
  <li><a href="#choice-of-k" id="toc-choice-of-k" class="nav-link" data-scroll-target="#choice-of-k"><span class="header-section-number">2.1.1.3</span> Choice of K</a></li>
  <li><a href="#is-top-k-gating-optimal" id="toc-is-top-k-gating-optimal" class="nav-link" data-scroll-target="#is-top-k-gating-optimal"><span class="header-section-number">2.1.1.4</span> Is Top-K Gating Optimal?</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#experts" id="toc-experts" class="nav-link" data-scroll-target="#experts"><span class="header-section-number">2.2</span> Experts</a></li>
  <li><a href="#training-objectives" id="toc-training-objectives" class="nav-link" data-scroll-target="#training-objectives"><span class="header-section-number">2.3</span> Training Objectives</a>
  <ul>
  <li><a href="#the-challenge-of-moe-training" id="toc-the-challenge-of-moe-training" class="nav-link" data-scroll-target="#the-challenge-of-moe-training"><span class="header-section-number">2.3.1</span> The Challenge of MoE Training</a>
  <ul class="collapse">
  <li><a href="#rl-based-optimization" id="toc-rl-based-optimization" class="nav-link" data-scroll-target="#rl-based-optimization"><span class="header-section-number">2.3.1.1</span> RL Based Optimization</a></li>
  <li><a href="#stochastic-approximation" id="toc-stochastic-approximation" class="nav-link" data-scroll-target="#stochastic-approximation"><span class="header-section-number">2.3.1.2</span> Stochastic Approximation</a>
  <ul class="collapse">
  <li><a href="#stochastic-jittering" id="toc-stochastic-jittering" class="nav-link" data-scroll-target="#stochastic-jittering"><span class="header-section-number">2.3.1.2.1</span> Stochastic Jittering</a></li>
  </ul></li>
  <li><a href="#auxiliary-heuristic-balancing-losses" id="toc-auxiliary-heuristic-balancing-losses" class="nav-link" data-scroll-target="#auxiliary-heuristic-balancing-losses"><span class="header-section-number">2.3.1.3</span> Auxiliary / Heuristic Balancing Losses</a>
  <ul class="collapse">
  <li><a href="#load-balancing-loss" id="toc-load-balancing-loss" class="nav-link" data-scroll-target="#load-balancing-loss"><span class="header-section-number">2.3.1.3.1</span> Load Balancing Loss</a></li>
  <li><a href="#z-loss" id="toc-z-loss" class="nav-link" data-scroll-target="#z-loss"><span class="header-section-number">2.3.1.3.2</span> Z-Loss</a></li>
  </ul></li>
  <li><a href="#loss-combination" id="toc-loss-combination" class="nav-link" data-scroll-target="#loss-combination"><span class="header-section-number">2.3.1.4</span> Loss Combination</a></li>
  </ul></li>
  <li><a href="#system-side" id="toc-system-side" class="nav-link" data-scroll-target="#system-side"><span class="header-section-number">2.3.2</span> System Side</a></li>
  <li><a href="#fine-tuning-moe" id="toc-fine-tuning-moe" class="nav-link" data-scroll-target="#fine-tuning-moe"><span class="header-section-number">2.3.3</span> Fine-tuning MoE</a></li>
  <li><a href="#upcycling" id="toc-upcycling" class="nav-link" data-scroll-target="#upcycling"><span class="header-section-number">2.3.4</span> Upcycling</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#others" id="toc-others" class="nav-link" data-scroll-target="#others"><span class="header-section-number">3</span> Others</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">4</span> Summary</a></li>
  <li><a href="#in-the-end" id="toc-in-the-end" class="nav-link" data-scroll-target="#in-the-end"><span class="header-section-number">5</span> In the End</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../../posts/CS336/index.html">ğŸ“ Stanford CS336: LLM from Scratch</a></li><li class="breadcrumb-item"><a href="../../../posts/CS336/Lecture04/lec04.html">Lecture 04: MoE Architecture</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Lecture 04: Introduction to MoE</h1>
</div>

<div>
  <div class="description">
    Lecture 04 ä»‹ç»äº† MoEï¼ˆMixture of Expertsï¼‰çš„åŸºæœ¬æ¦‚å¿µå’ŒåŸç†ã€‚ä»æ¨¡å‹æ¶æ„ã€è·¯ç”±æœºåˆ¶ã€è®­ç»ƒæ–¹æ³•ç­‰æ–¹é¢è¿›è¡Œäº†è¯¦ç»†è®²è§£ï¼Œå¹¶è®¨è®ºäº† MoE åœ¨è‡ªç„¶è¯­è¨€å¤„ç†ä¸­çš„åº”ç”¨å’Œä¼˜åŠ¿ã€‚
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>éšç€2025å¹´æ˜¥èŠ‚DeepSeek-R1 çš„å‘å¸ƒï¼ŒMixture of Experts (MoE) æ¨¡å‹åœ¨è‡ªç„¶è¯­è¨€å¤„ç†é¢†åŸŸé‡æ–°å¼•èµ·äº†å¹¿æ³›å…³æ³¨ã€‚è¿™èŠ‚è¯¾æˆ‘ä»¬å°†ä¼šå­¦ä¹ ä»€ä¹ˆçš„MoE Layerã€‚å®ƒçš„åŸºæœ¬åŸç†æ˜¯ä»€ä¹ˆï¼Ÿå®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿä»¥åŠå®ƒä¸ºä»€ä¹ˆèƒ½å¤Ÿæå‡æ¨¡å‹çš„æ€§èƒ½ã€‚</p>
<div class="callout callout-style-default callout-important callout-titled" title="MoE ä»£ç å®ç°">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
MoE ä»£ç å®ç°
</div>
</div>
<div class="callout-body-container callout-body">
<p>åœ¨Assignment01ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†FFN Layerã€‚ä½†æ˜¯ä½œä¸šä¸­å¹¶æ²¡æœ‰è¦æ±‚å¤§å®¶å®ç°MoE Layerã€‚ä¸ºäº†å¸®åŠ©å¤§å®¶æ›´å¥½åœ°ç†è§£MoE Layerçš„å®ç°ç»†èŠ‚ï¼Œä¹Ÿä½œä¸ºå¤§å®¶å…³æ³¨æˆ‘çš„Bonusï¼Œæˆ‘åœ¨Assignment01çš„ä»£ç åº“ä¸­æ·»åŠ äº†MoE Layerçš„å®ç°ä»£ç ã€‚å¤§å®¶å¯ä»¥å‚è€ƒä»¥ä¸‹<a href="https://github.com/YYZhang2025/Stanford-CS336/blob/main/assignment1-basics/cs336_basics/modules/moe.py">é“¾æ¥</a>æŸ¥çœ‹ä»£ç å®ç°ã€‚</p>
</div>
</div>
<p>æˆ‘ä»¬é¦–å…ˆæ¥äº†è§£ä¸€ä¸‹ï¼Œä»€ä¹ˆæ˜¯Mixture of Experts (MoE) æ¨¡å‹ï¼Œå¹¶ä¸”ä¸ºä»€ä¹ˆå®ƒå—åˆ°äº†å¦‚æ­¤å¤šçš„å…³æ³¨ã€‚</p>
<section id="what-is-mixture-of-experts-moe" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> What is Mixture of Experts (MoE)?</h1>
<p>è¿‡å»å‡ å¹´ï¼Œå¤§æ¨¡å‹çš„ä¸»æµè·¯çº¿å‡ ä¹åªæœ‰ä¸€æ¡ï¼šæŠŠ Transformer åšå¾—æ›´å¤§ã€æ›´æ·±ã€æ›´å®½ï¼Œç„¶åç”¨æ›´å¤šæ•°æ®ä¸æ›´å¤šç®—åŠ›å †ä¸Šå»ã€‚Mixture of Expertsï¼ˆMoEï¼‰çš„å‡ºç°ï¼Œç»™è¿™æ¡è·¯çº¿å¢åŠ äº†ä¸€ä¸ªéå¸¸â€œå·¥ç¨‹å‘³â€çš„åˆ†æ”¯ï¼šåœ¨ä¸æ˜¾è‘—å¢åŠ æ¯ä¸€æ­¥è®¡ç®—é‡ï¼ˆFLOPsï¼‰çš„å‰æä¸‹ï¼ŒæŠŠæ¨¡å‹çš„å‚æ•°å®¹é‡åšå¾—æ›´å¤§ã€‚</p>
<div class="callout callout-style-default callout-note callout-titled" title="what is expert?">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
what is expert?
</div>
</div>
<div class="callout-body-container callout-body">
<p>åœ¨è¿™é‡Œéœ€è¦æä¸€ç‚¹çš„æ˜¯ï¼ŒMoEä¸­çš„â€œä¸“å®¶â€ï¼ˆExpertï¼‰æŒ‡çš„æ˜¯æ¨¡å‹ä¸­çš„ä¸€ä¸ªå­ç½‘ç»œï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç¥ç»ç½‘ç»œå±‚æˆ–æ¨¡å—ã€‚è€Œå¹¶ä¸æ˜¯æ¨¡å‹é‡ŒçœŸçš„å­˜åœ¨â€œä»£ç ä¸“å®¶ / è‹±è¯­ä¸“å®¶ / æ•°å­¦ä¸“å®¶â€ã€‚</p>
</div>
</div>
<p>å¦‚æœä½ æŠŠå¤§æ¨¡å‹è®­ç»ƒç†è§£ä¸ºâ€œåœ¨å›ºå®šé¢„ç®—ä¸‹æ¢å–æœ€å¼ºæ•ˆæœâ€ï¼Œé‚£ MoE ä¹‹æ‰€ä»¥å¼•å‘å…³æ³¨ï¼Œæ ¸å¿ƒå°±ä¸€å¥è¯ï¼š</p>
<div class="callout-tldr">
<p>åŒæ ·çš„è®­ç»ƒ/æ¨ç† FLOPsï¼ŒMoE å¾€å¾€èƒ½ç»™ä½ æ›´ä½çš„ lossã€æ›´å¥½çš„ perplexityã€æ›´å¥½çš„ä¸‹æ¸¸è¡¨ç°â€”â€”åªè¦ä½ èƒ½æŠŠå®ƒè®­ç»ƒç¨³ã€è·‘å¾—å¿«ã€‚</p>
</div>
<p>è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆ MoE åœ¨ 2024â€“2025 è¿…é€Ÿä»â€œç ”ç©¶åœˆçš„æŠ€å·§â€å˜æˆâ€œå·¥ä¸šç•Œçš„é»˜è®¤é€‰é¡¹â€ä¹‹ä¸€.</p>
<p>å…¶å®MoEçš„æ¦‚å¿µå¹¶ä¸æ–°é²œï¼Œæ¯”å¦‚ Switch Transformer <span class="citation" data-cites="SwitchTransformersScaling2022fedus">(<a href="#ref-SwitchTransformersScaling2022fedus" role="doc-biblioref">Fedus, Zoph, and Shazeer 2022</a>)</span> æ—©åœ¨2021å¹´å°±æå‡ºï¼Œå¹¶ä¸”æ”¹è¿›äº†MoEçš„è®­ç»ƒç¨³å®šã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹MoEçš„åŸºæœ¬ç»“æ„ã€‚</p>
<div id="fig-dense-fnn-vs-moe" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dense-fnn-vs-moe-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/dense-fnn-vs-moe.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dense-fnn-vs-moe-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Dense FFN Layer ä¸ MoE Layeræ¯”è¾ƒã€‚å·¦ä¾§æ˜¯ä¼ ç»Ÿçš„Dense FFN Layerï¼Œå³ä¾§æ˜¯MoE Layerã€‚MoE Layerç”±å¤šä¸ªä¸“å®¶ç½‘ç»œï¼ˆExpertsï¼‰ç»„æˆï¼Œæ¯ä¸ªä¸“å®¶ç½‘ç»œéƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„FFN Layerã€‚
</figcaption>
</figure>
</div>
<p>ä» <a href="#fig-dense-fnn-vs-moe" class="quarto-xref">Figure&nbsp;1</a> ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ¯ä¸ªtokenè¢«é€å…¥å…¶ä¸­ä¸€ä¸ªä¸“å®¶ç½‘ç»œï¼ˆExpertï¼‰è¿›è¡Œå¤„ç†ï¼Œè€Œä¸æ˜¯åƒä¼ ç»Ÿçš„FFN Layeré‚£æ ·ï¼Œæ‰€æœ‰tokenéƒ½ç»è¿‡åŒä¸€ä¸ªFFN Layerã€‚è¿™æ ·ä¸€æ¥ï¼ŒMoE Layerçš„å‚æ•°é‡å¯ä»¥å¤§å¹…å¢åŠ ï¼Œè€Œæ¯ä¸ªtokenå®é™…è®¡ç®—çš„FLOPså¹¶æ²¡æœ‰æ˜¾è‘—å¢åŠ ã€‚</p>
<p>åœ¨ç›¸ç­‰çš„FLOPsä¸‹ï¼Œå‚æ•°é‡çš„å¢åŠ ï¼Œå¾€å¾€èƒ½å¸¦æ¥æ¨¡å‹è¡¨è¾¾èƒ½åŠ›çš„æå‡ï¼Œä»è€Œæå‡æ¨¡å‹çš„æ€§èƒ½ã€‚è¿™ä¹Ÿæ˜¯MoEèƒ½å¤Ÿåœ¨ä¸æ˜¾è‘—å¢åŠ è®¡ç®—é‡çš„å‰æä¸‹ï¼Œæå‡æ¨¡å‹æ€§èƒ½çš„åŸå› ä¹‹ä¸€ã€‚</p>
<div id="fig-same-flop-more-params" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-same-flop-more-params-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/same_flop_more_params.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-same-flop-more-params-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œéšç€å‚æ•°é‡çš„å¢åŠ ï¼Œæ¨¡å‹çš„æ€§èƒ½ï¼ˆå¦‚perplexityï¼‰ä¹Ÿåœ¨æå‡ã€‚
</figcaption>
</figure>
</div>
<p>å¦å¤–ä¸€ä¸ªä¼˜ç‚¹å°±æ˜¯äº†ï¼Œ MoEæ‰€éœ€çš„è®­ç»ƒæ—¶é—´æ›´çŸ­ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåœ¨è¾¾åˆ°ç›¸åŒçš„perplexityæ°´å¹³ä¸‹ï¼ŒMoEæ¨¡å‹æ‰€éœ€çš„è®­ç»ƒæ—¶é—´æ˜æ˜¾å°‘äºDenseæ¨¡å‹ã€‚</p>
<div id="fig-faster-training" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-faster-training-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/faster-training.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-faster-training-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: ç›¸æ¯”äºT5(Dense)æ¨¡å‹ï¼ŒMoEæ¨¡å‹åœ¨è¾¾åˆ°ç›¸åŒperplexityæ°´å¹³ä¸‹ï¼Œæ‰€éœ€çš„è®­ç»ƒæ—¶é—´æ›´çŸ­ã€‚
</figcaption>
</figure>
</div>
<p>å¹¶ä¸”ï¼Œç”±äºMoEæœ‰ä¸åŒçš„Expertsï¼Œ å¹¶ä¸”æ¯ä¸ªExpertå¯ä»¥ç‹¬ç«‹è®­ç»ƒï¼Œè¿™ä½¿å¾—MoEæ¨¡å‹åœ¨åˆ†å¸ƒå¼è®­ç»ƒä¸­æ›´å…·ä¼˜åŠ¿ã€‚æˆ‘ä»¬å¯ä»¥å°†ä¸åŒçš„Expertsåˆ†é…åˆ°ä¸åŒçš„è®¡ç®—èŠ‚ç‚¹ä¸Šï¼Œä»è€Œæ›´å¥½åœ°åˆ©ç”¨åˆ†å¸ƒå¼è®¡ç®—èµ„æºï¼Œæé«˜è®­ç»ƒæ•ˆç‡ã€‚</p>
<div id="fig-dist-moe" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dist-moe-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/dist-moe.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dist-moe-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: æˆ‘å¯ä»¥å°†ä¸åŒçš„Expertsåˆ†é…åˆ°ä¸åŒçš„è®¡ç®—èŠ‚ç‚¹ä¸Šï¼Œå¹¶è¡Œè®¡ç®—ï¼Œä»è€Œæé«˜è®­ç»ƒæ•ˆç‡ã€‚
</figcaption>
</figure>
</div>
<p>ä½†æ˜¯ï¼Œæ—¢ç„¶MoEæœ‰è¿™ä¹ˆå¤šä¼˜ç‚¹ï¼Œä¸ºä»€ä¹ˆå®ƒä¸æ˜¯å¤§æ¨¡å‹çš„å”¯ä¸€é€‰æ‹©å‘¢ï¼Ÿè¿™å°±è¦æåˆ°MoEçš„å‡ ä¸ªæŒ‘æˆ˜äº†ã€‚</p>
<ol type="1">
<li><strong>è®­ç»ƒç¨³å®šæ€§</strong>ï¼šç”±äºMoEæ¨¡å‹ä¸­æœ‰å¤šä¸ªExpertsï¼Œå¦‚ä½•ç¡®ä¿æ¯ä¸ªExpertéƒ½èƒ½å¾—åˆ°è¶³å¤Ÿçš„è®­ç»ƒæ•°æ®æ˜¯ä¸€ä¸ªæŒ‘æˆ˜ã€‚å¦‚æœæŸäº›Expertså¾ˆå°‘è¢«é€‰æ‹©ï¼Œå¯èƒ½ä¼šå¯¼è‡´å®ƒä»¬æ— æ³•æœ‰æ•ˆå­¦ä¹ ï¼Œä»è€Œå½±å“æ•´ä½“æ¨¡å‹çš„æ€§èƒ½ã€‚</li>
<li><strong>è·¯ç”±æœºåˆ¶</strong>ï¼šMoEæ¨¡å‹éœ€è¦ä¸€ä¸ªè·¯ç”±æœºåˆ¶æ¥å†³å®šæ¯ä¸ªtokenåº”è¯¥é€å…¥å“ªä¸ªExpertã€‚è®¾è®¡ä¸€ä¸ªé«˜æ•ˆä¸”æœ‰æ•ˆçš„è·¯ç”±æœºåˆ¶æ˜¯MoEæ¨¡å‹çš„å…³é”®ä¹‹ä¸€ã€‚</li>
<li><strong>å®ç°å¤æ‚æ€§</strong>ï¼šMoEæ¨¡å‹çš„å®ç°ç›¸å¯¹äºä¼ ç»Ÿçš„Denseæ¨¡å‹æ›´ä¸ºå¤æ‚ï¼Œå°¤å…¶æ˜¯åœ¨åˆ†å¸ƒå¼è®­ç»ƒç¯å¢ƒä¸‹ï¼Œéœ€è¦å¤„ç†æ›´å¤šçš„é€šä¿¡å’ŒåŒæ­¥é—®é¢˜ã€‚</li>
</ol>
<p>æ­£æ˜¯ç”±äºè¿™äº›æŒ‘æˆ˜ï¼ŒMoEæ¨¡å‹åœ¨å®é™…åº”ç”¨ä¸­éœ€è¦æ›´å¤šçš„å·¥ç¨‹æŠ€å·§å’Œç»éªŒã€‚å› æ­¤ï¼Œè™½ç„¶MoEæœ‰å¾ˆå¤šæ½œåœ¨çš„ä¼˜åŠ¿ï¼Œä½†å®ƒå¹¶ä¸æ˜¯é€‚åˆæ‰€æœ‰åœºæ™¯çš„ä¸‡èƒ½è§£å†³æ–¹æ¡ˆã€‚</p>
<div class="callout-tldr">
<p>TL;DR</p>
<p>MoE ä¹‹æ‰€ä»¥ç«ï¼Œæ˜¯å› ä¸ºå®ƒæŠŠ Transformer é‡Œæœ€â€œè´µâ€çš„ FFN å˜æˆå¾ˆå¤šä¸ªä¸“å®¶ï¼Œä½†æ¯æ¬¡åªæ¿€æ´»å°‘æ•°å‡ ä¸ªï¼šåœ¨ FLOPs è¿‘ä¼¼ä¸å˜çš„æƒ…å†µä¸‹æ˜¾è‘—å¢åŠ å‚æ•°å®¹é‡ï¼Œé€šå¸¸èƒ½å¸¦æ¥æ›´å¥½çš„è®­ç»ƒ/æ¨ç†æ€§ä»·æ¯”ï¼›ä»£ä»·æ˜¯è®­ç»ƒç¨³å®šæ€§ä¸ç³»ç»Ÿå®ç°å¤æ‚åº¦ã€‚</p>
</div>
<p>äº†è§£äº†MoEçš„åŸºæœ¬æ¦‚å¿µï¼Œä¼˜ç‚¹å’ŒæŒ‘æˆ˜åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†æ·±å…¥æ¢è®¨MoEçš„å…·ä½“å®ç°ç»†èŠ‚ï¼ŒåŒ…æ‹¬è·¯ç”±æœºåˆ¶ã€è®­ç»ƒæ–¹æ³•ç­‰å†…å®¹ã€‚</p>
</section>
<section id="moe-architecture" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> MoE Architecture</h1>
<p>åœ¨ç¬¬ä¸€èŠ‚æˆ‘ä»¬æ„è§äº†è§£äº†MoEçš„åŸºæœ¬æ¦‚å¿µä»¥åŠåŸºæœ¬çš„æ¶æ„ <a href="#fig-dense-fnn-vs-moe" class="quarto-xref">Figure&nbsp;1</a>ï¼Œåœ¨è¿™ä¸€èŠ‚æˆ‘ä»¬å°†æ›´è¯¦ç»†åœ°ä»‹ç»MoEçš„æ¶æ„ç»„æˆéƒ¨åˆ†ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>Routing Functionï¼š å†³å®šæ¯ä¸ªtokenåº”è¯¥é€å…¥å“ªä¸ªExpertçš„å‡½æ•°ã€‚</li>
<li>Experts ï¼šå¤šä¸ªç‹¬ç«‹çš„FFN Layerï¼Œæ¯ä¸ªExpertè´Ÿè´£å¤„ç†ä¸€éƒ¨åˆ†tokenã€‚</li>
<li>Training Objectivesï¼šMoEæ¨¡å‹çš„è®­ç»ƒç›®æ ‡å’ŒæŸå¤±å‡½æ•°è®¾è®¡ã€‚</li>
</ul>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Routing Functionçš„è®¾è®¡ã€‚</p>
<section id="routing-function" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="routing-function"><span class="header-section-number">2.1</span> Routing Function</h2>
<p>MoE çš„æ ¸å¿ƒä¸æ˜¯â€œæœ‰å¾ˆå¤šä¸“å®¶â€ï¼Œè€Œæ˜¯æ¯ä¸ª token è¯¥å»å“ªäº›ä¸“å®¶ã€‚è¿™ä¸ªå†³ç­–ç”± <strong>Routerï¼ˆè·¯ç”±å™¨ï¼‰</strong>å®Œæˆã€‚æˆ‘ä»¬å¯ä»¥æŠŠå®ƒç†è§£æˆä¸€ä¸ªâ€œè½»é‡çš„åˆ†ç±»å™¨/æ‰“åˆ†å™¨â€ï¼šè¾“å…¥æ˜¯æ¯ä¸ª token çš„ hidden stateï¼Œè¾“å‡ºæ˜¯å¯¹æ‰€æœ‰ä¸“å®¶çš„åå¥½åˆ†æ•°ï¼Œç„¶åé€‰å‡º top-K ä¸ªä¸“å®¶æ‰§è¡Œã€‚æœ‰ä¸€ç‚¹å¾ˆé‡è¦çš„æ˜¯ï¼š</p>
<div class="callout-question">
<p>Router æ˜¯å…·æœ‰ä¸Šä¸‹æ–‡æ„ŸçŸ¥èƒ½åŠ›çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä¼šæ ¹æ® token çš„å†…å®¹åŠ¨æ€å†³å®šè·¯ç”±ç»“æœï¼Œä¹Ÿå°±æ˜¯è¯´åŒä¸€ä¸ª token åœ¨ä¸åŒè¯­å¢ƒä¸‹å¯ä»¥è¢«é€å»ä¸åŒä¸“å®¶ã€‚</p>
</div>
<p>Routerå®ç°å¤§æ¦‚æœ‰3ç§æ€è·¯ï¼š</p>
<ul>
<li>Token-choiceï¼ˆtoken é€‰ä¸“å®¶ï¼‰ï¼š æ¯ä¸ª token ç»™æ‰€æœ‰ä¸“å®¶æ‰“åˆ†ï¼Œé€‰æ‹© top-K ä¸“å®¶å¤„ç†å®ƒï¼ˆç°ä»£ä¸»æµï¼‰</li>
<li>Expert-choiceï¼ˆä¸“å®¶é€‰ tokenï¼‰ï¼š æ¯ä¸ªä¸“å®¶ä»ä¸€æ‰¹ token é‡ŒæŒ‘ top-K ä¸ªæ¥å¤„ç†ï¼ˆå¤©ç„¶æ›´å‡è¡¡ï¼‰</li>
<li>Global assignmentï¼ˆå…¨å±€åˆ†é…ï¼‰ï¼šæŠŠ tokenâ€“expert åŒ¹é…è§†ä½œä¼˜åŒ–é—®é¢˜ï¼ˆå¦‚çº¿æ€§åˆ†é…/æœ€ä¼˜ä¼ è¾“ï¼‰ï¼Œè¿½æ±‚æ›´å‡è¡¡æˆ–æ›´ä½é€šä¿¡æˆæœ¬</li>
</ul>
<div id="fig-router-choice" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-router-choice-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/router-choice.png.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-router-choice-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: ä¸åŒçš„Routerè®¾è®¡æ€è·¯æ¯”è¾ƒã€‚
</figcaption>
</figure>
</div>
<p>åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒToken-choice æ˜¯ç›®å‰æœ€ä¸»æµçš„è®¾è®¡æ€è·¯ï¼Œå› ä¸ºå®ƒå®ç°ç®€å•ä¸”æ˜“äºæ‰©å±•ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Token-choice Routerçš„å…·ä½“å®ç°ã€‚</p>
<section id="token-choice-router" class="level3" data-number="2.1.1">
<h3 data-number="2.1.1" class="anchored" data-anchor-id="token-choice-router"><span class="header-section-number">2.1.1</span> Token-choice Router</h3>
<p>Token-choice Router, é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯æ¯ä¸ª token ç»™æ‰€æœ‰ä¸“å®¶æ‰“åˆ†ï¼Œé€‰æ‹© top-K ä¸“å®¶å¤„ç†å®ƒã€‚å½“ç„¶ï¼Œè¿™ä¸ªâ€œæ‰“åˆ†â€è¿‡ç¨‹ï¼ˆRoutingï¼‰å¯ä»¥æœ‰å¾ˆå¤šç§å®ç°æ–¹å¼ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li>Top-K Gatingï¼šä½¿ç”¨ä¸€ä¸ªçº¿æ€§å±‚å¯¹ token çš„ hidden state è¿›è¡ŒæŠ•å½±ï¼Œå¾—åˆ°æ¯ä¸ªä¸“å®¶çš„åˆ†æ•°ï¼Œç„¶åé€‰æ‹© top-K ä¸ªä¸“å®¶ã€‚</li>
<li>Hashing-based Routingï¼šä½¿ç”¨å“ˆå¸Œå‡½æ•°å°† token æ˜ å°„åˆ°ä¸“å®¶ï¼Œä»è€Œå®ç°è·¯ç”±ï¼ˆé€šå¸¸ä½œä¸ºBaselineï¼‰ã€‚</li>
<li>RL to learn Routingï¼šä½¿ç”¨å¼ºåŒ–å­¦ä¹ æ–¹æ³•æ¥å­¦ä¹ è·¯ç”±ç­–ç•¥ã€‚</li>
<li>Solve a Optimization Problemï¼šå°†è·¯ç”±é—®é¢˜è§†ä½œä¸€ä¸ªä¼˜åŒ–é—®é¢˜ï¼Œé€šè¿‡æ±‚è§£è¯¥é—®é¢˜æ¥ç¡®å®šè·¯ç”±ç»“æœã€‚</li>
</ul>
<p>ä¸‹å›¾å±•ç¤ºäº†ä¸åŒçš„Token-choice Routerå®ç°æ–¹å¼ã€‚</p>
<div id="fig-token-choice-router" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-token-choice-router-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-token-choice-router" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-routing-topk" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-routing-topk-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/routing-topk.png" style="width:40.0%;height:40.0%" data-ref-parent="fig-token-choice-router" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-routing-topk-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Top-K routing choice
</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-token-choice-router" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-routing-hashing" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-routing-hashing-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/routing-hashing.png" style="width:40.0%;height:40.0%" data-ref-parent="fig-token-choice-router" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-routing-hashing-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Hashing-based routingï¼ˆé€šå¸¸ä½œä¸ºBaselineï¼‰
</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-token-choice-router" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-routing-rl" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-routing-rl-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/routing-rl.png" style="width:40.0%;height:40.0%" data-ref-parent="fig-token-choice-router" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-routing-rl-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) RL-Based Routing
</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-token-choice-router" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-routing-matching" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-routing-matching-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/routing-mathcing.png" style="width:40.0%;height:40.0%" data-ref-parent="fig-token-choice-router" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-routing-matching-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(d) Solve a Optimization Problem
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-token-choice-router-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6
</figcaption>
</figure>
</div>
<p>åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒTop-K Gating æ˜¯ç›®å‰æœ€å¸¸ç”¨çš„ Token-choice Router å®ç°æ–¹å¼ï¼Œå› ä¸ºå®ƒç®€å•ä¸”é«˜æ•ˆã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ Top-K Gating çš„å…·ä½“å®ç°ç»†èŠ‚ã€‚</p>
<section id="top-k-gating" class="level4" data-number="2.1.1.1">
<h4 data-number="2.1.1.1" class="anchored" data-anchor-id="top-k-gating"><span class="header-section-number">2.1.1.1</span> Top-K Gating</h4>
<p>Top-K Gating çš„å®ç°æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol type="1">
<li><strong>Score Calculation</strong>ï¼šå¯¹äºæ¯ä¸ª token çš„ hidden state <span class="math inline">\(h_i\)</span>ï¼Œé€šè¿‡ä¸€ä¸ªçº¿æ€§å±‚è®¡ç®—æ¯ä¸ªä¸“å®¶çš„åˆ†æ•°ï¼š <span id="eq-score-calculation"><span class="math display">\[
s_{i,j} = W_g h_i + b_g
\tag{1}\]</span></span> å…¶ä¸­ï¼Œ<span class="math inline">\(W_g\)</span> å’Œ <span class="math inline">\(b_g\)</span> æ˜¯è·¯ç”±å™¨çš„å‚æ•°ï¼Œ<span class="math inline">\(s_{i,j}\)</span> æ˜¯ token <span class="math inline">\(i\)</span> å¯¹ä¸“å®¶ <span class="math inline">\(j\)</span> çš„åˆ†æ•°ã€‚</li>
</ol>
<p>æœ‰äº†scoreä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦é€‰æ‹© top-K ä¸ªä¸“å®¶ï¼Œä¸è¿‡åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šå¯¹scoreè¿›è¡Œå½’ä¸€åŒ–å¤„ç†ï¼Œä»¥ä¾¿æ›´å¥½åœ°æ¯”è¾ƒä¸åŒä¸“å®¶çš„åˆ†æ•°ã€‚å¸¸ç”¨çš„æ–¹æ³•æ˜¯ä½¿ç”¨softmaxå‡½æ•°ï¼š <span id="eq-softmax"><span class="math display">\[
p_{i,j} = \frac{exp(s_{i,j})}{\sum_{k} exp(s_{i,k})}
\tag{2}\]</span></span> å…¶ä¸­ï¼Œ<span class="math inline">\(p_{i,j}\)</span> æ˜¯ token <span class="math inline">\(i\)</span> å¯¹ä¸“å®¶ <span class="math inline">\(j\)</span> çš„å½’ä¸€åŒ–åˆ†æ•°ã€‚</p>
<ol start="2" type="1">
<li><p><strong>Top-K Selection</strong>ï¼šå¯¹äºæ¯ä¸ª tokenï¼Œé€‰æ‹©åˆ†æ•°æœ€é«˜çš„ K ä¸ªä¸“å®¶ï¼š <span id="eq-topk-selection"><span class="math display">\[
g_{i, j} = \begin{cases}
s_{i, j}, \quad s_{i, j} \in \text{Top-K}(s_i) \\
0, \quad \text{otherwise}
\end{cases}
\tag{3}\]</span></span> å…¶ä¸­ï¼Œ<span class="math inline">\(g_{i,j}\)</span> æ˜¯ token <span class="math inline">\(i\)</span> å¯¹ä¸“å®¶ <span class="math inline">\(j\)</span> çš„é€‰æ‹©ç»“æœã€‚</p></li>
<li><p><strong>Passing to Experts</strong>ï¼šå°† token é€å…¥é€‰æ‹©çš„ä¸“å®¶è¿›è¡Œå¤„ç†ã€‚æ¯ä¸ªä¸“å®¶åªå¤„ç†è¢«é€‰ä¸­çš„ tokenï¼Œå…¶ä½™ token è¢«å¿½ç•¥ã€‚</p></li>
<li><p><strong>Combining Outputs</strong>ï¼šå°†ä¸“å®¶çš„è¾“å‡ºè¿›è¡Œåˆå¹¶ï¼Œå¾—åˆ°æœ€ç»ˆçš„ token è¡¨ç¤ºã€‚é€šå¸¸ä½¿ç”¨åŠ æƒå¹³å‡çš„æ–¹å¼ï¼š <span id="eq-combining-outputs"><span class="math display">\[
h_i' = \sum_{j} g_{i,j} \text{Expert}_j(h_i) + h_i
\tag{4}\]</span></span> å…¶ä¸­ï¼Œ<span class="math inline">\(h_i'\)</span> æ˜¯ token <span class="math inline">\(i\)</span> çš„æœ€ç»ˆè¡¨ç¤ºï¼Œ<span class="math inline">\(\text{Expert}_j(h_i)\)</span> æ˜¯ä¸“å®¶ <span class="math inline">\(j\)</span> å¯¹ token <span class="math inline">\(i\)</span> çš„å¤„ç†ç»“æœ, <span class="math inline">\(h_i\)</span> æ˜¯ token <span class="math inline">\(i\)</span> çš„åŸå§‹è¡¨ç¤º(Residual Connection), <span class="math inline">\(g_{i,j}\)</span> æ˜¯ token <span class="math inline">\(i\)</span> å¯¹ä¸“å®¶ <span class="math inline">\(j\)</span> çš„é€‰æ‹©ç»“æœã€‚</p></li>
</ol>
<p>é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼ŒTop-K Gating å®ç°äº†å¯¹ token çš„åŠ¨æ€è·¯ç”±ï¼Œä½¿å¾—æ¯ä¸ª token åªç»è¿‡å°‘æ•°å‡ ä¸ªä¸“å®¶ï¼Œä»è€Œå®ç°äº† MoE çš„é«˜æ•ˆè®¡ç®—ã€‚</p>
</section>
<section id="top-k-variants" class="level4" data-number="2.1.1.2">
<h4 data-number="2.1.1.2" class="anchored" data-anchor-id="top-k-variants"><span class="header-section-number">2.1.1.2</span> Top-K Variants</h4>
<p>åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒTop-K Gating æœ‰ä¸€äº›å˜ä½“ï¼Œå…¶ä¸­æ¯”è¾ƒå¸¸è§çš„æ˜¯DeepSeekæå‡ºçš„Top-Kå˜å½¢<span class="citation" data-cites="DeepSeekMoEUltimateExpert2024dai">(<a href="#ref-DeepSeekMoEUltimateExpert2024dai" role="doc-biblioref">Dai et al. 2024</a>)</span>, å®ƒæå‡ºï¼Œåœ¨é€‰æ‹©Top-Kä¸“å®¶çš„åŸºç¡€ä¸Šï¼Œæ¯ä¸ªtokenè¿˜ä¼šå›ºå®šä¼ å…¥ä¸€ä¸ªShared Expertã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œå¯ä»¥ç¡®ä¿æ¯ä¸ªtokenè‡³å°‘æœ‰ä¸€ä¸ªä¸“å®¶èƒ½å¤Ÿå¤„ç†å®ƒã€‚ å¹¶ä¸”Expertçš„å¤§å°å˜å°ï¼Œä½†æ˜¯æ•°é‡å˜å¤šï¼ˆfine-grained Expertsï¼‰ï¼Œä»è€Œæå‡æ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›ã€‚</p>
<div id="fig-deepseek-moe" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-deepseek-moe-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/deepseek-moe.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-deepseek-moe-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: DeepSeekæå‡ºçš„Top-Kå˜å½¢ï¼Œæ¯ä¸ªtokené™¤äº†é€‰æ‹©Top-Kä¸“å®¶å¤–ï¼Œè¿˜ä¼šå›ºå®šä¼ å…¥ä¸€ä¸ªShared Expertã€‚
</figcaption>
</figure>
</div>
<p>è¿™ç§æ–¹å¼ï¼Œåœ¨ä¹‹åçš„å®éªŒä¸­ä¹Ÿè¢«è¯æ˜æ˜¯æœ‰æ•ˆçš„ã€‚ Qwen3æ¨¡å‹<span class="citation" data-cites="Qwen3TechnicalReport2025yang">(<a href="#ref-Qwen3TechnicalReport2025yang" role="doc-biblioref">Yang et al. 2025</a>)</span> ä¹Ÿé‡‡ç”¨äº†ç±»ä¼¼çš„è®¾è®¡ã€‚</p>
<div id="fig-ablation-moe" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ablation-moe-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/ablation-moe.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ablation-moe-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: ä»è¿™ç§æ¶ˆèå®éªŒä¸­å¯ä»¥çœ‹å‡ºï¼Œåœ¨expertså˜å¤šçš„æƒ…å†µä¸‹ï¼ŒåŠ å…¥Shared Expertèƒ½å¤Ÿæå‡æ¨¡å‹çš„æ€§èƒ½ã€‚
</figcaption>
</figure>
</div>
</section>
<section id="choice-of-k" class="level4" data-number="2.1.1.3">
<h4 data-number="2.1.1.3" class="anchored" data-anchor-id="choice-of-k"><span class="header-section-number">2.1.1.3</span> Choice of K</h4>
<p>æˆ‘ä»¬äº†è§£äº†Top-K Gatingçš„å®ç°ç»†èŠ‚ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Kå€¼çš„é€‰æ‹©å¯¹æ¨¡å‹æ€§èƒ½çš„å½±å“ã€‚ Kå€¼çš„é€‰æ‹©å¯¹MoEæ¨¡å‹çš„æ€§èƒ½æœ‰æ˜¾è‘—å½±å“ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè¾ƒå°çš„Kå€¼å¯ä»¥å‡å°‘è®¡ç®—é‡ï¼Œä½†å¯èƒ½ä¼šé™åˆ¶æ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›ï¼›è€Œè¾ƒå¤§çš„Kå€¼åˆ™å¯ä»¥æå‡æ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›ï¼Œä½†ä¼šå¢åŠ è®¡ç®—é‡ã€‚å› æ­¤ï¼Œåœ¨å®é™…çš„åº”ç”¨ä¸­ï¼Œé€šå¸¸ä½¿ç”¨ K=1 æˆ– K=2 ä½œä¸ºé»˜è®¤é€‰æ‹©ã€‚</p>
<div class="callout callout-style-default callout-note callout-titled" title="K > 1">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
K &gt; 1
</div>
</div>
<div class="callout-body-container callout-body">
<p>è¯¾å ‚ä¸­æœ‰æåˆ°ï¼ŒK &gt; 1 æ—¶ã€‚æˆ‘ä»¬å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆBanditçš„é—®é¢˜ï¼ˆç†Ÿæ‚‰Reinforcement Learningçš„åŒå­¦åº”è¯¥äº†è§£ï¼‰ã€‚æ¯ä¸ªtokenåœ¨é€‰æ‹©ä¸“å®¶æ—¶ï¼Œå°±åƒæ˜¯åœ¨ç©ä¸€ä¸ªå¤šè‡‚è€è™æœºï¼ˆMulti-armed Banditï¼‰ï¼Œæ¯æ¬¡é€‰æ‹©Kä¸ªä¸“å®¶è¿›è¡Œå°è¯•ï¼Œä»è€Œè·å¾—æ›´å¥½çš„å¥–åŠ±ï¼ˆæ¨¡å‹æ€§èƒ½ï¼‰ã€‚è¿™ä¹Ÿæ˜¯RLä¸­æ¢ç´¢ä¸åˆ©ç”¨ï¼ˆExploration vs.&nbsp;Exploitationï¼‰é—®é¢˜çš„ä¸€ä¸ªä½“ç°ã€‚</p>
</div>
</div>
</section>
<section id="is-top-k-gating-optimal" class="level4" data-number="2.1.1.4">
<h4 data-number="2.1.1.4" class="anchored" data-anchor-id="is-top-k-gating-optimal"><span class="header-section-number">2.1.1.4</span> Is Top-K Gating Optimal?</h4>
<p>æˆ‘ä»¬äº†è§£äº†Top-K Gatingçš„å®ç°ï¼Œé‚£ä¹ˆå®ƒæ˜¯ä¸æ˜¯æœ€ä¼˜çš„å‘¢ï¼Ÿå…¶å®ä¹Ÿä¸å°½ç„¶ã€‚Lectureä¸­æœ‰æåˆ°ä¸€ä¸ªæ¯”è¾ƒæœ‰è¶£çš„è§‚å¯Ÿï¼šå³ä½¿ router å¾ˆå¼±ï¼ˆæ¯”å¦‚åŸºäº hashing çš„ç¡®å®šæ€§æ˜ å°„ï¼‰ï¼Œå¾ˆå¤šæ—¶å€™ä¹Ÿèƒ½æ¯” dense æ›´å¼ºã€‚æœ‰ä¸€ç§åˆç†çš„è§£é‡Šæ˜¯ï¼šåªè¦æ˜ å°„æ˜¯ç¡®å®šæ€§çš„ï¼Œæ¯ä¸ªä¸“å®¶ä»ä¼šé•¿æœŸçœ‹åˆ°æŸä¸ªå­åˆ†å¸ƒï¼Œä»è€Œå½¢æˆæŸç§â€œä¸“é—¨åŒ–â€ï¼ˆä¸ä¸€å®šæ˜¯ä½ ä»¥ä¸ºçš„è¯­ä¹‰ä¸“é—¨åŒ–ï¼Œå¯èƒ½æ˜¯é¢‘ç‡/æ¨¡å¼ä¸Šçš„ä¸“é—¨åŒ–ï¼‰ã€‚å› æ­¤ï¼ŒRouterå¹¶ä¸ä¸€å®šè¦è®¾è®¡çš„å¾ˆå¤æ‚ï¼Œç®€å•æœ‰æ•ˆå³å¯ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆTop-K Gatingèƒ½è¿™ä¹ˆå—æ¬¢è¿çš„åŸå› ä¹‹ä¸€ã€‚</p>
</section>
</section>
</section>
<section id="experts" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="experts"><span class="header-section-number">2.2</span> Experts</h2>
<p>åœ¨MoEæ¨¡å‹ä¸­ï¼ŒExpertsæ˜¯å¤šä¸ªç‹¬ç«‹çš„FFN Layerï¼Œæ¯ä¸ªExpertè´Ÿè´£å¤„ç†ä¸€éƒ¨åˆ†tokenã€‚æ¯ä¸ªExperté€šå¸¸ç”±ä¸€ä¸ªå‰é¦ˆç¥ç»ç½‘ç»œï¼ˆFeed-Forward Neural Network, FFNï¼‰ç»„æˆï¼Œç»“æ„ä¸ä¼ ç»Ÿçš„Transformerä¸­çš„FFNç±»ä¼¼ï¼Œä½†å‚æ•°æ˜¯ç‹¬ç«‹çš„ã€‚é‚£ä¹ˆï¼ŒExpertsçš„ä¸­é—´å±‚çš„ç»´åº¦åº”è¯¥å¦‚ä½•é€‰æ‹©å‘¢ï¼Ÿ ä¸€èˆ¬æ¥è¯´ï¼ŒExpertsçš„ä¸­é—´å±‚ç»´åº¦é€šå¸¸è®¾ç½®ä¸ºè¾“å…¥ç»´åº¦çš„4å€ï¼ˆå³<span class="math inline">\(4d_{model}\)</span>ï¼‰ï¼Œå’Œä¼ ç»Ÿçš„FFN Layerä¿æŒä¸€è‡´ã€‚è¿™æ˜¯å› ä¸ºè¾ƒå¤§çš„ä¸­é—´å±‚ç»´åº¦å¯ä»¥æå‡æ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›ï¼Œä»è€Œæå‡æ•´ä½“æ€§èƒ½ã€‚ ä½†æ˜¯ï¼Œåœ¨<a href="#fig-deepseek-moe" class="quarto-xref">Figure&nbsp;7</a>ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°DeepSeekä»‹ç»äº†Fine-Grained Expertsçš„æ¦‚å¿µï¼Œå³é€šè¿‡å¢åŠ Expertsçš„æ•°é‡ï¼ŒåŒæ—¶å‡å°‘æ¯ä¸ªExpertçš„ä¸­é—´å±‚ç»´åº¦ï¼Œä»è€Œæå‡æ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›ã€‚åœ¨DeepSeek MoE ä¸­<span class="citation" data-cites="DeepSeekMoEUltimateExpert2024dai">(<a href="#ref-DeepSeekMoEUltimateExpert2024dai" role="doc-biblioref">Dai et al. 2024</a>)</span>, æ¯ä¸ªExpertçš„ä¸­é—´å±‚ç»´åº¦è¢«è®¾ç½®ä¸º<span class="math inline">\(\frac{1}{4}d_{ff}\)</span>. è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œå¯ä»¥è®©æ¨¡å‹æ‹¥æœ‰æ›´å¤šçš„ä¸“å®¶ï¼Œä»è€Œæå‡æ¨¡å‹çš„å¤šæ ·æ€§å’Œè¡¨è¾¾èƒ½åŠ›ã€‚</p>
<blockquote class="blockquote">
<p>DeepSeekMoE has 1 shared expert and 63 routed experts, where each expert is 0.25 times the size of a standard FFN. <cite>DeepSeekMoE: Towards Ultimate Expert Specialization in Mixture-of-Experts Language Models, p.9<cite></cite></cite></p>
</blockquote>
</section>
<section id="training-objectives" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="training-objectives"><span class="header-section-number">2.3</span> Training Objectives</h2>
<p>å¦‚æœè¯´ Routing Function è§£å†³çš„æ˜¯â€œæ¯ä¸ª token å»å“ªäº›ä¸“å®¶â€ï¼Œé‚£ Training Objectives è§£å†³çš„æ˜¯æ›´ç°å®çš„é—®é¢˜ï¼šâ€œæ¯ä¸ªä¸“å®¶åˆ°åº•å­¦ä»€ä¹ˆâ€ã€‚åœ¨ MoE é‡Œï¼Œå•çº¯é ä¸»ä»»åŠ¡ loss(Next token Prediction Loss) å¾€å¾€ä¸å¤Ÿ.å¦‚æœä½ åªç”¨è¯­è¨€æ¨¡å‹çš„ä¸»æŸå¤±ï¼ˆnext-token lossï¼‰å»è®­ MoEï¼Œrouter å¾ˆå®¹æ˜“æŠŠæ‰€æœ‰ token éƒ½é€å»åŒä¸€ä¸ªä¸“å®¶ã€‚ç»“æœæ˜¯ï¼šä¸€ä¸ªä¸“å®¶å˜æˆâ€œä¸‡èƒ½ä¸“å®¶â€ï¼Œå…¶å®ƒä¸“å®¶å‡ ä¹ä»ä¸è¢«æ¿€æ´»ï¼ˆdead expertsï¼‰ï¼Œä½ ç™½ç™½å­˜äº†ä¸€å †å‚æ•°ï¼Œæ€§èƒ½ä¹Ÿä¼šå˜å·®ã€‚</p>
<p>å› æ­¤ï¼Œè¯¾å ‚ä¸Šä¹Ÿåœ¨åå¤å¼ºè°ƒçš„ä¸€ç‚¹æ˜¯ï¼š</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>MoE çš„ forward å¾ˆç®€å•ï¼Œéš¾ç‚¹åœ¨äºè®­ç»ƒæ—¶å¦‚ä½•é¿å… expert collapseï¼Œå¹¶è®©ä¸“å®¶ä½¿ç”¨æ›´å‡åŒ€ã€æ›´æœ‰æ•ˆç‡ã€‚</p>
</div>
</div>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªè®­ç»ƒé—®é¢˜éš¾åœ¨å“ªé‡Œï¼Œä»¥åŠæœ‰å“ªäº›å¸¸ç”¨çš„è§£å†³æ–¹æ³•ã€‚</p>
<section id="the-challenge-of-moe-training" class="level3" data-number="2.3.1">
<h3 data-number="2.3.1" class="anchored" data-anchor-id="the-challenge-of-moe-training"><span class="header-section-number">2.3.1</span> The Challenge of MoE Training</h3>
<p>MoE çš„ä¼˜åŠ¿åœ¨äºï¼Œåœ¨è®­ç»ƒæ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦æ ¹æ®Routeræ¥é€‰æ‹©æ¿€æ´»éƒ¨åˆ†ï¼ˆTop-kï¼‰ä¸“å®¶è¿›è¡Œè®¡ç®—ï¼Œè€Œä¸æ˜¯æ‰€æœ‰ä¸“å®¶éƒ½å‚ä¸è®¡ç®—ã€‚è¿™ç§ç¨€ç–æ¿€æ´»çš„æ–¹å¼ï¼Œå¯ä»¥å¤§å¹…å‡å°‘æ¯ä¸€æ­¥çš„è®¡ç®—é‡ï¼ˆFLOPsï¼‰ï¼Œä»è€Œæå‡è®­ç»ƒæ•ˆç‡ã€‚ä½†æ˜¯ï¼Œè¿™ç§ç¨€ç–æ¿€æ´»çš„æ–¹å¼ä¹Ÿå¸¦æ¥çš„æŒ‘æˆ˜æ˜¯ï¼šTop-Kæ˜¯ä¸å¯å¾®çš„ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬æ— æ³•ç›´æ¥ä½¿ç”¨æ¢¯åº¦ä¸‹é™æ³•æ¥ä¼˜åŒ–æ¨¡å‹å‚æ•°ã€‚å› æ­¤ï¼Œç ”ç©¶å‘˜ä»¬æå‡ºäº†å‡ ç§æ–¹æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<section id="rl-based-optimization" class="level4" data-number="2.3.1.1">
<h4 data-number="2.3.1.1" class="anchored" data-anchor-id="rl-based-optimization"><span class="header-section-number">2.3.1.1</span> RL Based Optimization</h4>
<p>ä¸€ç§æ€è·¯æ˜¯ä½¿ç”¨å¼ºåŒ–å­¦ä¹ ï¼ˆReinforcement Learning, RLï¼‰çš„æ–¹æ³•æ¥ä¼˜åŒ–è·¯ç”±å™¨çš„å‚æ•°ã€‚</p>
<div class="callout callout-style-default callout-tip callout-titled" title="RL 101">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
RL 101
</div>
</div>
<div class="callout-body-container callout-body">
<p>å¯¹äºä¸ç†Ÿæ‚‰å¼ºåŒ–å­¦ä¹ çš„åŒå­¦ï¼Œç®€å•ä»‹ç»ä¸€ä¸‹ã€‚å¼ºåŒ–å­¦ä¹ æ˜¯ä¸€ç§æœºå™¨å­¦ä¹ æ–¹æ³•ï¼Œå®ƒé€šè¿‡ä¸ç¯å¢ƒçš„äº¤äº’æ¥å­¦ä¹ æœ€ä¼˜ç­–ç•¥ã€‚åœ¨å¼ºåŒ–å­¦ä¹ ä¸­ï¼Œæ™ºèƒ½ä½“ï¼ˆAgentï¼‰é€šè¿‡è§‚å¯Ÿç¯å¢ƒçŠ¶æ€ï¼ˆStateï¼‰ï¼Œé€‰æ‹©åŠ¨ä½œï¼ˆActionï¼‰ï¼Œå¹¶æ ¹æ®ç¯å¢ƒåé¦ˆçš„å¥–åŠ±ï¼ˆRewardï¼‰æ¥è°ƒæ•´ç­–ç•¥ï¼Œä»è€Œæœ€å¤§åŒ–ç´¯ç§¯å¥–åŠ±ã€‚ åœ¨äº¤äº’çš„è¿‡ç¨‹ä¸­ï¼ŒAgentæ‰€äº§ç”Ÿçš„åŠ¨ä½œé€šå¸¸æ˜¯ç¦»æ•£çš„ï¼ˆDiscrete Actionï¼‰ï¼Œè¿™å°±å¯¼è‡´äº†å¼ºåŒ–å­¦ä¹ ä¸­çš„ä¸€ä¸ªæ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•åœ¨ç¦»æ•£åŠ¨ä½œç©ºé—´ä¸­è¿›è¡Œæœ‰æ•ˆçš„ç­–ç•¥ä¼˜åŒ–ã€‚å¸¸ç”¨çš„æ–¹æ³•åŒ…æ‹¬ç­–ç•¥æ¢¯åº¦ï¼ˆPolicy Gradientï¼‰å’ŒQ-learningç­‰ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å°†MoEçš„è·¯ç”±é—®é¢˜è§†ä½œä¸€ä¸ªå¼ºåŒ–å­¦ä¹ é—®é¢˜ï¼Œé€šè¿‡è®¾è®¡åˆé€‚çš„å¥–åŠ±å‡½æ•°ï¼Œæ¥å¼•å¯¼è·¯ç”±å™¨å­¦ä¹ æ›´ä¼˜çš„è·¯ç”±ç­–ç•¥ã€‚</p>
</div>
</div>
<p>ä½†æ˜¯ï¼Œå¼ºåŒ–å­¦ä¹ çš„æ–¹æ³•é€šå¸¸æ¯”è¾ƒå¤æ‚ï¼Œä¸”è®­ç»ƒè¿‡ç¨‹ä¸ç¨³å®šï¼ˆGradient Estimation Varianceè¾ƒå¤§ï¼‰ï¼Œå› æ­¤åœ¨å®é™…åº”ç”¨ä¸­å¹¶ä¸å¸¸ç”¨ã€‚</p>
</section>
<section id="stochastic-approximation" class="level4" data-number="2.3.1.2">
<h4 data-number="2.3.1.2" class="anchored" data-anchor-id="stochastic-approximation"><span class="header-section-number">2.3.1.2</span> Stochastic Approximation</h4>
<p>å¦ä¸€ç§æ€è·¯æ˜¯ä½¿ç”¨éšæœºè¿‘ä¼¼ï¼ˆStochastic Approximationï¼‰çš„æ–¹æ³•æ¥ä¼˜åŒ–è·¯ç”±å™¨çš„å‚æ•°ã€‚å…·ä½“æ¥è¯´ï¼Œåœ¨ router æ‰“åˆ†ï¼ˆlogitsï¼‰é‡Œæ³¨å…¥å™ªå£°/æ‰°åŠ¨ï¼Œè®© top-K çš„é€‰æ‹©åœ¨è®­ç»ƒæ—©æœŸâ€œå¶å°”æ¢è·¯â€ï¼Œä»è€Œæ›´åƒ bandit çš„æ¢ç´¢ç­–ç•¥ã€‚å…¶ä¸­ä¸€ä¸ªç»å…¸çš„ä¾‹å­å°±æ˜¯ Stochastic Jittering. å®ƒé€šè¿‡åœ¨è·¯ç”±å™¨çš„æ‰“åˆ†ä¸­æ·»åŠ é«˜æ–¯å™ªå£°ï¼Œä»è€Œå®ç°å¯¹ä¸“å®¶çš„éšæœºé€‰æ‹©ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Stochastic Jitteringçš„å…·ä½“å®ç°ç»†èŠ‚ã€‚</p>
<section id="stochastic-jittering" class="level5" data-number="2.3.1.2.1">
<h5 data-number="2.3.1.2.1" class="anchored" data-anchor-id="stochastic-jittering"><span class="header-section-number">2.3.1.2.1</span> Stochastic Jittering</h5>
<p>Stochastic Jittering çš„å®ç°æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol type="1">
<li>Router è®¡ç®—ï¼šå¯¹äºæ¯ä¸ª token çš„ hidden state <span class="math inline">\(h_i\)</span>ï¼Œé€šè¿‡ä¸€ä¸ªçº¿æ€§å±‚è®¡ç®—æ¯ä¸ªä¸“å®¶çš„åˆ†æ•°ï¼š <span id="eq-score-calculation-jittering"><span class="math display">\[
s_{i,j} = W_g h_i + b_g
\tag{5}\]</span></span></li>
<li>æ·»åŠ å™ªå£°ï¼šåœ¨æ¯ä¸ªä¸“å®¶çš„åˆ†æ•°ä¸­æ·»åŠ é«˜æ–¯å™ªå£°ï¼š <span id="eq-add-noise"><span class="math display">\[
\tilde{s}_{i,j} = s_{i,j} + \epsilon_{i,j}, \quad \epsilon_{i,j} \sim \mathcal{N}(0, \sigma(x_i)^2)
\tag{6}\]</span></span></li>
<li>Top-K é€‰æ‹©ï¼šå¯¹äºæ¯ä¸ª tokenï¼Œé€‰æ‹©æ·»åŠ å™ªå£°åçš„åˆ†æ•°æœ€é«˜çš„ K ä¸ªä¸“å®¶ï¼š <span id="eq-topk-selection-jittering"><span class="math display">\[
g_{i, j} = \begin{cases}
\tilde{s}_{i, j}, \quad \tilde{s}_{i, j} \in \text{Top-K}(\tilde{s}_i) \\
0, \quad \text{otherwise}
\end{cases}
\tag{7}\]</span></span></li>
</ol>
<p>å…¶ä¸­ï¼Œ<span class="math inline">\(\sigma(x_i)\)</span> æ˜¯å™ªå£°çš„æ ‡å‡†å·®, å®ƒæ˜¯ä¸€ä¸ªå¯å­¦ä¹ çš„å‡½æ•°ï¼Œé€šå¸¸é€šè¿‡ä¸€ä¸ªå°çš„ç¥ç»ç½‘ç»œæ¥å®ç°ã€‚é€šè¿‡è°ƒæ•´å™ªå£°çš„å¤§å°ï¼Œå¯ä»¥æ§åˆ¶è·¯ç”±å™¨çš„æ¢ç´¢ç¨‹åº¦ï¼Œä»è€Œæå‡æ¨¡å‹çš„è®­ç»ƒæ•ˆæœã€‚</p>
<p>é‚£ä¹ˆè¿™ä¸ªStochastic Jitteringè§£å†³äº†ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ å®ƒå…¶å®è§£å†³äº†ç±»ä¼¼äºâ€œæ¢ç´¢ä¸åˆ©ç”¨â€ï¼ˆExploration vs.&nbsp;Exploitationï¼‰çš„é—®é¢˜ã€‚åœ¨MoEçš„è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›è·¯ç”±å™¨èƒ½å¤Ÿæ—¢èƒ½åˆ©ç”¨å½“å‰çš„çŸ¥è¯†ï¼ˆé€‰æ‹©è¡¨ç°å¥½çš„ä¸“å®¶ï¼‰ï¼Œåˆèƒ½æ¢ç´¢æ–°çš„å¯èƒ½æ€§ï¼ˆå°è¯•å…¶ä»–ä¸“å®¶ï¼‰ã€‚è¿™äº <span class="math inline">\(\epsilon_{i,j} \sim \mathcal{N}(0, \sigma(x_i)^2)\)</span> ä¸­çš„å™ªå£°æ³¨å…¥æœºåˆ¶ç›¸å‘¼åº”ï¼Œé€šè¿‡åœ¨è·¯ç”±å™¨çš„æ‰“åˆ†ä¸­æ·»åŠ å™ªå£°ï¼Œå¯ä»¥è®©è·¯ç”±å™¨åœ¨è®­ç»ƒæ—©æœŸâ€œå¶å°”æ¢è·¯â€ï¼Œä»è€Œæ›´åƒ bandit çš„æ¢ç´¢ç­–ç•¥ã€‚</p>
<p>ä½†æ˜¯ï¼Œå®ƒæ˜¾ç„¶æ²¡æœ‰è§£å†³Top-Ké€‰æ‹©çš„ä¸å¯å¾®é—®é¢˜ï¼Œå¹¶ä¸”ï¼Œå™ªå£°çš„å¼•å…¥ä¹Ÿå¯èƒ½å¯¼è‡´è®­ç»ƒè¿‡ç¨‹çš„ä¸ç¨³å®šï¼š</p>
<ul>
<li>å™ªå£°è¿‡å¤§ï¼šå¯èƒ½å¯¼è‡´è·¯ç”±å™¨é€‰æ‹©çš„ä¸“å®¶è¿‡äºéšæœºï¼Œæ¯ä¸ªä¸“å®¶ä¸å¤Ÿä¸“é—¨åŒ–ï¼Œå½±å“æ¨¡å‹æ€§èƒ½ã€‚</li>
<li>å™ªå£°è¿‡å°ï¼šå¯èƒ½æ— æ³•æœ‰æ•ˆä¿ƒè¿›æ¢ç´¢ï¼Œè·¯ç”±å™¨ä»ç„¶å€¾å‘äºé€‰æ‹©å°‘æ•°å‡ ä¸ªä¸“å®¶ï¼Œå¯¼è‡´ä¸“å®¶å´©æºƒï¼ˆExpert Collapseï¼‰ã€‚</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>è¯¾ä¸Šè¿˜æåˆ°å¯¹ logitsåšä¹˜æ³•å™ªå£°ï¼ˆMultiplicative Perturbationï¼‰ï¼Œä¹Ÿæ˜¯ç±»ä¼¼çš„æ€è·¯ï¼Œä½†æ˜¯ä¹Ÿæœ‰ç±»ä¼¼çš„é—®é¢˜ã€‚</p>
</div>
</div>
</section>
</section>
<section id="auxiliary-heuristic-balancing-losses" class="level4" data-number="2.3.1.3">
<h4 data-number="2.3.1.3" class="anchored" data-anchor-id="auxiliary-heuristic-balancing-losses"><span class="header-section-number">2.3.1.3</span> Auxiliary / Heuristic Balancing Losses</h4>
<p>æ—¢ç„¶MoEè®­ç»ƒçš„éš¾ç‚¹åœ¨äºé¿å…ä¸“å®¶å´©æºƒï¼ˆExpert Collapseï¼‰ï¼Œé‚£ä¹ˆä¸€ä¸ªç›´æ¥çš„æ€è·¯å°±æ˜¯åœ¨ä¸»ä»»åŠ¡æŸå¤±ï¼ˆCross Entropy Lossï¼‰ä¹‹å¤–ï¼Œæ·»åŠ ä¸€äº›è¾…åŠ©æŸå¤±ï¼ˆAuxiliary Lossesï¼‰æ¥é¼“åŠ±ä¸“å®¶çš„å‡è¡¡ä½¿ç”¨ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œå¯ä»¥ç›´æ¥å¼•å¯¼æ¨¡å‹å­¦ä¹ æ›´å‡è¡¡çš„ä¸“å®¶ä½¿ç”¨ç­–ç•¥ï¼Œä»è€Œæå‡æ•´ä½“æ€§èƒ½ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä»‹ç»ä¸¤ç§å¸¸ç”¨çš„è¾…åŠ©æŸå¤±ï¼šLoad Balancing Loss å’Œ Z-Lossã€‚</p>
<section id="load-balancing-loss" class="level5" data-number="2.3.1.3.1">
<h5 data-number="2.3.1.3.1" class="anchored" data-anchor-id="load-balancing-loss"><span class="header-section-number">2.3.1.3.1</span> Load Balancing Loss</h5>
<p>Load Balancing Loss æ˜¯Switch Transformer<span class="citation" data-cites="SwitchTransformersScaling2022fedus">(<a href="#ref-SwitchTransformersScaling2022fedus" role="doc-biblioref">Fedus, Zoph, and Shazeer 2022</a>)</span>ä¸­æå‡ºçš„ä¸€ç§è¾…åŠ©æŸå¤±ï¼Œæ—¨åœ¨é¼“åŠ±è·¯ç”±å™¨å‡è¡¡åœ°ä½¿ç”¨æ‰€æœ‰ä¸“å®¶ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒé€šè¿‡è®¡ç®—æ¯ä¸ªä¸“å®¶è¢«é€‰æ‹©çš„é¢‘ç‡ï¼Œå¹¶ä¸ç†æƒ³çš„å‡è¡¡åˆ†å¸ƒè¿›è¡Œæ¯”è¾ƒï¼Œä»è€Œè®¡ç®—å‡ºè´Ÿè½½å‡è¡¡æŸå¤±ã€‚å…¶å…¬å¼å¦‚ä¸‹ï¼š $$</p>
<p>L_{} = N _{i=1}^{N} f_i P_i $${#eq-load-balancing-loss}</p>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li><span class="math inline">\(f_i\)</span> æ˜¯ä¸“å®¶ <span class="math inline">\(i\)</span> è¢«é€‰æ‹©çš„é¢‘ç‡, å®šä¹‰ä¸ºï¼š <span id="eq-expert-frequency"><span class="math display">\[
f_i = \frac{1}{T} \sum_{x \in \mathcal{B}} \mathbb{1} \{\text{argmax } p(x) = i\}
\tag{8}\]</span></span> <span class="math inline">\(\mathcal{B}\)</span> æ˜¯å½“å‰æ‰¹æ¬¡çš„æ ·æœ¬é›†åˆï¼Œ<span class="math inline">\(T\)</span> æ˜¯token çš„æ•°é‡ï¼Œ<span class="math inline">\(\mathbb{1}\)</span> æ˜¯æŒ‡ç¤ºå‡½æ•°ï¼Œå½“ä¸“å®¶ <span class="math inline">\(i\)</span> è¢«é€‰æ‹©æ—¶å–å€¼ä¸º1ï¼Œå¦åˆ™ä¸º0ã€‚ç›´è§‚æ¥è¯´ï¼šexpert i å®é™…ä¸Šâ€œæ‰¿æ‹…â€äº†å¤šå°‘è´Ÿè½½ã€‚</li>
<li><span class="math inline">\(P_i\)</span> æ˜¯ä¸“å®¶ <span class="math inline">\(i\)</span> çš„å¹³å‡è·¯ç”±æ¦‚ç‡ï¼Œå®šä¹‰ä¸ºï¼š <span id="eq-expert-probability"><span class="math display">\[
P_i = \frac{1}{T} \sum_{x \in \mathcal{B}} p_i(x)
\tag{9}\]</span></span> å…¶ä¸­ï¼Œ<span class="math inline">\(p_i(x)\)</span> æ˜¯è·¯ç”±å™¨å¯¹ä¸“å®¶ <span class="math inline">\(i\)</span> çš„è¾“å‡ºåˆ†æ•°ã€‚ç›´è§‚æ¥è¯´ï¼šrouter â€œæœ¬æ¥å€¾å‘â€æŠŠå¤šå°‘æ¦‚ç‡åˆ†ç»™ expert iã€‚</li>
</ul>
<p>ç›´è§‚æ¥çœ‹ï¼šå¦‚æœæŸä¸ª expert å®é™…æ‹¿äº†å¾ˆå¤š tokens (<span class="math inline">\(f_i\)</span> å¾ˆå¤§ï¼‰ï¼ŒåŒæ—¶ router è¿˜ç»§ç»­ç»™å®ƒå¾ˆé«˜æ¦‚ç‡ï¼ˆ<span class="math inline">\(P_i\)</span> å¾ˆå¤§ï¼‰ï¼Œé‚£ä¹ˆå®ƒçš„è´Ÿè½½å‡è¡¡æŸå¤±å°±ä¼šå¾ˆå¤§ï¼Œä»è€Œä¿ƒä½¿è·¯ç”±å™¨å‡å°‘å¯¹è¯¥ä¸“å®¶çš„é€‰æ‹©ã€‚åä¹‹äº¦ç„¶ã€‚</p>
<p>é€šè¿‡æœ€å°åŒ–è´Ÿè½½å‡è¡¡æŸå¤±ï¼Œå¯ä»¥é¼“åŠ±è·¯ç”±å™¨å‡è¡¡åœ°ä½¿ç”¨æ‰€æœ‰ä¸“å®¶ï¼Œä»è€Œæå‡æ¨¡å‹çš„è®­ç»ƒæ•ˆæœã€‚å…·ä½“æ¥è¯´ï¼š - å¦‚æœæŸä¸ªä¸“å®¶è¢«é€‰æ‹©çš„æ¬¡æ•°è¿œé«˜äºå¹³å‡æ°´å¹³ï¼Œé‚£ä¹ˆå®ƒçš„è´Ÿè½½å‡è¡¡æŸå¤±å°±ä¼šå¾ˆå¤§ï¼Œä»è€Œä¿ƒä½¿è·¯ç”±å™¨å‡å°‘å¯¹è¯¥ä¸“å®¶çš„é€‰æ‹©ã€‚ - åä¹‹ï¼Œå¦‚æœæŸä¸ªä¸“å®¶è¢«é€‰æ‹©çš„æ¬¡æ•°è¿œä½äºå¹³å‡æ°´å¹³ï¼Œé‚£ä¹ˆå®ƒçš„è´Ÿè½½å‡è¡¡æŸå¤±ä¹Ÿä¼šå¾ˆå¤§ï¼Œä»è€Œä¿ƒä½¿è·¯ç”±å™¨å¢åŠ å¯¹è¯¥ä¸“å®¶çš„é€‰æ‹©ã€‚</p>
<table class="table">
<colgroup>
<col style="width: 15%">
</colgroup>
<tbody>
<tr class="odd">
<td>Deepseek æ ¹æ®ä¸Šé¢çš„ Load Balancing Loss è®¾è®¡äº†ä¸€ä¸ªæ”¹è¿›ç‰ˆæœ¬ã€‚å®ƒä»¬æå‡ºï¼š</td>
</tr>
<tr class="even">
<td>- Per-expert Balancing Lossï¼šå°†ä¸Šè¿°çš„è´Ÿè½½å‡è¡¡æŸå¤±ï¼Œæ‹“å±•ä¸ºTop-Kä¸“å®¶çš„æƒ…å†µã€‚ - Per-Device Balancing Lossï¼šåœ¨åˆ†å¸ƒå¼è®­ç»ƒä¸­ï¼Œè€ƒè™‘æ¯ä¸ªè®¡ç®—è®¾å¤‡ä¸Šçš„ä¸“å®¶è´Ÿè½½å‡è¡¡ã€‚</td>
</tr>
<tr class="odd">
<td>æˆ‘ä»¬æ¥çœ‹çœ‹Per-Device Balancing Lossåšçš„æ˜¯ä»€ä¹ˆã€‚ æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨åˆ†å¸ƒå¼è®­ç»ƒä¸­ï¼Œä¸åŒçš„è®¡ç®—è®¾å¤‡ä¸Šå¯èƒ½ä¼šæœ‰ä¸åŒæ•°é‡çš„ä¸“å®¶ã€‚å¦‚æœæŸä¸ªè®¾å¤‡ä¸Šçš„ä¸“å®¶è¢«é€‰æ‹©çš„æ¬¡æ•°è¿œé«˜äºå¹³å‡æ°´å¹³ï¼Œé‚£ä¹ˆè¿™ä¸ªGPUå¾ˆå¯èƒ½è¿‡è½½ï¼Œç”šè‡³æŸåï¼Œä»è€Œå½±å“æ•´ä½“è®­ç»ƒæ•ˆç‡ã€‚è€Œæœ‰äº›è®¾å¤‡ä¸Šçš„ä¸“å®¶å¯èƒ½å‡ ä¹æ²¡æœ‰è¢«é€‰æ‹©ï¼Œå¯¼è‡´èµ„æºæµªè´¹ã€‚å› æ­¤ï¼ŒDeepSeekæå‡ºäº†Per-Device Balancing Lossï¼Œæ—¨åœ¨é¼“åŠ±æ¯ä¸ªè®¡ç®—è®¾å¤‡ä¸Šçš„ä¸“å®¶å‡è¡¡ä½¿ç”¨ã€‚å…¶å…¬å¼å¦‚ä¸‹ï¼š <span id="eq-device-balancing-loss"><span class="math display">\[
L_{\text{device}} = \beta \cdot D \cdot \sum_{d=1}^{D} f_d P_d
\tag{10}\]</span></span></td>
</tr>
<tr class="even">
<td>å…¶ä¸­ï¼š - <span class="math inline">\(D\)</span> æ˜¯è®¡ç®—è®¾å¤‡çš„æ•°é‡ã€‚ - <span class="math inline">\(f_d\)</span> æ˜¯è®¾å¤‡ <span class="math inline">\(d\)</span> ä¸Šçš„ä¸“å®¶è¢«é€‰æ‹©çš„é¢‘ç‡ï¼Œ - <span class="math inline">\(P_d\)</span> æ˜¯è®¾å¤‡ <span class="math inline">\(d\)</span> ä¸Šçš„ä¸“å®¶çš„å¹³å‡è·¯ç”±æ¦‚ç‡ã€‚</td>
</tr>
<tr class="odd">
<td>&gt;Per-expert ä¿è¯â€œä¸“å®¶åˆ«æ­»â€ï¼ŒPer-device ä¿è¯â€œGPU åˆ«çˆ†â€ã€‚</td>
</tr>
</tbody>
</table>
<p>DeepSeek V3 è¿˜æå‡ºäº†å¦ä¸€ç§æ”¹è¿›ç‰ˆæœ¬ï¼Œå®ƒä»¬ç§°ä½œAuxiliary Loss Free Balancingï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šä¸å†ä¸»è¦ä¾èµ– <span class="math inline">\(\mathcal{L}_{\text{ExpBal}}\)</span> æ¥åšè´Ÿè½½å‡è¡¡ï¼Œè€Œæ˜¯é€šè¿‡è°ƒæ•´è·¯ç”±å™¨çš„åç½®é¡¹ï¼ˆBiasï¼‰æ¥å®ç°å‡è¡¡ä½¿ç”¨ä¸“å®¶ã€‚å…·ä½“æ¥è¯´ï¼š</p>
<p><span id="eq-bias-topk-selection"><span class="math display">\[
g_{i,j} = \being{cases}
s_{i,j} + b_j, \quad s_{i,j} \in \text{Top-K}(s_i) \\
0, \quad \text{otherwise}
\end{cases}
\tag{11}\]</span></span></p>
<p>ç›´è§‚æ¥çœ‹ï¼š</p>
<ul>
<li>å¦‚æœ expert i æœ€è¿‘æ‹¿åˆ° token å¤ªå° â†’ å¢å¤§<span class="math inline">\(b_i\)</span> â†’ å®ƒæ›´å®¹æ˜“è¿›å…¥ top-K</li>
<li>å¦‚æœ expert i æ‹¿åˆ°çš„ token å¤ªå¤š â†’ å‡å° <span class="math inline">\(b_i\)</span> â†’ å®ƒæ›´ä¸å®¹æ˜“è¢«é€‰ä¸­</li>
</ul>
<p>è¿™æ˜¯ä¸€ç§åœ¨çº¿æ§åˆ¶/åœ¨çº¿å­¦ä¹ å¼çš„è´Ÿè½½å‡è¡¡ï¼šç”¨è§„åˆ™æ›´æ–° <span class="math inline">\(b_i\)</span>ï¼Œ è€Œä¸æ˜¯â€‹é€šè¿‡æ¢¯åº¦ä¸‹é™å»å­¦ä¹  <span class="math inline">\(P_i\)</span> â€‹</p>
<div id="fig-lb-loss" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-lb-loss-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/lb_loss.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-lb-loss-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: æˆ‘ä»¬çœ‹åˆ°ï¼Œä¸åŠ è´Ÿè½½å‡è¡¡æŸå¤±æ—¶ï¼ŒæŸäº›ä¸“å®¶å‡ ä¹æ²¡æœ‰è¢«é€‰æ‹©ï¼ˆDead Expertsï¼‰ã€‚è€ŒåŠ å…¥è´Ÿè½½å‡è¡¡æŸå¤±åï¼Œä¸“å®¶çš„ä½¿ç”¨æ›´åŠ å‡è¡¡ã€‚
</figcaption>
</figure>
</div>
</section>
<section id="z-loss" class="level5" data-number="2.3.1.3.2">
<h5 data-number="2.3.1.3.2" class="anchored" data-anchor-id="z-loss"><span class="header-section-number">2.3.1.3.2</span> Z-Loss</h5>
<p>Z-Loss æ˜¯å¦ä¸€ç§å¸¸ç”¨çš„è¾…åŠ©æŸå¤±ï¼Œæ—¨åœ¨é¼“åŠ±è·¯ç”±å™¨çš„è¾“å‡ºåˆ†å¸ƒæ›´åŠ å‡åŒ€ã€‚å…¶å…¬å¼å¦‚ä¸‹ï¼š <span id="eq-z-loss"><span class="math display">\[
L_{z} = \sum_{i} \left( \frac{p_i}{\sum_{j} p_j} - \frac{1}{E} \right)^2
\tag{12}\]</span></span> å…¶ä¸­ï¼Œ<span class="math inline">\(p_i\)</span> æ˜¯è·¯ç”±å™¨å¯¹ä¸“å®¶ <span class="math inline">\(i\)</span> çš„è¾“å‡ºåˆ†æ•°ï¼Œ<span class="math inline">\(E\)</span> æ˜¯ä¸“å®¶çš„æ€»æ•°ã€‚é€šè¿‡æœ€å°åŒ–è¿™ä¸ªæŸå¤±ï¼Œå¯ä»¥é¼“åŠ±è·¯ç”±å™¨çš„è¾“å‡ºåˆ†å¸ƒæ›´åŠ å‡åŒ€ï¼Œä»è€Œæå‡æ¨¡å‹çš„è®­ç»ƒæ•ˆæœã€‚</p>
</section>
</section>
<section id="loss-combination" class="level4" data-number="2.3.1.4">
<h4 data-number="2.3.1.4" class="anchored" data-anchor-id="loss-combination"><span class="header-section-number">2.3.1.4</span> Loss Combination</h4>
<p>åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒMoEæ¨¡å‹çš„æ€»æŸå¤±é€šå¸¸ç”±ä¸»ä»»åŠ¡æŸå¤±ï¼ˆCross Entropy Lossï¼‰å’Œè¾…åŠ©æŸå¤±ï¼ˆLoad Balancing Loss å’Œ Z-Lossï¼‰ç»„æˆï¼š <span id="eq-total-loss"><span class="math display">\[
L_{total} = L_{CE} + \lambda_{load} L_{load} + \lambda_{z} L_{z}
\tag{13}\]</span></span> å…¶ä¸­ï¼Œ<span class="math inline">\(L_{CE}\)</span> æ˜¯ä¸»ä»»åŠ¡æŸå¤±ï¼Œ<span class="math inline">\(L_{load}\)</span> æ˜¯è´Ÿè½½å‡è¡¡æŸå¤±ï¼Œ<span class="math inline">\(L_{z}\)</span> æ˜¯Z-Lossï¼Œ<span class="math inline">\(\lambda_{load}\)</span> å’Œ <span class="math inline">\(\lambda_{z}\)</span></p>
</section>
</section>
<section id="system-side" class="level3" data-number="2.3.2">
<h3 data-number="2.3.2" class="anchored" data-anchor-id="system-side"><span class="header-section-number">2.3.2</span> System Side</h3>
<p>åœ¨MoEæ¨¡å‹çš„å®ç°ä¸­ï¼Œç³»ç»Ÿå±‚é¢çš„ä¼˜åŒ–ä¹Ÿæ˜¯éå¸¸é‡è¦çš„ã€‚ç”±äºMoEæ¨¡å‹é€šå¸¸åŒ…å«å¤§é‡çš„ä¸“å®¶ï¼Œå› æ­¤åœ¨åˆ†å¸ƒå¼è®­ç»ƒä¸­ï¼Œéœ€è¦è€ƒè™‘å¦‚ä½•é«˜æ•ˆåœ°ç®¡ç†å’Œè°ƒåº¦è¿™äº›ä¸“å®¶ï¼Œä»¥æå‡è®­ç»ƒæ•ˆç‡å’Œæ¨¡å‹æ€§èƒ½ã€‚ä½†æ˜¯ï¼Œå®ƒä»¬ä¹Ÿå¸¦æ¥äº†ç³»ç»Ÿå®ç°ä¸Šçš„æŒ‘æˆ˜ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li>æ¯ä¸ª token åªæ¿€æ´»å°‘æ•°ä¸“å®¶ï¼ˆtop-Kï¼‰æ‰èƒ½çœ FLOPsï¼Œä½†ä¸“å®¶å¾€å¾€åˆ†æ•£åœ¨ä¸åŒ GPU/èŠ‚ç‚¹ä¸Šï¼Œäºæ˜¯è®­ç»ƒè¦é¢‘ç¹åš all-to-all dispatch + all-to-all gatherï¼ˆæŠŠ token å‘ç»™å¯¹åº”ä¸“å®¶ç®—ï¼Œå†æ”¶å›æ¥åˆå¹¶ï¼‰ã€‚è¿™ç±»é€šä¿¡æ˜¯å¦åˆ’ç®—å–å†³äºä¸“å®¶ FFN è®¡ç®—æ˜¯å¦â€œå¤Ÿå¤§å¤Ÿé‡â€ï¼Œèƒ½å¦ amortize é€šä¿¡æˆæœ¬ã€‚</li>
</ul>
</section>
<section id="fine-tuning-moe" class="level3" data-number="2.3.3">
<h3 data-number="2.3.3" class="anchored" data-anchor-id="fine-tuning-moe"><span class="header-section-number">2.3.3</span> Fine-tuning MoE</h3>
<p>MoE fine-tune æ›´éš¾ï¼šæ›´å®¹æ˜“ä¸ç¨³å®šï¼ˆblow upï¼‰+ æ›´å®¹æ˜“è¿‡æ‹Ÿåˆï¼ˆtrainâ€“val gap å¤§ï¼‰ã€‚</p>
</section>
<section id="upcycling" class="level3" data-number="2.3.4">
<h3 data-number="2.3.4" class="anchored" data-anchor-id="upcycling"><span class="header-section-number">2.3.4</span> Upcycling</h3>
<p>MoE çš„å¦ä¸€ä¸ªæœ‰è¶£åº”ç”¨æ˜¯â€œUpcyclingâ€ï¼ˆå›æ”¶åˆ©ç”¨ï¼‰ã€‚å…·ä½“æ¥è¯´ï¼Œå…ˆè®­ç»ƒå¥½ä¸€ä¸ª dense Transformerï¼Œå†æŠŠå…¶ä¸­çš„ FFN/MLP å¤åˆ¶æˆå¤šä»½ä¸“å®¶ï¼ˆexpertsï¼‰ï¼ŒåŠ ä¸Šä¸€ä¸ª routerï¼Œè®©æ¨¡å‹ä»è¿™ä¸€åˆ»èµ·å˜æˆ MoEï¼›ç»§ç»­è®­ç»ƒä¸€æ®µæ—¶é—´ï¼Œå°±èƒ½ç”¨è¾ƒä½æˆæœ¬å¾—åˆ°â€œæ€»å‚æ•°æ›´å¤§ã€æ¨ç†ä»ç¨€ç–æ¿€æ´»â€çš„ MoEã€‚å®ƒè§£å†³äº†â€œä»é›¶è®­ç»ƒ MoE å¤ªæ…¢å¤ªéš¾â€çš„é—®é¢˜ã€‚</p>
</section>
</section>
</section>
<section id="others" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Others</h1>
<p>è¯¾ç¨‹çš„æœ€åä»‹ç»äº†DeepSeekæˆåŠŸçš„ä¸€äº›å…¶ä»–æŠ€å·§ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>Multihead Latent Attentionï¼š</li>
<li>Multi Tokens Prediction</li>
</ul>
<p>åœ¨è¿™é‡Œå°±å…ˆä¸å±•å¼€ä»‹ç»äº†ï¼Œä¹‹åä¼šä¸“é—¨å†™ä¸€ç¯‡æ–‡ç« æ¥ä»‹ç»DeepSeekç³»åˆ—è®ºæ–‡çš„ç»†èŠ‚ã€‚</p>
</section>
<section id="summary" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Summary</h1>
</section>
<section id="in-the-end" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> In the End</h1>
<p>æœ€åï¼Œæ„Ÿè°¢ä½ ä¸€è·¯åšæŒåˆ°è¿™é‡Œï¼åˆ›ä½œä¸æ˜“ï¼Œå¦‚æœä½ è§‰å¾—å†…å®¹å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿è¯·æˆ‘<strong>å–æ¯å’–å•¡/æ”¯ä»˜å®çº¢åŒ…</strong>ï¼Œæ”¯æŒæˆ‘ç»§ç»­åˆ›ä½œï¼ä½ ä»¬çš„æ”¯æŒæ˜¯æˆ‘æœ€å¤§çš„åŠ¨åŠ›ï¼ :) <br></p>
<p><img src="../../../style/AliPay.jpg" class="img-fluid" width="300"></p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-DeepSeekMoEUltimateExpert2024dai" class="csl-entry" role="listitem">
Dai, Damai, Chengqi Deng, Chenggang Zhao, R. X. Xu, Huazuo Gao, Deli Chen, Jiashi Li, et al. 2024. <span>â€œ<span>DeepSeekMoE</span>: <span>Towards Ultimate Expert Specialization</span> in <span class="nocase">Mixture-of-Experts Language Models</span>.â€</span> January 11, 2024. <a href="https://doi.org/10.48550/arXiv.2401.06066">https://doi.org/10.48550/arXiv.2401.06066</a>.
</div>
<div id="ref-SwitchTransformersScaling2022fedus" class="csl-entry" role="listitem">
Fedus, William, Barret Zoph, and Noam Shazeer. 2022. <span>â€œSwitch <span>Transformers</span>: <span>Scaling</span> to <span>Trillion Parameter Models</span> with <span>Simple</span> and <span>Efficient Sparsity</span>.â€</span> June 16, 2022. <a href="https://doi.org/10.48550/arXiv.2101.03961">https://doi.org/10.48550/arXiv.2101.03961</a>.
</div>
<div id="ref-Qwen3TechnicalReport2025yang" class="csl-entry" role="listitem">
Yang, An, Anfeng Li, Baosong Yang, Beichen Zhang, Binyuan Hui, Bo Zheng, Bowen Yu, et al. 2025. <span>â€œQwen3 <span>Technical Report</span>.â€</span> May 14, 2025. <a href="https://doi.org/10.48550/arXiv.2505.09388">https://doi.org/10.48550/arXiv.2505.09388</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/sta210-s22\.github\.io\/website\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark_dimmed">
<script>
  function loadGiscus() {
    // Function to get the theme based on body class
    const getTheme = () => {
      let baseTheme = document.getElementById('giscus-base-theme').value;
      let altTheme = document.getElementById('giscus-alt-theme').value;
      if (authorPrefersDark) {
          [baseTheme, altTheme] = [altTheme, baseTheme];
      }
      return document.body.classList.contains('quarto-dark') ? altTheme : baseTheme;
    };
    const script = document.createElement("script");
    script.src = "https://giscus.app/client.js";
    script.async = true;
    script.dataset.repo = "YYZhang2025/YYZhang2025.github.io";
    script.dataset.repoId = "R_kgDOQlDTcQ";
    script.dataset.category = "General";
    script.dataset.categoryId = "DIC_kwDOQlDTcc4C2MRz";
    script.dataset.mapping = "title";
    script.dataset.reactionsEnabled = "1";
    script.dataset.emitMetadata = "0";
    script.dataset.inputPosition = "top";
    script.dataset.theme = getTheme();
    script.dataset.lang = "en";
    script.crossOrigin = "anonymous";
    // Append the script to the desired div instead of at the end of the body
    document.getElementById("quarto-content").appendChild(script);
  }
  loadGiscus();
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../../posts/CS336/Lecture03/lec03.html" class="pagination-link" aria-label="Lecture 03: Transformer LM Architecture">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Lecture 03: Transformer LM Architecture</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../../posts/CS336/Lecture05&amp;06/lec05.html" class="pagination-link" aria-label="Lecture 05&amp;06: GPU Optimization, Triton &amp; FlashAttention">
        <span class="nav-page-text">Lecture 05&amp;06: GPU Optimization, Triton &amp; FlashAttention</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Â© CC-By Yuyang, 2025</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>This page is built with â¤ï¸ and <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>
    <script type="text/javascript">
    (function(d) {
      d.querySelectorAll(".pseudocode-container").forEach(function(el) {
        let pseudocodeOptions = {
          indentSize: el.dataset.indentSize,
          commentDelimiter: el.dataset.commentDelimiter,
          lineNumber: el.dataset.lineNumber.toLowerCase() === "true",
          lineNumberPunc: el.dataset.lineNumberPunc,
          noEnd: el.dataset.noEnd.toLowerCase() === "true",
          titlePrefix: el.dataset.captionPrefix
        };
        pseudocode.renderElement(el.querySelector(".pseudocode"), pseudocodeOptions);
      });
    })(document);
    (function(d) {
      d.querySelectorAll(".pseudocode-container").forEach(function(el) {
        let captionSpan = el.querySelector(".ps-root > .ps-algorithm > .ps-line > .ps-keyword")
        if (captionSpan !== null) {
          let captionPrefix = el.dataset.captionPrefix + " ";
          let captionNumber = "";
          if (el.dataset.pseudocodeNumber) {
            captionNumber = el.dataset.pseudocodeNumber + " ";
            if (el.dataset.chapterLevel) {
              captionNumber = el.dataset.chapterLevel + "." + captionNumber;
            }
          }
          captionSpan.innerHTML = captionPrefix + captionNumber;
        }
      });
    })(document);
    </script>
  




<script src="../../../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.js" defer="true"></script>
</body></html>