<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="è¿™èŠ‚ä»‹ç»äº†PPOï¼Œ ä»¥åŠDPOæ‰€å­˜åœ¨çš„é—®é¢˜ï¼Œå¹¶ä¸”å¼•å‡ºäº†Reinforcement Learning from Verified Rewards (RLVR)çš„æ–°æ–¹æ³•GRPOã€‚å†…å®¹åŒ…æ‹¬Advantage Functionã€Length Normalizationå…³é”®æŠ€æœ¯ç»†èŠ‚ï¼Œå¹¶é€šè¿‡DeepSeek-R1ã€Kimi 1.5å’ŒQwen3ç­‰æ¡ˆä¾‹å±•ç¤ºäº†GRPOåœ¨å®é™…ä¸­çš„åº”ç”¨ã€‚è€ŒLecture17åˆ™é€šè¿‡ä¸€ä¸ªæ’åºä»»åŠ¡çš„å…·ä½“ä¾‹å­ï¼Œè¯¦ç»†è®²è§£äº†GRPOç®—æ³•çš„å®ç°ç»†èŠ‚ï¼ŒåŒ…æ‹¬æ•°æ®ç”Ÿæˆã€å¥–åŠ±å‡½æ•°è®¾è®¡ã€æ¨¡å‹æ¶æ„ä»¥åŠè®­ç»ƒè¿‡ç¨‹ï¼Œåœ¨è¿™é‡Œå°±æŠŠä¸¤èŠ‚è¯¾åˆæˆä¸€èŠ‚è¯¾æ¥å†™ã€‚">

<title>Lecture 16 &amp; 17: LLM Alignment SFT &amp; RLVRï¼ˆGRPOï¼‰ â€“ Learning Note</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../posts/CS336/Ass01/ass01.html" rel="next">
<link href="../../../posts/CS336/Lecture15/lec15.html" rel="prev">
<link href="../../.././style/icon.avif" rel="icon">
<script src="../../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-234273d1456647dabc34a594ac50e507.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dark-0348920b7671f696dc9078d39bff215e.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-234273d1456647dabc34a594ac50e507.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-01e1ab90bb0902c54ef2dc3889c8698d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../../site_libs/bootstrap/bootstrap-dark-987788bda8b0cf97ae4c62c0f40f22af.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../../../site_libs/bootstrap/bootstrap-01e1ab90bb0902c54ef2dc3889c8698d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<link href="../../../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.css" rel="stylesheet">
<script src="../../../site_libs/quarto-contrib/pseudocode-2.4.1/pseudocode.min.js"></script>
<link href="../../../site_libs/quarto-contrib/pseudocode-2.4.1/pseudocode.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-E8EJCZTZG1"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-E8EJCZTZG1', { 'anonymize_ip': true});
</script>
<link href="https://fonts.cdnfonts.com/css/cmu-sans-serif" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
<script>
    MathJax = {
        loader: {
        load: ['[tex]/boldsymbol']
        },
        tex: {
        tags: "all",
        inlineMath: [['$','$'], ['\\(','\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']],
        processEscapes: true,
        processEnvironments: true,
        packages: {
            '[+]': ['boldsymbol']
        }
        }
    };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll(".foldable-header").forEach(header => {
    header.addEventListener("click", () => {
      const block = header.closest(".foldable");
      if (block) {
        block.classList.toggle("is-open");
      }
    });

    // å¯è®¿é—®æ€§ï¼ˆé”®ç›˜ï¼‰
    header.setAttribute("tabindex", "0");
    header.addEventListener("keydown", e => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        header.click();
      }
    });
  });
});
</script>
    <style type="text/css">
    .ps-root .ps-algorithm {
      border-top: 2px solid;
      border-bottom: 2px solid;
    }
    .pseudocode-container {
      text-align: left;
    }
    </style>
  
      <style type="text/css">
      .ps-algorithm > .ps-line {
        text-align: left;
      }
      </style>
    

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar docked quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <a class="flex-grow-1 no-decor" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
          <h1 class="quarto-secondary-nav-title">Lecture 16 &amp; 17: LLM Alignment SFT &amp; RLVRï¼ˆGRPOï¼‰</h1>
        </a>     
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header">
      <a href="../../../index.html" class="sidebar-logo-link">
      <img src="../../.././style/logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/YYZhang2025" title="GitHub organization" class="quarto-navigation-tool px-1" aria-label="GitHub organization"><i class="bi bi-github"></i></a>
    <a href="https://www.linkedin.com/in/zhang-yuyang/" title="LinkedIn" class="quarto-navigation-tool px-1" aria-label="LinkedIn"><i class="bi bi-linkedin"></i></a>
    <a href="https://yyzhang2025.github.io/posts/Blogs/blogs_index.html" title="Personal Blogs" class="quarto-navigation-tool px-1" aria-label="Personal Blogs"><i class="bi bi-globe"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false">
 <span class="menu-text">ğŸ“ 100 AI Papers with Code</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/100-AI-Papers/100_Papers_index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About this series</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/100-AI-Papers/01-transformer/Transformer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Transformer</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/100-AI-Papers/02-vision-transformer/Vision-Transformer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Vision Transformer</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">ğŸ“ Stanford CS336: LLM from Scratch</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About this course</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture01/lec01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 01: Introduction &amp; BPE</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture02/lec02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 02: PyTorch Basics &amp; Resource Accounts</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture03/lec03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 03: Transformer LM Architecture</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture04/lec04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 04: MoE Architecture</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture05&amp;06/lec05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 05&amp;06: GPU Optimization, Triton &amp; FlashAttention</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture07&amp;08/lec07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 07&amp;08: Parallelism</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture9&amp;11/lec9.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 09&amp;11: Scaling Laws</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture10/lec10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 10: Inference &amp; Deployment</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture12/lec12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 12: Evaluation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture13&amp;14/lec13.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 13&amp;14: Data Collection &amp; Processing</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture15/lec15.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 15: LLM Alignment SFT &amp; RLHF(PPO, DPO)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Lecture16&amp;17/lec16.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Lecture 16 &amp; 17: LLM Alignment SFT &amp; RLVR(GRPO)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Ass01/ass01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Assignment 01: BPE Tokenizer &amp; Transformer LM</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Ass02/ass02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Assignment 02: Flash Attention &amp; Parallelism</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/CS336/Ass05/ass05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Assignment 05: SFT &amp; GRPO</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false">
 <span class="menu-text">ğŸ“– Deep Learning Foundation &amp; Concepts</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../posts/DLFaC/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About this book</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#why-not-ppo-dpo" id="toc-why-not-ppo-dpo" class="nav-link active" data-scroll-target="#why-not-ppo-dpo"><span class="header-section-number">1</span> Why NOT PPO &amp; DPO ?</a>
  <ul>
  <li><a href="#why-not-ppo" id="toc-why-not-ppo" class="nav-link" data-scroll-target="#why-not-ppo"><span class="header-section-number">1.1</span> Why Not PPO?</a></li>
  <li><a href="#why-not-dpo" id="toc-why-not-dpo" class="nav-link" data-scroll-target="#why-not-dpo"><span class="header-section-number">1.2</span> Why Not DPO?</a></li>
  </ul></li>
  <li><a href="#what-is-rlvr" id="toc-what-is-rlvr" class="nav-link" data-scroll-target="#what-is-rlvr"><span class="header-section-number">2</span> What is RLVR?</a></li>
  <li><a href="#grpo" id="toc-grpo" class="nav-link" data-scroll-target="#grpo"><span class="header-section-number">3</span> GRPO</a>
  <ul>
  <li><a href="#grpo-objective" id="toc-grpo-objective" class="nav-link" data-scroll-target="#grpo-objective"><span class="header-section-number">3.1</span> GRPO Objective</a></li>
  <li><a href="#advantage-calculation-in-grpo" id="toc-advantage-calculation-in-grpo" class="nav-link" data-scroll-target="#advantage-calculation-in-grpo"><span class="header-section-number">3.2</span> Advantage Calculation in GRPO</a></li>
  <li><a href="#grpo-algorithm" id="toc-grpo-algorithm" class="nav-link" data-scroll-target="#grpo-algorithm"><span class="header-section-number">3.3</span> GRPO Algorithm</a></li>
  <li><a href="#bias-in-grpo" id="toc-bias-in-grpo" class="nav-link" data-scroll-target="#bias-in-grpo"><span class="header-section-number">3.4</span> Bias in GRPO</a>
  <ul>
  <li><a href="#biased-gradient" id="toc-biased-gradient" class="nav-link" data-scroll-target="#biased-gradient"><span class="header-section-number">3.4.1</span> Biased Gradient</a></li>
  <li><a href="#length-normalization-bias" id="toc-length-normalization-bias" class="nav-link" data-scroll-target="#length-normalization-bias"><span class="header-section-number">3.4.2</span> Length Normalization Bias</a></li>
  </ul></li>
  <li><a href="#dr.grpo" id="toc-dr.grpo" class="nav-link" data-scroll-target="#dr.grpo"><span class="header-section-number">3.5</span> Dr.GRPO</a></li>
  </ul></li>
  <li><a href="#case-studies" id="toc-case-studies" class="nav-link" data-scroll-target="#case-studies"><span class="header-section-number">4</span> Case Studies</a>
  <ul>
  <li><a href="#deepseek-r1" id="toc-deepseek-r1" class="nav-link" data-scroll-target="#deepseek-r1"><span class="header-section-number">4.1</span> DeepSeek-R1</a>
  <ul>
  <li><a href="#from-deepseek-v3-to-deepseek-r1-zero" id="toc-from-deepseek-v3-to-deepseek-r1-zero" class="nav-link" data-scroll-target="#from-deepseek-v3-to-deepseek-r1-zero"><span class="header-section-number">4.1.1</span> From DeepSeek-V3 to DeepSeek-R1-Zero</a></li>
  <li><a href="#from-deepseek-r1-zero-to-deepseek-r1" id="toc-from-deepseek-r1-zero-to-deepseek-r1" class="nav-link" data-scroll-target="#from-deepseek-r1-zero-to-deepseek-r1"><span class="header-section-number">4.1.2</span> From DeepSeek-R1-Zero to DeepSeek-R1</a></li>
  <li><a href="#deepseek-distillation" id="toc-deepseek-distillation" class="nav-link" data-scroll-target="#deepseek-distillation"><span class="header-section-number">4.1.3</span> DeepSeek Distillation</a></li>
  </ul></li>
  <li><a href="#kimi-1.5" id="toc-kimi-1.5" class="nav-link" data-scroll-target="#kimi-1.5"><span class="header-section-number">4.2</span> Kimi 1.5</a></li>
  <li><a href="#qwen3" id="toc-qwen3" class="nav-link" data-scroll-target="#qwen3"><span class="header-section-number">4.3</span> Qwen3</a></li>
  </ul></li>
  <li><a href="#grpo-implementation" id="toc-grpo-implementation" class="nav-link" data-scroll-target="#grpo-implementation"><span class="header-section-number">5</span> GRPO Implementation</a>
  <ul>
  <li><a href="#data-goal" id="toc-data-goal" class="nav-link" data-scroll-target="#data-goal"><span class="header-section-number">5.1</span> Data &amp; Goal</a></li>
  <li><a href="#reward" id="toc-reward" class="nav-link" data-scroll-target="#reward"><span class="header-section-number">5.2</span> Reward</a>
  <ul>
  <li><a href="#reward-v2inclusion-adjacent-sorted-pairsè¯¾å ‚é‡‡ç”¨çš„æ›´ç»†å¥–åŠ±" id="toc-reward-v2inclusion-adjacent-sorted-pairsè¯¾å ‚é‡‡ç”¨çš„æ›´ç»†å¥–åŠ±" class="nav-link" data-scroll-target="#reward-v2inclusion-adjacent-sorted-pairsè¯¾å ‚é‡‡ç”¨çš„æ›´ç»†å¥–åŠ±"><span class="header-section-number">5.2.1</span> Reward v2ï¼šInclusion + Adjacent Sorted Pairsï¼ˆè¯¾å ‚é‡‡ç”¨çš„æ›´ç»†å¥–åŠ±ï¼‰</a></li>
  </ul></li>
  <li><a href="#model" id="toc-model" class="nav-link" data-scroll-target="#model"><span class="header-section-number">5.3</span> Model</a></li>
  <li><a href="#algorithm" id="toc-algorithm" class="nav-link" data-scroll-target="#algorithm"><span class="header-section-number">5.4</span> Algorithm</a></li>
  <li><a href="#training" id="toc-training" class="nav-link" data-scroll-target="#training"><span class="header-section-number">5.5</span> Training</a></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results"><span class="header-section-number">5.6</span> Results</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">6</span> Summary</a></li>
  <li><a href="#in-the-end" id="toc-in-the-end" class="nav-link" data-scroll-target="#in-the-end"><span class="header-section-number">7</span> In the End</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Lecture 16 &amp; 17: LLM Alignment SFT &amp; RLVRï¼ˆGRPOï¼‰</h1>
</div>

<div>
  <div class="description">
    è¿™èŠ‚ä»‹ç»äº†PPOï¼Œ ä»¥åŠDPOæ‰€å­˜åœ¨çš„é—®é¢˜ï¼Œå¹¶ä¸”å¼•å‡ºäº†Reinforcement Learning from Verified Rewards (RLVR)çš„æ–°æ–¹æ³•<strong>GRPO</strong>ã€‚å†…å®¹åŒ…æ‹¬Advantage Functionã€Length Normalizationå…³é”®æŠ€æœ¯ç»†èŠ‚ï¼Œå¹¶é€šè¿‡DeepSeek-R1ã€Kimi 1.5å’ŒQwen3ç­‰æ¡ˆä¾‹å±•ç¤ºäº†GRPOåœ¨å®é™…ä¸­çš„åº”ç”¨ã€‚è€ŒLecture17åˆ™é€šè¿‡ä¸€ä¸ªæ’åºä»»åŠ¡çš„å…·ä½“ä¾‹å­ï¼Œè¯¦ç»†è®²è§£äº†GRPOç®—æ³•çš„å®ç°ç»†èŠ‚ï¼ŒåŒ…æ‹¬æ•°æ®ç”Ÿæˆã€å¥–åŠ±å‡½æ•°è®¾è®¡ã€æ¨¡å‹æ¶æ„ä»¥åŠè®­ç»ƒè¿‡ç¨‹ï¼Œåœ¨è¿™é‡Œå°±æŠŠä¸¤èŠ‚è¯¾åˆæˆä¸€èŠ‚è¯¾æ¥å†™ã€‚
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>åœ¨ä¹‹å‰çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†PPOä»¥åŠDPOçš„ç®—æ³•ï¼Œæˆ‘ä»¬å› æ­¤ä¹Ÿä»GPTå¾—åˆ°äº†ChatGPTã€‚ä½†è¿™è·ç¦»ç°åœ¨çš„ <a href="https://en.wikipedia.org/wiki/Reasoning_model">Reasoning Model</a>ï¼Œè¿˜æœ‰ä¸€æ®µè·ç¦»ã€‚åœ¨è¿™èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ æ–°çš„ä¸€ç³»åˆ—ç®—æ³•ï¼Œä¹Ÿå°±æ˜¯<strong>RLVR(Reinforcement Learning from Verified Rewards)</strong>ï¼Œé€šè¿‡è¿™äº›ç®—æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ä»ChatGPTçªç ´åˆ°<a href="https://en.wikipedia.org/wiki/OpenAI_o1">ChatGPT-o1</a>ã€‚</p>
<p>åœ¨äº†è§£RLVRä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ï¼Œ<span class="hilite-orange">ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨PPOå’ŒDPOæ¥åšLLMçš„æ¨ç†å¼ºåŒ–å­¦ä¹ ã€‚</span></p>
<div class="note foldable is-open">
<div class="note-header foldable-header">
<p>æ¨èé˜…è¯»</p>
</div>
<div class="note-container foldable-content">
<p>å¯¹äºæƒ³æ›´æ·±å…¥äº†è§£ <span class="hilite-teal">RL in LLM</span> çš„åŒå­¦ä»¬ï¼Œæˆ‘æ¨èé˜…è¯»æˆ‘è¿™ä¸€ç¯‡æ–‡ç«  <a href="https://yyzhang2025.github.io/posts/Blogs/LLM-RL/post.html">Reinforcement Learning in LLM</a>ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ç³»ç»Ÿåœ°ä»‹ç»äº† LLM ä¸­çš„å¼ºåŒ–å­¦ä¹ ï¼ŒåŒ…æ‹¬ PPOã€DPO ä»¥åŠ RLVR çš„åŸç†å’Œå®ç°ç»†èŠ‚ã€‚å¹¶ä¸”å¯¹æ¯”äº†ä¸åŒçš„RLVRçš„ç®—æ³•ï¼Œæ¯”å¦‚GRPOï¼ŒGSPOï¼ŒDAPOç­‰ã€‚</p>
</div>
</div>
<section id="why-not-ppo-dpo" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Why NOT PPO &amp; DPO ?</h1>
<section id="why-not-ppo" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="why-not-ppo"><span class="header-section-number">1.1</span> Why Not PPO?</h2>
<p>PPOç†è®ºä¸Šå°±ä¸€ä¸ªclipç›®æ ‡ï¼Œä½†è½åœ°è¦å¤„ç†å¾ˆå¤šç»„ä»¶, åŒ…æ‹¬ï¼š</p>
<ul>
<li>rollouté‡‡æ ·/ç¼“å­˜ã€old logprobã€ratioã€clipã€KL penalty/target KL</li>
<li>advantageä¼°è®¡ï¼ˆGAEï¼‰ã€returnè®¡ç®—</li>
</ul>
<p>å¯¹LLMæ¥è¯´ï¼Œ<strong>rolloutå¾ˆè´µ</strong>ï¼ˆæ¨ç†ç”Ÿæˆtokenï¼‰ï¼Œæ‰€ä»¥è¿˜ä¼šå¼•å…¥â€œé‡‡ä¸€æ¬¡rolloutï¼Œæ›´æ–°å¤šæ¬¡â€çš„æœºåˆ¶ï¼Œè¿™åˆæŠŠå®ç°å¤æ‚åº¦ç»§ç»­æŠ¬é«˜ã€‚å¹¶ä¸”ï¼Œæœ€ä¸»è¦çš„é—®é¢˜æ˜¯ï¼š</p>
<div class="highlight">
<p>PPOé€šå¸¸éœ€è¦ä¸€ä¸ª <strong>value function</strong> æ¥è®¡ç®—Advantage.</p>
</div>
<p>è¿™æ„å‘³ç€ï¼š</p>
<ul>
<li>é¢å¤–çš„æ¨¡å‹ï¼ˆvalue modelï¼‰+å†…å­˜å¼€é”€</li>
<li>é¢å¤–çš„è®­ç»ƒç›®æ ‡ï¼ˆvalue lossï¼‰</li>
</ul>
<blockquote class="blockquote">
<p>â€œValue model (memory hungry, involves additional tuning)â€</p>
</blockquote>
</section>
<section id="why-not-dpo" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="why-not-dpo"><span class="header-section-number">1.2</span> Why Not DPO?</h2>
<p>DPOçš„å¼ºé¡¹æ˜¯<strong>åå¥½å¯¹æ¯”æ•°æ®</strong> <span class="math inline">\((p, y_i, y_j)\)</span>ï¼Œä½†åœ¨<strong>å¯éªŒè¯å¥–åŠ±</strong>çš„æ¨ç†RLé‡Œï¼Œæ•°æ®å¸¸è§æ˜¯ï¼š</p>
<ul>
<li>ä¸€ä¸ªpromptï¼Œ</li>
<li>ä¸€ä¸ªå›ç­”ï¼Œ</li>
<li>reward=0/1ï¼ˆå¯¹/é”™ï¼‰æˆ–åˆ†æ•°</li>
</ul>
<p>æ•°æ®ä¸æ˜¯å¤©ç„¶çš„<strong>pairwiseåå¥½</strong>ï¼Œè€Œæ˜¯<strong>pointwise reward</strong>ã€‚å¦å¤–ï¼ŒDPOå¸¸è§ä½¿ç”¨æ–¹å¼å<strong>Off-Policy</strong>ï¼šå…ˆæ”¶é›†å¯¹æ¯”æ•°æ®ï¼Œå†è®­ç»ƒã€‚è€Œæ¨ç†RLé€šå¸¸æ›´åƒ<strong>åœ¨çº¿</strong>ï¼šæ¨¡å‹ä¸æ–­å˜å¼º â†’ ä¸æ–­rollout â†’ ä¸æ–­ç”¨æœ€æ–°ç­–ç•¥ç”Ÿæˆæ–°æ•°æ®è®­ç»ƒï¼ˆon-policyå‘³é“æ›´å¼ºï¼‰ã€‚GRPO/PPOå¤©ç„¶é€‚é…è¿™ç§å¾ªç¯ã€‚</p>
</section>
</section>
<section id="what-is-rlvr" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> What is RLVR?</h1>
<p>RLVR (Reinforcement Learning from Verified Rewards) æ˜¯ä¸€ç±»ä¸“é—¨ä¸º LLM æ¨ç†å¼ºåŒ–å­¦ä¹ è®¾è®¡çš„ç®—æ³•ã€‚å®ƒä»¬åˆ©ç”¨<strong>å¯éªŒè¯å¥–åŠ±</strong>ï¼ˆä¾‹å¦‚æ•°å­¦é¢˜çš„å¯¹é”™ï¼‰æ¥ä¼˜åŒ–æ¨¡å‹çš„æ¨ç†èƒ½åŠ›ã€‚ å®ƒçš„æµç¨‹å¤§è‡´å¦‚ä¸‹ <a href="#fig-rlvf" class="quarto-xref">Figure&nbsp;1 (a)</a>ï¼š</p>
<div id="fig-rlhf-vs-rlvr" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-rlhf-vs-rlvr-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-rlhf-vs-rlvr" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-rlvf" class="quarto-float quarto-figure quarto-figure-center anchored" style="object-fit:contain;">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-rlvf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/rlvf-overview.png" style="object-fit:contain;;width:100.0%" data-ref-parent="fig-rlhf-vs-rlvr" height="200" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-rlvf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Overview of RLVR
</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-rlhf-vs-rlvr" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-rlhf" class="quarto-float quarto-figure quarto-figure-center anchored" style="object-fit:contain;">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-rlhf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/rlhf-overview.png" style="object-fit:contain;;width:100.0%" data-ref-parent="fig-rlhf-vs-rlvr" height="200" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-rlhf-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Overview of RLHF
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-rlhf-vs-rlvr-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: RLVR vs RLHFï¼Œ RLHF ä¾èµ–äººå·¥åå¥½æ•°æ®ï¼Œè€Œ RLVR åˆ™åˆ©ç”¨å¯éªŒè¯å¥–åŠ±è¿›è¡Œè®­ç»ƒã€‚ RLVR åˆ©ç”¨ <strong>Verified Rewards</strong> ç›´æ¥ä¼˜åŒ–æ¨¡å‹çš„æ¨ç†èƒ½åŠ›ï¼Œè€Œä¸éœ€è¦é¢å¤–çš„å¥–åŠ±æ¨¡å‹ã€‚
</figcaption>
</figure>
</div>
<p>ç›¸æ¯”äºRLHFï¼ŒRLVRæœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š</p>
<ul>
<li><strong>ç›´æ¥åˆ©ç”¨å¯éªŒè¯å¥–åŠ±</strong>ï¼šRLVRç›´æ¥ä½¿ç”¨å¯éªŒè¯çš„å¥–åŠ±ä¿¡å·ï¼ˆå¦‚æ•°å­¦é¢˜çš„å¯¹é”™ï¼‰ï¼Œè€Œä¸éœ€è¦è®­ç»ƒå¤æ‚çš„å¥–åŠ±æ¨¡å‹ã€‚è¿™ç®€åŒ–äº†è®­ç»ƒæµç¨‹ï¼Œå‡å°‘äº†å¯¹é«˜è´¨é‡åå¥½æ•°æ®çš„ä¾èµ–ã€‚</li>
<li><strong>å¯¹æ¨¡å‹è¾“å‡ºçš„ä¸¥æ ¼çº¦æŸ</strong>ï¼šRLVRæ–¹æ³•é€šå¸¸è®¾è®¡äº†ä¸“é—¨çš„ç›®æ ‡å‡½æ•°ï¼Œç¡®ä¿æ¨¡å‹åœ¨ç”Ÿæˆæ¨ç†é“¾æ—¶éµå¾ªé€»è¾‘å’Œäº‹å®ï¼Œä»è€Œæé«˜äº†æ¨¡å‹çš„å¯é æ€§å’Œå‡†ç¡®æ€§ã€‚</li>
<li><strong>æ›´é«˜çš„æ ·æœ¬æ•ˆç‡</strong>ï¼šé€šè¿‡åˆ©ç”¨å¯éªŒè¯å¥–åŠ±ï¼ŒRLVRæ–¹æ³•èƒ½å¤Ÿæ›´æœ‰æ•ˆåœ°åˆ©ç”¨è®­ç»ƒæ•°æ®ï¼Œæé«˜æ¨¡å‹çš„å­¦ä¹ æ•ˆç‡ï¼Œå‡å°‘æ‰€éœ€çš„è®­ç»ƒæ ·æœ¬æ•°é‡ã€‚</li>
</ul>
</section>
<section id="grpo" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> GRPO</h1>
<p>å›é¡¾äº†PPOå’ŒDPOåœ¨LLMæ¨ç†RLä¸Šçš„å±€é™åï¼Œæˆ‘ä»¬æ¥çœ‹GRPO<span class="citation" data-cites="DeepSeekMathPushingLimits2024shao">(<a href="#ref-DeepSeekMathPushingLimits2024shao" role="doc-biblioref">Shao et al. 2024</a>)</span>ã€‚GRPOä¸PPOçš„ä¸»è¦æµç¨‹ä¸åŒºåˆ«å¦‚ä¸‹ï¼š</p>
<div id="fig-grpo-ppo" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-grpo-ppo-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="assets/lec16-grpo-ppo.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-grpo-ppo-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: å¯¹æ¯”äº† PPO ä¸ GRPO çš„è®­ç»ƒæµç¨‹å·®å¼‚ï¼š <br>ä¸ŠåŠéƒ¨åˆ†ï¼ˆPPOï¼‰ä¸­ï¼Œç­–ç•¥æ¨¡å‹åœ¨ç”Ÿæˆå•ä¸ªè¾“å‡º <span class="math inline">\(o\)</span> åï¼Œåˆ†åˆ«é€šè¿‡<em>Reward Model</em>ä¸<em>Reference Model</em>å¾—åˆ°Reward <span class="math inline">\(r\)</span> ä¸ KL çº¦æŸï¼Œå¹¶ä¾èµ–<em>Value Model</em>é¢„æµ‹çš„çŠ¶æ€ä»·å€¼ <span class="math inline">\(v\)</span>ï¼Œå†ç”¨ GAE è®¡ç®—ä¼˜åŠ¿ A æ¥æ›´æ–°ç­–ç•¥ï¼› <br>ä¸‹åŠéƒ¨åˆ†ï¼ˆGRPOï¼‰ä¸­ï¼Œç­–ç•¥æ¨¡å‹å¯¹åŒä¸€æç¤º <span class="math inline">\(q\)</span> ä¸€æ¬¡æ€§é‡‡æ ·ä¸€ç»„è¾“å‡º <span class="math inline">\(\{o_1,\dots,o_G\}\)</span>ï¼Œä»…ä¾èµ–å†»ç»“çš„Reward Modelä¸Reference Modelå¾—åˆ°ç»„å†…å¥–åŠ± <span class="math inline">\(\{r_1, r_2, \dots, r_G\}\)</span>ï¼Œé€šè¿‡ç»„å†…ç›¸å¯¹è®¡ç®—ï¼ˆGroup Computationï¼‰ç›´æ¥æ„é€ ä¼˜åŠ¿ <span class="math inline">\(\{A_1, A_2, \dots, A_G\}\)</span>ï¼Œä»è€Œä¸å†éœ€è¦ä»·å€¼æ¨¡å‹ä¸ GAEï¼Œä»¥æ›´ç®€åŒ–çš„ç»“æ„å®Œæˆå¸¦ KL çº¦æŸçš„ç­–ç•¥æ›´æ–°ã€‚
</figcaption>
</figure>
</div>
<p>ä» <a href="#fig-grpo-ppo" class="quarto-xref">Figure&nbsp;2</a> å¯ä»¥çœ‹å‡ºï¼ŒGRPOä¸PPOç±»ä¼¼ï¼Œä¸»è¦çš„åŒºåˆ«åœ¨äº<strong>Advantage Estimator</strong>çš„è®¾è®¡ã€‚ ä¸è¿‡ï¼Œåœ¨äº†è§£Advantage Estimatorä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹GRPOçš„ç›®æ ‡å‡½æ•°.</p>
<section id="grpo-objective" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="grpo-objective"><span class="header-section-number">3.1</span> GRPO Objective</h2>
<p>GRPO çš„ç›®æ ‡å‡½æ•°å¦‚ä¸‹ï¼š <span id="eq-grpo"><span class="math display">\[
\mathcal{J}_{\text{GRPO}}(\pi_\theta) = \frac{1}{G}\sum_{i=1}^{G}
\textcolor{red}{\frac{1}{|o_i|}} \sum_{t = 1}^{|o_i|}
\Bigg\{
\min \Big[
     \rho(o_{i,t}) \hat{A}_{i, t},
     \text{clip}\Big(
            \rho(o_{i,t}), 1 - \epsilon_{\text{clip}}, 1 + \epsilon_{\text{clip}}
        \Big) \hat{A}_{i, t}
    \Big]    
\Bigg\} + \textcolor{gray}{\beta \, \text{KL}\big(\pi_\theta || \pi_{\text{ref}}\big)}
\tag{1}\]</span></span></p>
<p>å…¶ä¸­ï¼š</p>
<p><span id="eq-importance-ratio"><span class="math display">\[
\rho(o_{i,t}) = \frac{\pi_\theta(o_{i,t}|q, o_{i,&lt;t})}{\pi_{\text{ref}}(o_{i,t}|q, o_{i,&lt;t})}
\tag{2}\]</span></span></p>
<p>æ˜¯<strong>importance sampling ratio</strong>ï¼Œç”¨æ¥æŠŠå½“å‰ç­–ç•¥å’Œreference policyè”ç³»èµ·æ¥ã€‚</p>
<p><span class="math inline">\(\textcolor{gray}{\beta \, \text{KL}\big(\pi_\theta || \pi_{\text{ref}}\big)}\)</span> æ˜¯ KL penaltyï¼Œç”¨æ¥<u>é˜²æ­¢å½“å‰ç­–ç•¥åç¦»å‚è€ƒç­–ç•¥å¤ªè¿œ</u>ã€‚(ä¸è¿‡åœ¨å®é™…çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šå¿½ç•¥è¿™ä¸ªKL penalityï¼Œå› ä¸ºGRPOçš„é‡‡æ ·æœ¬èº«å°±æ˜¯ä»å‚è€ƒç­–ç•¥é‡‡æ ·çš„ï¼Œæ‰€ä»¥åç¦»ä¸ä¼šå¤ªå¤§)</p>
<p>å¯¹æ¯ä¸ª prompt é‡‡æ ·ä¸€ç»„ï¼ˆgroupï¼‰å›ç­”,</p>
<ol type="1">
<li>ç”¨<strong>ç»„å†…ç›¸å¯¹å¥–åŠ±</strong>å½“ advantageï¼ˆåŸºçº¿ï¼‰ï¼Œ</li>
<li>å†åš policy-gradient æ›´æ–°ï¼ŒåŒæ—¶ç”¨ KL çº¦æŸä¸è¦åç¦»å‚è€ƒç­–ç•¥( ä¸è¿‡åœ¨å®é™…å®ç°ä¸­ï¼ŒKL penaltyæ˜¯åŠ åœ¨lossé‡Œï¼Œè€Œä¸æ˜¯ç¡¬çº¦æŸ )ã€‚</li>
</ol>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Pythonä»£ç å®ç°ï¼š</p>
<div class="sourceCode" id="cb1" data-code-line-numbers=""><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">def</span> compute_loss_grpo(</span>
<span id="cb1-2"><a href="#cb1-2"></a>    log_probs: torch.Tensor,      <span class="co"># (B, G, T) log probs under current policy</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>    old_log_probs: torch.Tensor,  <span class="co"># (B, G, T) log probs under old policy (detached)</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>    response_mask: torch.Tensor,  <span class="co"># (B, G, T) mask for valid response tokens</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>    advantage: torch.Tensor,    <span class="co"># (B, G) advantage per response</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>    clip_range: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span id="cb1-7"><a href="#cb1-7"></a>):</span>
<span id="cb1-8"><a href="#cb1-8"></a>    B, G, T <span class="op">=</span> log_probs.size()</span>
<span id="cb1-9"><a href="#cb1-9"></a></span>
<span id="cb1-10"><a href="#cb1-10"></a>    important_ratio <span class="op">=</span> torch.exp(log_probs <span class="op">-</span> old_log_probs)  <span class="co"># (B, G, T)</span></span>
<span id="cb1-11"><a href="#cb1-11"></a></span>
<span id="cb1-12"><a href="#cb1-12"></a>    <span class="co"># Broadcast advantage to token level</span></span>
<span id="cb1-13"><a href="#cb1-13"></a>    advantage_tok <span class="op">=</span> advantage.unsqueeze(<span class="op">-</span><span class="dv">1</span>).expand_as(important_ratio)  <span class="co"># (B, G, T)</span></span>
<span id="cb1-14"><a href="#cb1-14"></a></span>
<span id="cb1-15"><a href="#cb1-15"></a>    unclipped <span class="op">=</span> important_ratio <span class="op">*</span> advantage_tok</span>
<span id="cb1-16"><a href="#cb1-16"></a>    clipped <span class="op">=</span> torch.clamp(important_ratio, <span class="dv">1</span> <span class="op">-</span> clip_range, <span class="dv">1</span> <span class="op">+</span> clip_range) <span class="op">*</span> advantage_tok</span>
<span id="cb1-17"><a href="#cb1-17"></a></span>
<span id="cb1-18"><a href="#cb1-18"></a>    pg_loss_tok <span class="op">=</span> <span class="op">-</span>torch.<span class="bu">min</span>(unclipped, clipped)  <span class="co"># (B, G, T)</span></span>
<span id="cb1-19"><a href="#cb1-19"></a></span>
<span id="cb1-20"><a href="#cb1-20"></a>    <span class="co"># Length normalization (GRPO does this)</span></span>
<span id="cb1-21"><a href="#cb1-21"></a>    len_per_response <span class="op">=</span> response_mask.<span class="bu">sum</span>(dim<span class="op">=-</span><span class="dv">1</span>)  <span class="co"># (B, G)</span></span>
<span id="cb1-22"><a href="#cb1-22"></a>    pg_loss_tok <span class="op">=</span> pg_loss_tok <span class="op">*</span> response_mask  <span class="co"># mask out non-response tokens</span></span>
<span id="cb1-23"><a href="#cb1-23"></a>    pg_loss_seq <span class="op">=</span> pg_loss_tok.<span class="bu">sum</span>(dim<span class="op">=-</span><span class="dv">1</span>) <span class="op">/</span> len_per_response  <span class="co"># (B, G)</span></span>
<span id="cb1-24"><a href="#cb1-24"></a></span>
<span id="cb1-25"><a href="#cb1-25"></a>    <span class="co"># Final loss: mean over batch and group</span></span>
<span id="cb1-26"><a href="#cb1-26"></a>    loss <span class="op">=</span> pg_loss_seq.<span class="bu">sum</span>()</span>
<span id="cb1-27"><a href="#cb1-27"></a>    loss <span class="op">=</span> loss <span class="op">/</span> (B <span class="op">*</span> G)</span>
<span id="cb1-28"><a href="#cb1-28"></a>    <span class="co"># loss = pg_loss_seq.mean()  # alternative: mean over all tokens</span></span>
<span id="cb1-29"><a href="#cb1-29"></a></span>
<span id="cb1-30"><a href="#cb1-30"></a>    <span class="cf">return</span> loss</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>å…·ä½“çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬ä¼šæŠŠ<strong>æŒ‰å›ç­”é•¿åº¦å½’ä¸€åŒ–</strong>ï¼ˆ<code>pg_loss_seq = pg_loss_tok.sum(dim=-1) / len_per_response</code>ï¼‰ï¼Œè¿™æ˜¯GRPOçš„ä¸€ä¸ªå…³é”®è®¾è®¡ï¼Œæˆ‘ä»¬åé¢ä¼šé‡ç‚¹è®²ã€‚</p>
</section>
<section id="advantage-calculation-in-grpo" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="advantage-calculation-in-grpo"><span class="header-section-number">3.2</span> Advantage Calculation in GRPO</h2>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬é‡ç‚¹çœ‹çœ‹ GRPO çš„ Advantage è®¡ç®—ï¼š</p>
<ul>
<li>å¯¹æ¯ä¸ª promptï¼ˆæ¯”å¦‚ä¸€é“æ•°å­¦é¢˜ï¼‰ï¼š<br>
</li>
<li>é‡‡æ · <strong>G ä¸ªå›ç­”</strong>ï¼š<span class="math inline">\(\{y_1, y_2, \dots, y_G\}\)</span></li>
<li>è¿™ä¸ª prompt å°±æ˜¯ä¸€ç»„ï¼ˆgroupï¼‰ï¼Œç»„å†…å›ç­”å…±äº«åŒä¸€éš¾åº¦, å¹¶ä¸”æœ‰äº† <span class="math inline">\(\{(p, y_1, r_1), (p, y_2, r_2), \dots, (p, y_G, r_G)\}\)</span>ï¼Œå…¶ä¸­ <span class="math inline">\(r_i\)</span> æ˜¯å›ç­” <span class="math inline">\(y_i\)</span> çš„å¥–åŠ±ã€‚</li>
</ul>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡<strong>ç»„å†…ç»Ÿè®¡é‡</strong>ï¼Œæ¥è®¡ç®— Advantageï¼š <span id="eq-grpo-advantage"><span class="math display">\[
\hat{A}_{i, t}=\frac{r_i-\mu}{\sigma + \epsilon } \quad \text{where} \quad \mu=\frac{1}{G}\sum_{j=1}^{G} r_j, \quad \sigma=\sqrt{\frac{1}{G}\sum_{j=1}^{G}(r_j-\mu)^2}
\tag{3}\]</span></span></p>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li>ç”¨ <strong>ç»„å†…å‡å€¼ <span class="math inline">\(\mu\)</span></strong> å½“ baselineï¼ˆåæ˜ é¢˜ç›®éš¾åº¦ï¼‰</li>
<li>ç”¨ <strong>ç»„å†…æ–¹å·® <span class="math inline">\(\sigma\)</span></strong> åšå½’ä¸€åŒ–ï¼ˆæ§åˆ¶æ›´æ–°å°ºåº¦ï¼‰</li>
<li><span class="math inline">\(\epsilon\)</span> æ˜¯ä¸€ä¸ªå°å¸¸æ•°ï¼Œé˜²æ­¢é™¤é›¶</li>
</ul>
<p>å…¶ä¸­ï¼Œ<span class="math inline">\(\hat{A}_{i, t}\)</span> æ˜¯å›ç­” <span class="math inline">\(y_i\)</span> åœ¨æ—¶é—´æ­¥ <span class="math inline">\(t\)</span> çš„ advantage, ä¹Ÿå°±æ˜¯æ¯ä¸ªaction(token <span class="math inline">\(o_{i,t}\)</span>) å¯¹åº”çš„ Advantage, åœ¨GRPOä¸­ï¼Œ<strong>åŒä¸€ä¸ªå›ç­” <span class="math inline">\(y_i\)</span> çš„æ‰€æœ‰tokenå…±äº«åŒä¸€ä¸ª advantageå€¼</strong>ã€‚</p>
<div class="sourceCode" id="cb2" data-code-line-numbers=""><pre class="sourceCode numberSource Python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">def</span> compute_advantage(</span>
<span id="cb2-2"><a href="#cb2-2"></a>    rewards: torch.Tensor,  <span class="co"># (B, G)</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>    epsilon: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1e-4</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>):</span>
<span id="cb2-5"><a href="#cb2-5"></a>    mu <span class="op">=</span> rewards.mean(dim<span class="op">=</span><span class="dv">1</span>, keepdim<span class="op">=</span><span class="va">True</span>)  <span class="co"># (B, 1)</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>    sigma <span class="op">=</span> rewards.std(dim<span class="op">=</span><span class="dv">1</span>, keepdim<span class="op">=</span><span class="va">True</span>)  <span class="co"># (B, 1)</span></span>
<span id="cb2-7"><a href="#cb2-7"></a></span>
<span id="cb2-8"><a href="#cb2-8"></a>    advantage <span class="op">=</span> (rewards <span class="op">-</span> mu) <span class="op">/</span> (sigma <span class="op">+</span> epsilon)  <span class="co"># (B, G)</span></span>
<span id="cb2-9"><a href="#cb2-9"></a>    <span class="cf">return</span> advantage</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="grpo-algorithm" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="grpo-algorithm"><span class="header-section-number">3.3</span> GRPO Algorithm</h2>
<p>äº†è§£äº†GRPOçš„Objective Function (<a href="#eq-grpo" class="quarto-xref">Equation&nbsp;1</a>) å’ŒAdvantageè®¡ç®—(<a href="#eq-grpo-advantage" class="quarto-xref">Equation&nbsp;3</a>) åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹GRPOçš„æ•´ä½“ç®—æ³•æµç¨‹ï¼š</p>
<div id="algo-grpo" class="pseudocode-container quarto-float" data-caption-prefix="Algorithm" data-indent-size="1.2em" data-line-number="true" data-line-number-punc=":" data-comment-delimiter="#" data-pseudocode-number="1" data-no-end="false">
<div class="pseudocode">
\begin{algorithm} \caption{Iterative Group Relative Policy Optimization (GRPO)}\begin{algorithmic} \Require initial policy model $\pi_{\theta_{\text{init}}}$; reward model(s) $r_\phi$; task prompts $\mathcal{D}$; hyperparameters $\epsilon, \beta, \mu$; group size $G$; iterations $I$; steps $M$ \Ensure trained policy $\pi_\theta$ \State $\pi_\theta \gets \pi_{\theta_{\text{init}}}$ \For{$\text{iteration} = 1, \ldots, I$} \State $\pi_{\text{ref}} \gets \pi_\theta$ \Comment{reference (anchor) policy} \For{$\text{step} = 1, \ldots, M$} \State Sample a batch $\mathcal{D}_b$ from $\mathcal{D}$ \State $\pi_{\theta_{\text{old}}} \gets \pi_\theta$ \Comment{snapshot old policy} \ForAll{$q \in \mathcal{D}_b$} \State Sample $G$ outputs $\{o_i\}_{i=1}^{G} \sim \pi_{\theta_{\text{old}}}(\cdot \mid q)$ \State Compute rewards $\{r_i\}_{i=1}^{G}$ by $r_i \gets r_\phi(q, o_i)$ \State Compute group-relative advantages $\{\hat{A}_{i,t}\}$ for each token $t$ in each $o_i$ \EndFor \For{$\text{GRPO-iter} = 1, \ldots, \mu$} \State Update $\pi_\theta$ by maximizing the GRPO objective \EndFor \State Update $r_\phi$ via continuous training using a replay mechanism \EndFor \EndFor \State \Return $\pi_\theta$ \end{algorithmic} \end{algorithm}
</div>
</div>
<p>å¯¹äºæ¯æ¬¡è¿­ä»£ï¼š</p>
<ul>
<li>å…ˆæŠŠå½“å‰ç­–ç•¥ <span class="math inline">\(\pi_\theta\)</span> ä½œä¸ºå‚è€ƒç­–ç•¥ <span class="math inline">\(\pi_{\text{ref}}\)</span>ï¼ˆanchor policyï¼‰</li>
<li>ç„¶åï¼Œå¯¹äºæ¯ä¸ª prompt <span class="math inline">\(q\)</span>ï¼š
<ul>
<li>ä»æ—§ç­–ç•¥ <span class="math inline">\(\pi_{\theta_{\text{old}}}\)</span> é‡‡æ · <span class="math inline">\(G\)</span> æ¡å›ç­” <span class="math inline">\(\{o_i\}\)</span></li>
<li>è®¡ç®—æ¯æ¡å›ç­”çš„å¥–åŠ± <span class="math inline">\(\{r_i\}\)</span>ï¼ˆé€šè¿‡å¥–åŠ±æ¨¡å‹ï¼‰</li>
<li>è®¡ç®—ç»„å†…ç›¸å¯¹ä¼˜åŠ¿ <span class="math inline">\(\{\hat{A}_{i,t}\}\)</span></li>
<li>æœ€åï¼Œç”¨ GRPO ç›®æ ‡å‡½æ•°æ›´æ–°ç­–ç•¥ <span class="math inline">\(\pi_\theta\)</span></li>
</ul></li>
</ul>
<p>è¿™ç§è®¾è®¡é¿å…äº† PPO é‡Œå¯¹ Value Function çš„ä¾èµ–ï¼Œä»è€Œç®€åŒ–äº†è®­ç»ƒæµç¨‹ï¼Œ åŒæ—¶æˆ‘ä»¬çœ‹åˆ°ï¼Œå¯¹äºæ¯ä¸ªRolloutï¼Œæˆ‘ä»¬åªæ›´æ–°ä¸€æ¬¡ç­–ç•¥(<strong>On-Policy</strong>)ï¼Œè€Œä¸æ˜¯å¤šæ¬¡ï¼Œè¿™ä¹Ÿé™ä½äº†å®ç°å¤æ‚åº¦ã€‚ï¼ˆä¸è¿‡è¿™ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„Trade-Offï¼Œæˆ‘ä»¬å¯ä»¥å¯¹äºåŒä¸€ç»„æ•°æ®å¤šæ¬¡æ›´æ–°ç­–ç•¥ï¼ˆ<strong>Off-Policy</strong>ï¼‰ï¼Œä»è€Œæå‡æ ·æœ¬æ•ˆç‡ï¼Œä½†ä¼šå¢åŠ å®ç°å¤æ‚åº¦ï¼‰</p>
</section>
<section id="bias-in-grpo" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="bias-in-grpo"><span class="header-section-number">3.4</span> Bias in GRPO</h2>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥è‡ªå·±åˆ†æä¸€ä¸‹GRPOçš„Objective Function (<a href="#eq-grpo" class="quarto-xref">Equation&nbsp;1</a>) ï¼Œå¯ä»¥å‘ç°ï¼Œå®ƒå…¶å®å­˜åœ¨ä¸¤ä¸ªBiasï¼š</p>
<ul>
<li><strong>Biased Gradient</strong>ï¼šGRPOçš„æ¢¯åº¦ä¼°è®¡æ˜¯æœ‰åçš„</li>
<li><strong>Length Normalization Bias</strong>ï¼šæŒ‰å›ç­”é•¿åº¦å½’ä¸€åŒ–å¼•å…¥çš„åç½®</li>
</ul>
<p>æˆ‘ä»¬æ¥å…·ä½“åˆ†æä¸€ä¸‹è¿™ä¸¤ä¸ªBiasã€‚</p>
<div id="fig-bias-grpo-overview" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-bias-grpo-overview-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/bias-grpo-overview.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-bias-grpo-overview-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: è¯¥å›¾å±•ç¤ºäº† GRPO çš„ä¸¤ç±»ä¼˜åŒ–åç½®ï¼šå¯¹åŒä¸€é—®é¢˜ <span class="math inline">\(q\)</span> é‡‡æ ·å¤šæ¡å›ç­” <span class="math inline">\(o_i\)</span> åï¼ŒGRPO çš„â€œæœ‰æ•ˆ advantageâ€æ»¡è¶³ <span class="math inline">\(a_{i,t}=\frac{1}{\mathrm{std}(R)}\cdot \frac{\tilde A_{i,t}}{|o_i|}\)</span>ï¼Œå…¶ä¸­ <span class="math inline">\(\tilde A_{i,t}=R(q,o_i)-\mathrm{mean}(R)\)</span> æ˜¯ç»„å†…ä¸­å¿ƒåŒ–ï¼ˆç›¸å¯¹ï¼‰å¥–åŠ±ï¼›ç”±äºé¢å¤–é™¤ä»¥ç»„å†…å¥–åŠ±æ ‡å‡†å·® <span class="math inline">\(\mathrm{std}(R)\)</span> ä¸å›ç­”é•¿åº¦ <span class="math inline">\(|o_i|\)</span>ï¼Œè®­ç»ƒä¼šå¯¹<strong>ä¸åŒé—®é¢˜ä¸ä¸åŒé•¿åº¦å›ç­”æ–½åŠ ä¸åŒæƒé‡</strong>ï¼š<tag style="color:blue">è“è‰²åœ†ç‚¹å¤§å°è¡¨ç¤º <span class="math inline">\(1/\mathrm{std}(R)\)</span> å¯¹â€œé—®é¢˜çº§â€æ›´æ–°å¼ºåº¦çš„ç¼©æ”¾</tag>ï¼Œ<tag style="color:orange">æ©™è‰²ç®­å¤´é•¿åº¦è¡¨ç¤º <span class="math inline">\(\tilde A_{i,t}/|o_i|\)</span> å¯¹â€œå›ç­”çº§â€æ›´æ–°å¹…åº¦çš„ç¼©æ”¾ï¼ˆç®­å¤´å‘ä¸Šä¸ºæ­£ advantageã€å‘ä¸‹ä¸ºè´Ÿï¼‰ï¼Œä»è€Œä½¿ä¼˜åŒ–åå‘æŸäº›é¢˜ç›®ä¸æŸäº›é•¿åº¦çš„è¾“å‡º</tag>ã€‚
</figcaption>
</figure>
</div>
<section id="biased-gradient" class="level3" data-number="3.4.1">
<h3 data-number="3.4.1" class="anchored" data-anchor-id="biased-gradient"><span class="header-section-number">3.4.1</span> Biased Gradient</h3>
<p>ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯ GRPO çš„æ¢¯åº¦ä¼°è®¡æ˜¯<strong>biased</strong>ï¼Œè¿™ä¸»è¦æ˜¯å› ä¸ºå®ƒä½¿ç”¨äº†<strong>ä¾èµ–é‡‡æ ·ç»“æœçš„ baseline</strong>ã€‚ æˆ‘ä»¬çŸ¥é“ï¼Œè¦ä¿æŒä¸€ä¸ª<strong>un-biased</strong>æ¢¯åº¦ä¼°è®¡ï¼Œbaseline åªèƒ½æ˜¯<strong>ä¸ä¾èµ–åŠ¨ä½œçš„å¸¸æ•°</strong>ï¼Œå®ƒå¯ä»¥æ˜¯Value Functionçš„ä¼°è®¡ï¼Œæˆ–è€…ä¸€ä¸ªå¸¸æ•°ï¼Œä½†ä¸èƒ½æ˜¯<strong>ä¾èµ–é‡‡æ ·ç»“æœçš„é‡</strong>ã€‚</p>
<p>å…·ä½“æ¥è¯´ï¼š</p>
<p>Policy Gradient Theorem å‘Šè¯‰æˆ‘ä»¬ï¼Œ<strong>ç­–ç•¥æ¢¯åº¦</strong>æ˜¯ï¼š <span id="eq-policy-gradient-theorem"><span class="math display">\[
\nabla_\theta J(\pi_\theta) = \mathbb{E}_{ y \sim \pi_\theta(\cdot|x)} \Big[ \textcolor{green}{r(x, y)} \nabla_\theta \log \pi_\theta(y|x) \Big]
\tag{4}\]</span></span></p>
<div class="note foldable is-open">
<div class="note-header foldable-header">
<p>NOTE</p>
</div>
<div class="note-container foldable-content">
<p>åœ¨è¿™é‡Œï¼Œ<span class="math inline">\(x\)</span> æ˜¯ç¯å¢ƒçŠ¶æ€ï¼ˆåœ¨LLMä¸­æ˜¯promptï¼‰ï¼Œ<span class="math inline">\(y\)</span> æ˜¯åŠ¨ä½œï¼ˆåœ¨LLMä¸­æ˜¯tokenåºåˆ—ï¼‰ï¼Œ<span class="math inline">\(r(x,y)\)</span> æ˜¯å¥–åŠ±å‡½æ•°ï¼Œ<span class="math inline">\(\pi_\theta(y|x)\)</span> æ˜¯ç­–ç•¥ï¼ˆåœ¨LLMä¸­æ˜¯è¯­è¨€æ¨¡å‹ï¼‰ã€‚ ä¸ºäº†ç®€åŒ–èµ·è§ï¼Œæˆ‘ä»¬å¿½ç•¥äº†çŠ¶æ€åˆ†å¸ƒ <span class="math inline">\(D\)</span>ï¼Œå‡è®¾ <span class="math inline">\(x\)</span> æ˜¯å›ºå®šçš„ã€‚å®é™…ä¸­ï¼Œæˆ‘ä»¬ä¼šå¯¹ <span class="math inline">\(x\)</span> ä¹Ÿå–æœŸæœ›ï¼š <span class="math display">\[
\nabla_\theta J(\pi_\theta) = \mathbb{E}_{\textcolor{red}{x \sim D}, y \sim \pi_\theta(\cdot|x)} \Big[ r(x, y) \nabla_\theta \log \pi_\theta(y|x) \Big]
\]</span></p>
</div>
</div>
<p>å¦‚æœæˆ‘ä»¬å¼•å…¥ä¸€ä¸ª baseline <span class="math inline">\(b(x)\)</span>ï¼Œå¹¶ä¸”å®ƒ<strong>ä¸ä¾èµ–åŠ¨ä½œ</strong>ï¼Œé‚£ä¹ˆæ¢¯åº¦å˜æˆï¼š <span id="eq-policy-gradient-with-baseline"><span class="math display">\[
\nabla_\theta J(\pi_\theta) = \mathbb{E}_{ y \sim \pi_\theta(\cdot|x)} \Big[  \textcolor{green}{\Big(r(x, y) - b(x)\Big)} \nabla_\theta \log \pi_\theta(y|x) \Big]
\tag{5}\]</span></span></p>
<p>åªè¦ <span class="math inline">\(b(x)\)</span> ä¸ä¾èµ– <span class="math inline">\(y\)</span>ï¼ˆaction, åœ¨LLMä¸­å°±æ˜¯tokenï¼‰ï¼Œè¿™ä¸ªæ¢¯åº¦ä¼°è®¡å°±æ˜¯un-biasedã€‚</p>
<p><span id="eq-baseline-zero-expectation"><span class="math display">\[
\begin{split}
\mathbb{E}_{y \sim \pi_\theta(\cdot|x)} \Big[ b(x) \nabla_\theta \log \pi_\theta(y|x) \Big]
&amp; = b(x) \mathbb{E}_{y \sim \pi_\theta(\cdot|x)} \Big[  \nabla_\theta \log \pi_\theta(y|x) \Big]  \\
&amp;= b(x) \sum_y \pi_\theta(y|x)\,\nabla_\theta \log \pi_\theta(y|x) \\
&amp;= b(x) \sum_y \nabla_\theta \pi_\theta(y|x) \quad \text{(Log-Derivative Trick)} \\
&amp;= b(x) \nabla_\theta \sum_y \pi_\theta(y|x) \\
&amp;= b(x) \nabla_\theta 1 \\
&amp;= 0  \\
\end{split}
\tag{6}\]</span></span></p>
<p>ä½†æ˜¯ GRPO é‡Œçš„ <span class="math inline">\(\sigma(y_{1:G})\)</span> ä¾èµ–äºç»„å†…æ‰€æœ‰é‡‡æ ·å›ç­”çš„å¥–åŠ± <span class="math inline">\(\{r_1, r_2, \dots, r_G\}\)</span>ï¼Œè€Œè¿™äº›å¥–åŠ±æœ¬èº«åˆä¾èµ–äºé‡‡æ ·å›ç­” <span class="math inline">\(\{y_1, y_2, \dots, y_G\}\)</span>, äºæ˜¯ï¼Œæˆ‘ä»¬çš„æ¢¯åº¦å˜æˆï¼š</p>
<p><span id="eq-grpo-biased-gradient"><span class="math display">\[
\nabla_\theta J(\pi_\theta) = \mathbb{E}_{y_{1:G} \sim \pi_\theta}\Big[\underbrace{\frac{r_i-\mu(y_{1:G})}{\sigma(y_{1:G})}}_{\text{ä¾èµ–é‡‡æ ·}}\,\nabla_\theta\log\pi_\theta(y_i|x)\Big]
\tag{7}\]</span></span></p>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹ï¼Œè¿™ä¸ªæ¢¯åº¦ä¸ºä»€ä¹ˆæ˜¯æœ‰åçš„ï¼š <span id="eq-biased-baseline"><span class="math display">\[
\mathbb E_{y_{1:G}}\left[\frac{r_i-\mu(y_{1:G})}{\sigma(y_{1:G})}\,\nabla_\theta\log\pi_\theta(y_i|x)\right]
\neq
\underbrace{\mathbb E\left[\frac{r_i-\mu(y_{1:G})}{\sigma(y_{1:G})}\right]}_{\text{ä¸èƒ½æå‡ºæ¥}}
\cdot
\underbrace{\mathbb E[\nabla_\theta\log\pi_\theta(y_i|x)]}_{=0}
\tag{8}\]</span></span></p>
<p>å› ä¸º <span class="math inline">\(\frac{r_i-\mu(y_{1:G})}{\sigma(y_{1:G})}\)</span> ä¹Ÿä¾èµ–äºé‡‡æ ·ç»“æœ <span class="math inline">\(y_{1:G}\)</span>ï¼Œæ‰€ä»¥ä¸ <span class="math inline">\(\nabla_\theta\log\pi_\theta(y_i|x)\)</span> ä¸èƒ½<strong>æ‹†å¼€æœŸæœ›</strong>ï¼Œä»è€Œå¯¼è‡´æ¢¯åº¦ä¼°è®¡æœ‰åã€‚</p>
<div class="note foldable is-open">
<div class="note-header foldable-header">
<p>NOTE</p>
</div>
<div class="note-container foldable-content">
<p>å½“ä¸¤ä¸ªéšæœºå˜é‡ <span class="math inline">\(X, Y\)</span> ç‹¬ç«‹æ—¶ï¼Œ<span class="math inline">\(\mathbb{E}[XY] = \mathbb{E}[X] \mathbb{E}[Y]\)</span>ï¼›ä½†å½“ <span class="math inline">\(X, Y\)</span> ä¸ç‹¬ç«‹æ—¶ï¼Œè¿™ä¸ªç­‰å¼ä¸æˆç«‹ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆï¼Œåœ¨ <a href="#eq-baseline-zero-expectation" class="quarto-xref">Equation&nbsp;6</a> ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ <span class="math inline">\(b(x)\)</span> æå‡ºæ¥ï¼Œå› ä¸ºå®ƒä¸ä¾èµ– <span class="math inline">\(y\)</span>ï¼Œæ‰€ä»¥ä¸ <span class="math inline">\(\nabla_\theta \log \pi_\theta(y|x)\)</span> ç‹¬ç«‹ï¼›ä½†åœ¨ <a href="#eq-biased-baseline" class="quarto-xref">Equation&nbsp;8</a> ä¸­ï¼Œ<span class="math inline">\(\frac{r_i-\mu(y_{1:G})}{\sigma(y_{1:G})}\)</span> ä¾èµ–äºé‡‡æ ·ç»“æœ <span class="math inline">\(y_{1:G}\)</span>ï¼Œæ‰€ä»¥ä¸ <span class="math inline">\(\nabla_\theta\log\pi_\theta(y_i|x)\)</span> ä¸ç‹¬ç«‹ï¼Œä¸èƒ½æ‹†å¼€æœŸæœ›ã€‚</p>
</div>
</div>
<p>è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬çš„æ¢¯åº¦ä¼°è®¡å°±<strong>ä¸å†æ˜¯un-biasedçš„</strong>ï¼Œè€Œæ˜¯<strong>è¢«ä¸€ä¸ªä¸é‡‡æ ·ç›¸å…³çš„éšæœºå› å­é‡æ–°åŠ æƒ</strong>äº†ã€‚</p>
<p>Bias ä¸»è¦å‡ºåœ¨äº† <span class="math inline">\(\sigma\)</span> ä¸Šï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å…·ä½“åˆ†æå®ƒå¸¦æ¥çš„å½±å“:</p>
<ul>
<li>å½“æŸä¸ª prompt çš„ group é‡Œ <strong>å¥–åŠ±æ–¹å·®å¾ˆå°</strong>ï¼ˆç»„å†…Rewardå…¨å¯¹æˆ–è€…å…¨é”™ï¼‰æ—¶ï¼Œ<span class="math inline">\(\frac{1}{\sigma}\)</span> ä¼šéå¸¸å¤§ â†’ è¿™ä¸ª prompt å¯¹æ¢¯åº¦æ›´æ–°çš„æƒé‡è¢«<strong>æ”¾å¤§</strong>ã€‚</li>
<li>å½“å¥–åŠ±æ–¹å·®å¤§æ—¶ï¼Œæ›´æ–°è¢«ç¼©å°ã€‚</li>
</ul>
<p>è¿™å°±ä¼šå¯¼è‡´ï¼Œ<strong>è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæ¨¡å‹ä¼šæ›´å…³æ³¨â€œæç«¯é¢˜â€ï¼ˆå…¨å¯¹/å…¨é”™ï¼‰</strong>ï¼Œè€Œä¸æ˜¯â€œä¸­ç­‰éš¾åº¦ã€æœ€èƒ½å­¦åˆ°ä¸œè¥¿çš„é¢˜â€ã€‚</p>
<div class="question foldable">
<div class="question-header foldable-header">
<p>Question: ä¸ºä»€ä¹ˆï¼Œ<span class="math inline">\(\mu\)</span>ï¼ˆç»„å†…å‡å€¼ï¼‰ä¸ä¼šå¸¦æ¥Biaså‘¢ï¼Ÿ</p>
</div>
<div class="question-container foldable-content">
<p>å› ä¸º <span class="math inline">\(\mu\)</span> åªæ˜¯ä¸€ä¸ª<strong>å¹³ç§»</strong>ï¼Œå®ƒä¸ä¼šæ”¹å˜æ¢¯åº¦çš„æƒé‡ï¼Œåªä¼šæ”¹å˜æ¢¯åº¦çš„æ–¹å‘ï¼ˆè®©æ¨¡å‹æ›´å…³æ³¨ç›¸å¯¹æ›´å¥½çš„å›ç­”ï¼‰ã€‚è€Œ <span class="math inline">\(\sigma\)</span> æ˜¯ä¸€ä¸ª<strong>ç¼©æ”¾</strong>ï¼Œå®ƒä¼šæ”¹å˜æ¢¯åº¦çš„æƒé‡ï¼Œä»è€Œå¼•å…¥Biasã€‚</p>
</div>
</div>
</section>
<section id="length-normalization-bias" class="level3" data-number="3.4.2">
<h3 data-number="3.4.2" class="anchored" data-anchor-id="length-normalization-bias"><span class="header-section-number">3.4.2</span> Length Normalization Bias</h3>
<p>åœ¨ <a href="#eq-grpo" class="quarto-xref">Equation&nbsp;1</a> ä¸­ï¼Œæœ‰ä¸€ä¸ª <strong>æŒ‰å›ç­”é•¿åº¦å½’ä¸€åŒ–</strong> çš„é¡¹ <span class="math inline">\(\frac{1}{|o_i|}\)</span>ï¼Œä¹Ÿå°±æ˜¯æŠŠæ¯æ¡å›ç­”çš„ token-loss å¹³å‡åŒ–ã€‚</p>
<p>è¿™ä¼šå¸¦æ¥<strong>response-level length bias</strong>ï¼šå½“æŠŠä¸€æ¡å›ç­”çš„æ¢¯åº¦æŒ‰é•¿åº¦å¹³å‡æ—¶ï¼Œä¼šæ”¹å˜â€œåŒæ ·ä¸€æ¡å›ç­”â€åœ¨ä¼˜åŒ–ä¸­çš„æœ‰æ•ˆæƒé‡ã€‚ï¼ˆå¾ˆæŠ½è±¡å¯¹ä¸å¯¹ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸¤ä¸ªå…·ä½“æƒ…å†µï¼‰</p>
<ol type="1">
<li><p><strong>ä¼˜åŠ¿ä¸ºæ­£ï¼ˆç­”å¯¹/æ›´å¥½ï¼Œ<span class="math inline">\(\hat{A} &gt; 0\)</span>ï¼‰</strong> åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ›´æ–°æ–¹å‘æ˜¯â€œæé«˜è¿™æ¡å›ç­”æ¦‚ç‡â€ï¼Œä½†é™¤ä»¥å›ç­”é•¿åº¦ <span class="math inline">\(|o_i|\)</span>ï¼Œè¿™æ„å‘³ç€<strong>è¶ŠçŸ­çš„å›ç­”ï¼Œå•ä½é•¿åº¦çš„æ¢¯åº¦è¶Šå¤§</strong>ï¼Œ æ¯ä¸ª token çš„è´¡çŒ®æ›´å¤§ã€‚äºæ˜¯ï¼Œæ¨¡å‹å­¦åˆ°ï¼š<strong>æ­£ç¡®ç­”æ¡ˆè¦å°½é‡çŸ­</strong>ï¼ˆå› ä¸ºæ›´â€œåˆ’ç®—â€ï¼‰ã€‚</p></li>
<li><p><strong>ä¼˜åŠ¿ä¸ºè´Ÿï¼ˆç­”é”™/æ›´å·®ï¼Œ<span class="math inline">\(\hat{A} &lt; 0\)</span>ï¼‰</strong> åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ›´æ–°æ–¹å‘æ˜¯â€œé™ä½è¿™æ¡å›ç­”æ¦‚ç‡â€ï¼ˆæƒ©ç½šï¼‰ï¼Œä½†é™¤ä»¥å›ç­”é•¿åº¦ <span class="math inline">\(|o_i|\)</span>ï¼Œè¿™æ„å‘³ç€<strong>è¶Šé•¿çš„å›ç­”ï¼Œæƒ©ç½šè¢«æ‘Šè–„</strong>ï¼Œæ¯ä¸ª token çš„è´Ÿæ›´æ–°æ›´å°ã€‚äºæ˜¯ï¼Œæ¨¡å‹å­¦åˆ°ï¼š<strong>é”™è¯¯ç­”æ¡ˆåè€Œæ›´æ„¿æ„å†™é•¿</strong>ï¼ˆå› ä¸ºâ€œå—ç½šæ›´è½»â€ï¼‰ã€‚</p></li>
</ol>
<p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæœ‰æ—¶å€™CoTè¶Šæ¥è¶Šé•¿ï¼Œä½†æ˜¯Rewardè¿˜æ˜¯ä¸å‡åé™çš„ç°è±¡â€”â€”æ¨¡å‹å­¦ä¼šäº†é€šè¿‡è¾“å‡ºæ›´é•¿çš„å›ç­”æ¥â€œè§„é¿æƒ©ç½šâ€ï¼Œè€Œä¸æ˜¯é€šè¿‡æé«˜å›ç­”è´¨é‡æ¥è·å¾—æ›´é«˜çš„å¥–åŠ±ã€‚</p>
<div id="fig-deepseek-r1-length-bias" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-deepseek-r1-length-bias-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/deepseek-r1-length-bias.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-deepseek-r1-length-bias-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: è¯¥å¼ å›¾å±•ç¤ºäº† DeepSeek-R1-Zero åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæ¨¡å‹å¹³å‡æ¯æ¡å›ç­”é•¿åº¦éšè®­ç»ƒæ­¥æ•°çš„å˜åŒ–ã€‚æ¨ªè½´æ˜¯è®­ç»ƒæ­¥æ•°ï¼ˆStepsï¼‰ï¼Œçºµè½´æ˜¯å¹³å‡æ¯æ¡ response çš„é•¿åº¦ï¼ˆtoken æ•°ï¼‰ã€‚å¯ä»¥çœ‹åˆ°ï¼Œéšç€è®­ç»ƒæ¨è¿›ï¼Œæ¨¡å‹è¾“å‡ºé•¿åº¦å‘ˆæŒç»­ä¸Šå‡è¶‹åŠ¿ï¼šä»è®­ç»ƒåˆæœŸçš„å‡ ç™¾åˆ°ä¸Šåƒ tokenï¼Œé€æ­¥å¢é•¿åˆ°åæœŸçš„ä¸€ä¸‡ç”šè‡³æ¥è¿‘ä¸¤ä¸‡ tokenï¼ŒåŒæ—¶æ³¢åŠ¨å¹…åº¦ä¹Ÿæ˜æ˜¾æ‰©å¤§ã€‚è¿™ä¸€ç°è±¡ç›´è§‚åæ˜ äº† R1-Zero åœ¨ä»…ä½¿ç”¨å¯éªŒè¯å¥–åŠ±è¿›è¡Œå¼ºåŒ–å­¦ä¹ æ—¶ï¼Œæ¨¡å‹å€¾å‘äºç”Ÿæˆè¶Šæ¥è¶Šé•¿çš„æ¨ç†é“¾ï¼ˆCoTï¼‰ï¼Œä½“ç°å‡ºå…¸å‹çš„â€œé•¿åº¦è†¨èƒ€â€è¡Œä¸ºï¼Œè€Œä¸ä¸€å®šå¯¹åº”æ›´é«˜çš„å®é™…è§£é¢˜æ•ˆç‡ã€‚
</figcaption>
</figure>
</div>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ Dr.GRPO<span class="citation" data-cites="UnderstandingR1ZeroLikeTraining2025liu">(<a href="#ref-UnderstandingR1ZeroLikeTraining2025liu" role="doc-biblioref">Liu et al. 2025</a>)</span> æ˜¯å¦‚ä½•è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜çš„ã€‚</p>
</section>
</section>
<section id="dr.grpo" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="dr.grpo"><span class="header-section-number">3.5</span> Dr.GRPO</h2>
<p>Dr.GRPO æ˜¯ GRPO çš„ä¸€ä¸ªå˜ä½“ï¼Œè§£å†³äº†ä¸Šé¢æåˆ°çš„ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li><strong>å»æ‰ <span class="math inline">\(\frac{1}{\sigma}\)</span></strong>ï¼Œé¿å… biased gradient</li>
<li><strong>å»æ‰æŒ‰å›ç­”é•¿åº¦å½’ä¸€åŒ–</strong>ï¼Œé¿å…é•¿åº¦åç½®</li>
</ul>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹æ”¹åŠ¨ä¹‹åçš„ç›®æ ‡å‡½æ•°:</p>
<p><span id="eq-dr-grpo"><span class="math display">\[
\mathcal{J}_{\text{Dr.GRPO}}(\pi_\theta) = \frac{1}{G}\sum_{i=1}^{G}
\sum_{t = 1}^{|o_i|}
\Bigg\{
\min \Big[
     \rho(o_{i,t}) \hat{A}_{i, t},
     \text{clip}\Big(
            \rho(o_{i,t}), 1 - \epsilon_{\text{clip}}, 1 + \epsilon_{\text{clip}}
        \Big) \hat{A}_{i, t}
    \Big]    
\Bigg\}
\tag{9}\]</span></span></p>
<p>å…¶ä¸­ï¼ŒAdvantage å˜æˆï¼š</p>
<p><span id="eq-dr-grpo-advantage"><span class="math display">\[
\hat{A}_{i, t} = r_i - \mu \quad \text{where} \quad \mu = \frac{1}{G}\sum_{j=1}^{G} r_j
\tag{10}\]</span></span></p>
<p>ä¹Ÿå°±æ˜¯åªç”¨ç»„å†…å‡å€¼å½“ baselineï¼Œä¸åšæ–¹å·®å½’ä¸€åŒ–ã€‚</p>
<p>å¦ä¸€ä¸ªæ”¹åŠ¨æ˜¯<strong>å»æ‰äº†æŒ‰å›ç­”é•¿åº¦å½’ä¸€åŒ–</strong>ï¼Œä¹Ÿå°±æ˜¯ä¸å†é™¤ä»¥ <span class="math inline">\(|o_i|\)</span>ï¼Œ ç›´æ¥å¯¹æ‰€æœ‰ token çš„ policy-gradient loss æ±‚å’Œã€‚ ä¸è¿‡åœ¨å®ç°ä¸­ï¼Œä¼šé™¤ä»¥ä¸€ä¸ª<code>MAX_TOKENS</code>ï¼ˆæœ€å¤§tokenæ•°ï¼‰æ¥ç¨³å®šè®­ç»ƒï¼Œä½†è¿™ä¸ªæ˜¯ä¸ªå¸¸æ•°ï¼Œä¸ä¼šå¼•å…¥é•¿åº¦åç½®ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹ä»£ç </p>
<div class="sourceCode" id="cb3" data-code-line-numbers="22,23"><pre class="sourceCode numberSource Python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">def</span> compute_loss_grpo(</span>
<span id="cb3-2"><a href="#cb3-2"></a>    log_probs: torch.Tensor,      <span class="co"># (B, G, T) log probs under current policy</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>    old_log_probs: torch.Tensor,  <span class="co"># (B, G, T) log probs under old policy (detached)</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>    response_mask: torch.Tensor,  <span class="co"># (B, G, T) mask for valid response tokens</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>    advantage: torch.Tensor,    <span class="co"># (B, G) advantage per response</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>    clip_range: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span id="cb3-7"><a href="#cb3-7"></a>    max_tokens: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1024</span>,</span>
<span id="cb3-8"><a href="#cb3-8"></a>):</span>
<span id="cb3-9"><a href="#cb3-9"></a>    B, G, T <span class="op">=</span> log_probs.size()</span>
<span id="cb3-10"><a href="#cb3-10"></a></span>
<span id="cb3-11"><a href="#cb3-11"></a>    important_ratio <span class="op">=</span> torch.exp(log_probs <span class="op">-</span> old_log_probs)  <span class="co"># (B, G, T)</span></span>
<span id="cb3-12"><a href="#cb3-12"></a></span>
<span id="cb3-13"><a href="#cb3-13"></a>    <span class="co"># Broadcast advantage to token level</span></span>
<span id="cb3-14"><a href="#cb3-14"></a>    advantage_tok <span class="op">=</span> advantage.unsqueeze(<span class="op">-</span><span class="dv">1</span>).expand_as(important_ratio)  <span class="co"># (B, G, T)</span></span>
<span id="cb3-15"><a href="#cb3-15"></a></span>
<span id="cb3-16"><a href="#cb3-16"></a>    unclipped <span class="op">=</span> important_ratio <span class="op">*</span> advantage_tok</span>
<span id="cb3-17"><a href="#cb3-17"></a>    clipped <span class="op">=</span> torch.clamp(important_ratio, <span class="dv">1</span> <span class="op">-</span> clip_range, <span class="dv">1</span> <span class="op">+</span> clip_range) <span class="op">*</span> advantage_tok</span>
<span id="cb3-18"><a href="#cb3-18"></a></span>
<span id="cb3-19"><a href="#cb3-19"></a>    pg_loss_tok <span class="op">=</span> <span class="op">-</span>torch.<span class="bu">min</span>(unclipped, clipped)  <span class="co"># (B, G, T)</span></span>
<span id="cb3-20"><a href="#cb3-20"></a></span>
<span id="cb3-21"><a href="#cb3-21"></a>    <span class="co"># Length normalization (GRPO does this)</span></span>
<span id="cb3-22"><a href="#cb3-22"></a>    pg_loss_tok <span class="op">=</span> pg_loss_tok <span class="op">*</span> response_mask  <span class="co"># mask out non-response tokens </span></span>
<span id="cb3-23"><a href="#cb3-23"></a>    pg_loss_seq <span class="op">=</span> pg_loss_tok.<span class="bu">sum</span>(dim<span class="op">=-</span><span class="dv">1</span>) <span class="op">/</span> max_tokens  <span class="co"># (B, G) </span></span>
<span id="cb3-24"><a href="#cb3-24"></a></span>
<span id="cb3-25"><a href="#cb3-25"></a>    <span class="co"># Final loss: mean over batch and group</span></span>
<span id="cb3-26"><a href="#cb3-26"></a>    loss <span class="op">=</span> pg_loss_seq.<span class="bu">sum</span>()</span>
<span id="cb3-27"><a href="#cb3-27"></a>    loss <span class="op">=</span> loss <span class="op">/</span> (B <span class="op">*</span> G)</span>
<span id="cb3-28"><a href="#cb3-28"></a>    <span class="co"># loss = pg_loss_seq.mean()  # alternative: mean over all tokens</span></span>
<span id="cb3-29"><a href="#cb3-29"></a></span>
<span id="cb3-30"><a href="#cb3-30"></a>    <span class="cf">return</span> loss</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-drgrpo-length-norm" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-drgrpo-length-norm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/drgrpo-length-norm.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-drgrpo-length-norm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: ä¸»è¦çœ‹å›¾ä¸­çº¢è‰²éƒ¨åˆ†ï¼ŒDr.GRPOåœ¨é”™è¯¯å›ç­”æ—¶ï¼Œä¸å†æŒ‰é•¿åº¦å½’ä¸€åŒ–ï¼Œè¿™æ ·<strong>é•¿å›ç­”ä¸ä¼šè¢«â€œæƒ©ç½šæ›´è½»â€</strong>ï¼Œä»è€Œé¿å…äº†æ¨¡å‹å­¦ä¼šå†™é•¿é”™è¯¯å›ç­”çš„ç°è±¡ã€‚
</figcaption>
</figure>
</div>
</section>
</section>
<section id="case-studies" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Case Studies</h1>
<p>åœ¨äº†è§£äº†GRPOç®—æ³•åï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•åœ¨å®é™…ä¾‹å­ä¸­åº”ç”¨çš„ï¼ŒåŒ…æ‹¬ DeepSeek-R1ã€Kimi 1.5 å’Œ Qwen 3 ç­‰æ¨¡å‹ã€‚</p>
<section id="deepseek-r1" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="deepseek-r1"><span class="header-section-number">4.1</span> DeepSeek-R1</h2>
<p>DeepSeek-R1 åœ¨2025å¹´æ˜¥èŠ‚æœŸé—´å‘å¸ƒï¼ˆè¿˜è®°å¾—å½“æ—¶é“ºå¤©ç›–åœ°å…¨æ˜¯DeepSeekçš„æ–°é—»ï¼Œè¿‡å¹´éƒ½è¢«å·åˆ°ï¼‰ï¼Œå®ƒæ˜¯ç¬¬ä¸€ä¸ªç”¨ GRPO åšæ•°å­¦æ¨ç†å¼ºåŒ–å­¦ä¹ çš„æ¨¡å‹ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä¸€ä¸‹DeepSeek R1 <span class="citation" data-cites="DeepSeekR1IncentivizingReasoning2025deepseek-ai">(<a href="#ref-DeepSeekR1IncentivizingReasoning2025deepseek-ai" role="doc-biblioref">DeepSeek-AI et al. 2025</a>)</span>æ˜¯å¦‚ä½•è®­ç»ƒçš„ã€‚</p>
<div class="warning foldable is-open">
<div class="warning-header foldable-header">
<p>WARNING: å…³äºDeepSeek-R1 Paperä¸è¯¾å ‚ä¸Šçš„ä¸åŒ</p>
</div>
<div class="warning-container foldable-content">
<p>DeepSeek R1 åœ¨æœ€è¿‘ï¼ˆ2026å¹´1æœˆï¼‰é‡æ–°Releaseäº†å®ƒä»¬æ–°çš„è®­ç»ƒç»†èŠ‚è®ºæ–‡ï¼Œè¯¥ç¬”è®°åŸºäºæœ€æ–°è®ºæ–‡å†…å®¹è¿›è¡Œæ•´ç†ã€‚è€Œè¯¾ç¨‹ä¸­æ˜¯åŸºäºæœ€åˆçš„æŠ€æœ¯æŠ¥å‘Šè¿›è¡Œè®²è§£ï¼ŒäºŒè€…åœ¨ç»†èŠ‚ä¸Šå¯èƒ½å­˜åœ¨å·®å¼‚ã€‚</p>
</div>
</div>
<p>é¦–å…ˆï¼Œæˆ‘çœ‹ä¸€ä¸‹DeepSeek R1çš„æ•´ä½“pipelineï¼š</p>
<div id="fig-deepseek-r1-pipeline" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-deepseek-r1-pipeline-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/deepseek-R1-training-pipeline.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-deepseek-r1-pipeline-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6
</figcaption>
</figure>
</div>
<p>DeepSeek R1 å¹¶ä¸æ˜¯ä¸€æ¬¡æ€§é€šè¿‡å¼ºåŒ–å­¦ä¹ è®­ç»ƒå‡ºæ¥çš„æ¨¡å‹ï¼Œè€Œæ˜¯ä¸€æ¡<strong>å¤šé˜¶æ®µã€é€æ­¥å¢å¼ºæ¨ç†èƒ½åŠ›</strong>çš„è®­ç»ƒæµæ°´çº¿ã€‚</p>
<section id="from-deepseek-v3-to-deepseek-r1-zero" class="level3" data-number="4.1.1">
<h3 data-number="4.1.1" class="anchored" data-anchor-id="from-deepseek-v3-to-deepseek-r1-zero"><span class="header-section-number">4.1.1</span> From DeepSeek-V3 to DeepSeek-R1-Zero</h3>
<p>ä» DeepSeek V3 Base å‡ºå‘ï¼Œç ”ç©¶è€…é¦–å…ˆè¿›è¡Œäº†å‡ ä¹â€œçº¯ RLâ€çš„å®éªŒï¼ˆR1-zeroï¼‰ï¼šä»…åœ¨æ¨ç†ç±» prompt ä¸Šï¼Œç”¨ accuracy ä¸ format è¿™ç±»å¯éªŒè¯çš„ outcome-level å¥–åŠ±è¿›è¡Œå¼ºåŒ–å­¦ä¹ ï¼ŒéªŒè¯ä¸€ä¸ªå…³é”®å‡è®¾â€”â€”åœ¨æ²¡æœ‰ process supervision çš„æƒ…å†µä¸‹ï¼ŒRL æ˜¯å¦è¶³ä»¥æ¿€æ´»æ¨¡å‹çš„æ¨ç†èƒ½åŠ›ã€‚</p>
<blockquote class="blockquote">
<p>Specifically, we apply the RL technique on the DeepSeek-V3 base to train DeepSeek-R1-Zero. During training, we design a straightforward template, to require DeepSeek-R1-Zero to first produce a reasoning process, followed by the final answer. We intentionally limit our constraints to this structural format, avoiding any content-specific biases to ensure that we can accurately observe the modelâ€™s natural progression during the RL process. <cite> DeepSeek-R1: Incentivizing Reasoning Capability in LLMs via Reinforcement Learning, p.4 </cite></p>
</blockquote>
<p>ç»“æœè¡¨æ˜æ¨ç†èƒ½åŠ›ç¡®å®å¯ä»¥è¢«æ¿€å‘ï¼ŒåŒæ—¶å‘ç°äº† â€œaha momentâ€ ç°è±¡ï¼šæ¨¡å‹åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ä¼šçªç„¶å¼€å§‹ç”Ÿæˆæ›´é•¿ã€æ›´å¤æ‚çš„ CoTï¼Œä¼´éšæ¨ç†æ­£ç¡®ç‡çš„æ˜¾è‘—æå‡ã€‚</p>
<blockquote class="blockquote">
<p>Notably, during training, DeepSeek-R1-Zero exhibits an â€œaha momentâ€ characterized by a sudden increase in the use of the word â€œwaitâ€ during reflections <cite> DeepSeek-R1: Incentivizing Reasoning Capability in LLMs via Reinforcement Learning, p.5 </cite></p>
</blockquote>
<p>DeeoSeek R1-zero çš„æˆåŠŸéªŒè¯äº† RLVR æ€è·¯çš„å¯è¡Œæ€§ï¼šå³ä½¿æ²¡æœ‰ process-level supervisionï¼Œä»…å‡­ outcome-level çš„å¯éªŒè¯å¥–åŠ±ï¼ŒRL ä¹Ÿèƒ½æ¿€å‘ LLM çš„æ¨ç†èƒ½åŠ›ã€‚</p>
<blockquote class="blockquote">
<p>The self-evolution of DeepSeek-R1-Zero underscores the power and beauty of RL: rather than explicitly teaching the model how to solve a problem, we simply provide it with the right incentives, and it autonomously develops advanced problem-solving strategies. <cite> DeepSeek-R1: Incentivizing Reasoning Capability in LLMs via Reinforcement Learning, p.5 </cite></p>
</blockquote>
<p>ä¸è¿‡è¯¾ç¨‹ä¸­æåˆ°ï¼ŒCoT å˜é•¿ã€â€œaha/backtrackingâ€ç­‰ç°è±¡ï¼›å¯èƒ½æ˜¯æ¥è‡ªç›®æ ‡/å®ç°ç»†èŠ‚çš„åç½®ï¼Œä¸ä¸€å®šæ˜¯â€œå­¦ä¼šæ›´æ·±æ€è€ƒâ€çš„å¿…ç„¶ï¼Œ â€œahaâ€è¿™ç±»æ–‡æœ¬ä¹Ÿå¯èƒ½åœ¨åº•åº§æ¨¡å‹ä¸Šå¶å‘å‡ºç°ï¼Œä¸å¿…è¿‡åº¦ç¥åŒ–â€œæ¶Œç°â€ã€‚</p>
<div id="fig-" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig--caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./assets/Aha-moment-dr-grpo.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig--caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: shows two examples to demonstrate that the DeepSeek-V3-Base model already exhibits the so-called â€œaha momentâ€ even before the RL-tuning (Image Source <span class="citation" data-cites="UnderstandingR1ZeroLikeTraining2025liu">(<a href="#ref-UnderstandingR1ZeroLikeTraining2025liu" role="doc-biblioref">Liu et al. 2025</a>)</span>)
</figcaption>
</figure>
</div>
<p>åœ¨è¿™ä¸ªé˜¶æ®µï¼ŒDeepSeek R1-zero çš„è®­ç»ƒé‡‡ç”¨äº† GRPO <a href="#algo-grpo" class="quarto-xref">Algorithm 1</a> ç®—æ³•ï¼Œå¹¶è®¾è®¡äº†ä¸“é—¨çš„å¥–åŠ±å‡½æ•°ï¼š</p>
<ul>
<li><strong>Outcome-level å¥–åŠ±</strong>ï¼šä¸»è¦åŒ…æ‹¬ accuracy å¥–åŠ±ï¼ˆç­”æ¡ˆæ­£ç¡®ä¸å¦ï¼‰å’Œ format å¥–åŠ±ï¼ˆè¾“å‡ºæ ¼å¼æ˜¯å¦ç¬¦åˆè¦æ±‚ï¼‰</li>
</ul>
</section>
<section id="from-deepseek-r1-zero-to-deepseek-r1" class="level3" data-number="4.1.2">
<h3 data-number="4.1.2" class="anchored" data-anchor-id="from-deepseek-r1-zero-to-deepseek-r1"><span class="header-section-number">4.1.2</span> From DeepSeek-R1-Zero to DeepSeek-R1</h3>
<p>DeepSeek-R1-zero å¾ˆå¥½ï¼Œä½†æ˜¯å®ƒå­˜åœ¨å‡ ä¸ªé—®é¢˜ï¼š</p>
<blockquote class="blockquote">
<p>Although DeepSeek-R1-Zero exhibits strong reasoning capabilities, it faces several issues. DeepSeek-R1-Zero struggles with challenges like <strong>poor readability</strong>, and <strong>language mixing</strong>, as DeepSeek-V3-Base is trained on multiple languages, especially English and Chinese. <cite> DeepSeek-R1: Incentivizing Reasoning Capability in LLMs via Reinforcement Learning, p.6 </cite></p>
</blockquote>
<p>å› æ­¤ï¼Œåœ¨R1-zeroçš„åŸºç¡€ä¸Šï¼ŒDeepSeekå›¢é˜Ÿè®¾è®¡äº† DeepSeek-R1 çš„è®­ç»ƒæ–¹æ¡ˆï¼Œæ¥æå‡æ¨¡å‹çš„è¡¨è¾¾è´¨é‡ä¸è¡Œä¸º ç¨³å®šæ€§ã€‚å…·ä½“æ¥è¯´ï¼š</p>
<ul>
<li><strong>SFT å†·å¯åŠ¨</strong>ï¼šåˆ©ç”¨ R1-zero é‡‡æ ·å¾—åˆ°çš„å¤§é‡æ¨ç†è½¨è¿¹ï¼Œç»è¿‡è¿‡æ»¤ä¸äººå·¥/æ¨¡å‹ç²¾ä¿®åï¼Œå¯¹ V3 Base è¿›è¡Œ Cold-start Long CoT çš„ SFTï¼Œå¾—åˆ° R1 Dev ç³»åˆ—æ¨¡å‹ï¼›</li>
<li><strong>å¤šè½® GRPO å¼ RL</strong>ï¼šéšåå†é€šè¿‡å¤šè½® GRPO å¼ RLï¼Œå¼•å…¥è¯­è¨€ä¸€è‡´æ€§å¥–åŠ±ã€åå¥½å¥–åŠ±ä»¥åŠæ›´ä¸°å¯Œçš„ä»»åŠ¡åˆ†å¸ƒï¼Œé€æ­¥æŠŠæ¨¡å‹ä»â€œåªä¼šè§£é¢˜â€æ¨å‘â€œæ¨ç†å¼ºã€è¡¨è¾¾ç¨³å®šã€è¡Œä¸ºå¯æ§â€çš„äº§å“çº§æ¨¡å‹ã€‚</li>
</ul>
<blockquote class="blockquote">
<p>In the initial stage, we collect thousands of <strong>cold-start data</strong> that exhibits a conversational, human-aligned thinking process. RL training is then applied to improve the model performance with the conversational thinking process and language consistency. Subsequently, we apply rejection sampling and SFT once more. This stage incorporates both reasoning and nonreasoning datasets into the SFT process, enabling the model to not only excel in reasoning tasks but also demonstrate advanced writing capabilities. To further align the model with human preferences, we implement a secondary RL stage designed to enhance the modelâ€™s helpfulness and harmlessness while simultaneously refining its reasoning capabilities. <cite> DeepSeek-R1: Incentivizing Reasoning Capability in LLMs via Reinforcement Learning, p.6 </cite></p>
</blockquote>
<p>åŒæ—¶ï¼ŒDeepSeek R1 ä¹Ÿåœ¨å¥–åŠ±è®¾è®¡ä¸Šåšäº†æ”¹è¿›ï¼š</p>
<ul>
<li><strong>å¤šç»´å¥–åŠ±è®¾è®¡</strong>ï¼šä¸ä»…åŒ…å«å¯éªŒè¯çš„ outcome-level å¥–åŠ±ï¼ˆaccuracyã€formatï¼‰ï¼Œè¿˜å¼•å…¥äº†Language consistency rewardã€Preference / non-verifiable rewardsï¼ˆé€šè¿‡å¯¹æ¯”å­¦ä¹ è®­ç»ƒçš„åå¥½æ¨¡å‹ï¼‰ç­‰ï¼Œæ›´å…¨é¢åœ°è¡¡é‡æ¨¡å‹è¾“å‡ºè´¨é‡ï¼›</li>
<li><strong>å¥–åŠ±æ··åˆä¸è°ƒä¼˜</strong>ï¼šé€šè¿‡å¯¹ä¸åŒå¥–åŠ±è¿›è¡ŒåŠ æƒæ··åˆä¸è°ƒä¼˜ï¼Œç¡®ä¿æ¨¡å‹åœ¨æå‡æ¨ç†èƒ½åŠ›çš„åŒæ—¶ï¼Œä¹Ÿèƒ½å…¼é¡¾è¡¨è¾¾è´¨é‡ä¸è¡Œä¸ºç¨³å®šæ€§ã€‚</li>
<li><strong>æŒç»­çš„å¥–åŠ±æ¨¡å‹è®­ç»ƒ</strong>ï¼šåœ¨ RL è®­ç»ƒè¿‡ç¨‹ä¸­ï¼ŒæŒç»­æ›´æ–°å¥–åŠ±æ¨¡å‹ï¼Œä»¥é€‚åº”æ¨¡å‹èƒ½åŠ›çš„æå‡ä¸ä»»åŠ¡åˆ†å¸ƒçš„å˜åŒ–ã€‚</li>
</ul>
</section>
<section id="deepseek-distillation" class="level3" data-number="4.1.3">
<h3 data-number="4.1.3" class="anchored" data-anchor-id="deepseek-distillation"><span class="header-section-number">4.1.3</span> DeepSeek Distillation</h3>
<p>åœ¨ DeepSeek R1 è®­ç»ƒå®Œæˆåï¼Œç ”ç©¶è€…è¿˜è¿›è¡Œäº†è’¸é¦ï¼ˆdistillationï¼‰ï¼Œä»¥æå‡æ¨¡å‹çš„æ¨ç†æ•ˆç‡ä¸å®ç”¨æ€§.</p>
<blockquote class="blockquote">
<p>To enable broader access to powerful AI at a lower energy cost, we have distilled several smaller models and made them publicly available. <cite> DeepSeek-R1: Incentivizing Reasoning Capability in LLMs via Reinforcement Learning, p.2 </cite></p>
</blockquote>
<p>å…·ä½“çš„æ–¹æ³•å°±æ˜¯ï¼šç”¨ R1 ä½œä¸º teacher æ¨¡å‹ï¼Œç”Ÿæˆå¤§é‡é«˜è´¨é‡çš„æ¨ç†æ ·æœ¬ï¼Œç„¶åå¯¹æ›´å°çš„ student æ¨¡å‹è¿›è¡Œ SFT è’¸é¦è®­ç»ƒã€‚</p>
<blockquote class="blockquote">
<p>For distilled models, we apply only SFT and do not include an RL stage, even though incorporating RL could substantially boost model performance. <cite> DeepSeek-R1: Incentivizing Reasoning Capability in LLMs via Reinforcement Learning, p.60 </cite></p>
</blockquote>
</section>
</section>
<section id="kimi-1.5" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="kimi-1.5"><span class="header-section-number">4.2</span> Kimi 1.5</h2>
<p>å’Œ DeepSeek R1 æ›´åƒâ€œé…æ–¹é©±åŠ¨ï¼ˆSFTâ†’RLâ†’å†å¯¹é½ï¼‰â€ä¸åŒï¼Œè¯¾ç¨‹æŠŠ Kimi 1.5 çš„ç»éªŒæ€»ç»“æˆä¸€å¥è¯ï¼š<strong>data is king</strong>ã€‚Kimi çš„æ ¸å¿ƒä¸æ˜¯æå‡ºå…¨æ–° RL ç®—æ³•ï¼Œè€Œæ˜¯æŠŠâ€œå¯éªŒè¯å¥–åŠ±æ¨ç† RLâ€å˜æˆä¸€æ¡æ›´å·¥ç¨‹åŒ–çš„æ•°æ®ç®¡çº¿ï¼šå…ˆå¯¹ä»»åŠ¡åšè·¨é¢†åŸŸåˆ†ç±»ä¸åˆ†å¸ƒå¹³è¡¡ï¼Œé¿å…æ¨¡å‹åªåœ¨å•ä¸€ç±»å‹é¢˜ä¸Šå˜å¼ºï¼›åŒæ—¶ä¸»åŠ¨å‰”é™¤å®¹æ˜“é€šè¿‡éšæœºçŒœæµ‹è·å¾—å¥–åŠ±çš„é¢˜å‹ï¼ˆä¾‹å¦‚é€‰æ‹©é¢˜ã€åˆ¤æ–­é¢˜ï¼‰ï¼Œä¼˜å…ˆä¿ç•™çŸ­ç­”æ¡ˆã€å¯è¢«è§„åˆ™/åˆ¤å®šå™¨é«˜ç²¾åº¦éªŒè¯çš„ä»»åŠ¡ï¼Œä»¥å‡å°‘ reward hacking çš„ç©ºé—´ã€‚</p>
<p>æœ€å…³é”®çš„ä¸€æ­¥æ˜¯ best-of-n éš¾åº¦ç­›é€‰ï¼šç”¨å½“å‰è¿˜ä¸å¤Ÿå¼ºçš„ SFT æ¨¡å‹å¯¹æ¯é“é¢˜é‡‡æ ·å¤šæ¬¡ï¼ˆè¯¾ä¸Šä¸¾ä¾‹ç±»ä¼¼ best-of-8ï¼‰ï¼Œç„¶ååªä¿ç•™â€œé‡‡æ ·å¤šæ¬¡ä»ç„¶å¤±è´¥â€çš„é¢˜ï¼ˆfail best-of-nï¼‰ã€‚ç›´è§‰ä¸Šï¼Œè¿™ç›¸å½“äºæŠŠè®­ç»ƒæ•°æ®é™åˆ¶åœ¨â€œå½“å‰æ¨¡å‹ç¡®å®ä¸ä¼šï¼Œä½†åˆå¯èƒ½å­¦ä¼šâ€çš„å¯å­¦åŒºé—´ï¼Œæ˜¾å¼åšå‡ºä¸€ç§ curriculum çš„é›å½¢ï¼šå¤ªå®¹æ˜“çš„é¢˜å­¦ä¸åˆ°ä¸œè¥¿ï¼Œå¤ªéš¾çš„é¢˜åªä¼šäº§ç”Ÿå¤§é‡ 0 rewardï¼›è€Œç»è¿‡ç­›é€‰çš„é¢˜æ›´å¯èƒ½æä¾›ç¨³å®šçš„å­¦ä¹ ä¿¡å·ã€‚è¯¾ç¨‹çš„ takeaway æ˜¯ï¼šåœ¨ RLVR åœºæ™¯é‡Œï¼Œæ•°æ®éš¾åº¦æ§åˆ¶å¾€å¾€æ¯”ç®—æ³• tweak æ›´å†³å®šè®­ç»ƒæ•ˆç‡å’Œæœ€ç»ˆè¡Œä¸ºã€‚</p>
</section>
<section id="qwen3" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="qwen3"><span class="header-section-number">4.3</span> Qwen3</h2>
<p>è¯¾ç¨‹åœ¨è®² Qwen3 æ—¶ï¼Œå¼ºè°ƒå®ƒçš„äº®ç‚¹ä¸åªæ˜¯â€œä¹Ÿç”¨äº† RLVR/GRPOâ€ï¼Œè€Œæ˜¯æŠŠæ¨ç†æ¨¡å‹åœ¨çœŸå®ä½¿ç”¨åœºæ™¯é‡Œçš„ä¸€ä¸ªæ ¸å¿ƒçŸ›ç›¾æ‘†åˆ°å°é¢ä¸Šï¼šæ¨ç†è¶Šå¼ºï¼Œå¾€å¾€è¶Šè´µï¼ˆæ›´é•¿çš„ CoTã€æ›´é«˜çš„ test-time computeï¼‰ã€‚å› æ­¤ Qwen3 çš„æ€è·¯æ›´åƒæ˜¯æŠŠâ€œæ¨ç†èƒ½åŠ›â€å’Œâ€œæ¨ç†æˆæœ¬â€ä¸€èµ·çº³å…¥è®­ç»ƒç›®æ ‡ï¼šä¸€æ–¹é¢æ²¿ç”¨ â€œSFTï¼ˆé•¿ CoT å†·å¯åŠ¨ï¼‰â†’ å¯éªŒè¯å¥–åŠ± RLï¼ˆæå‡æ¨ç†æ­£ç¡®æ€§ï¼‰â†’ å†åšé€šç”¨å¯¹é½â€ çš„ä¸»çº¿ï¼›å¦ä¸€æ–¹é¢é€šè¿‡è®­ç»ƒä¸æ•°æ®/å¥–åŠ±è®¾è®¡ï¼Œè®©æ¨¡å‹å­¦ä¼šåœ¨ä¸åŒé—®é¢˜ä¸Šè‡ªé€‚åº”åœ°é€‰æ‹©æ¨ç†å¼ºåº¦â€”â€”è¯¥è®¤çœŸæ¨æ—¶èƒ½æ¨å¾—æ·±ï¼Œä¸éœ€è¦æ¨ç†æ—¶ä¹Ÿèƒ½èµ°æ›´çŸ­ã€æ›´ä¾¿å®œçš„è·¯å¾„ã€‚</p>
<p>ä»è¯¾ç¨‹è§†è§’çœ‹ï¼ŒQwen3 ä½“ç°äº†ä¸€ç§å¾ˆå®ç”¨çš„äº§å“åŒ–å–å‘ï¼šæ¨ç†æ¨¡å‹æœ€ç»ˆè¦åœ¨â€œæ­£ç¡®ç‡â€å’Œâ€œæˆæœ¬/å»¶è¿Ÿâ€ä¹‹é—´åšæƒè¡¡ï¼Œå•çº¯è¿½æ±‚ CoT å˜é•¿å¹¶ä¸ç­‰ä»·äºæ›´å¥½ã€‚ä¸ DeepSeek R1 æ›´å¼ºè°ƒâ€œç”¨ RL æ¿€æ´»æ¨ç†â€ä»¥åŠ Kimi æ›´å¼ºè°ƒâ€œç”¨æ•°æ®ç­›é€‰åš curriculumâ€ç›¸æ¯”ï¼ŒQwen3 æ›´åƒæ˜¯åœ¨æ¢ç´¢ï¼šå¦‚ä½•æŠŠâ€œè®¡ç®—é¢„ç®—å¯æ§â€å˜æˆæ¨¡å‹è¡Œä¸ºçš„ä¸€éƒ¨åˆ†ï¼Œä»è€Œé¿å… RL è®­ç»ƒæŠŠ CoT æ‹‰çˆ†ã€æˆæœ¬å¤±æ§çš„å‰¯ä½œç”¨ã€‚</p>
</section>
</section>
<section id="grpo-implementation" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> GRPO Implementation</h1>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œæ¥å…·ä½“çœ‹çœ‹GRPOçš„ç®—æ³•ã€‚è¿™ä¸ªä¾‹å­æ˜¯æ¥è‡ª <a href="https://stanford-cs336.github.io/spring2025-lectures/?trace=var/traces/lecture_17.json">Lecture17</a><strong>group baseline / æ ‡å‡†åŒ–ä¼˜åŠ¿ / clip ratio</strong> è¿™äº› GRPO/PPO å®¶æ—çš„æ ¸å¿ƒæœºåˆ¶, æˆ‘ä»¬ä¼šæ ¹æ® <a href="#algo-grpo" class="quarto-xref">Algorithm 1</a> ä¸­çš„ä¼ªä»£ç ï¼Œä¸€æ­¥æ­¥å®ç° GRPOã€‚</p>
<section id="data-goal" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="data-goal"><span class="header-section-number">5.1</span> Data &amp; Goal</h2>
<p><strong>ä»»åŠ¡ï¼šæ’åºï¼ˆSortingï¼‰</strong></p>
<ul>
<li><strong>Prompt</strong>ï¼šé•¿åº¦ä¸º LLL çš„æ•´æ•°åºåˆ—ï¼Œä¾‹å¦‚ <code>[3, 1, 2, 0]</code></li>
<li><strong>Response</strong>ï¼šæ¨¡å‹è¾“å‡ºåŒæ ·é•¿åº¦ LLL çš„åºåˆ—ï¼Œå¸Œæœ›æ˜¯æ’åºåçš„ç»“æœ <code>[0, 1, 2, 3]</code></li>
<li><strong>group ç»“æ„ï¼ˆGRPO çš„å…³é”®ï¼‰</strong>ï¼šå¯¹åŒä¸€ä¸ª promptï¼Œé‡‡æ · <span class="math inline">\(k\)</span> æ¡ response <span class="math inline">\(\{a^{(1)}, a^{(2)}, \dots, a^{(K)}\}\)</span> å½¢æˆä¸€ç»„ï¼Œç”¨äºè®¡ç®—ç»„å†… baselineï¼ˆå‡å€¼/æ ‡å‡†å·®ï¼‰ã€‚</li>
</ul>
<div class="sourceCode" id="cb4" data-code-line-numbers=""><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">def</span> gen_prompts(batch_size: <span class="bu">int</span>, seq_len: <span class="bu">int</span>, vocab_size: <span class="bu">int</span>, device) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb4-2"><a href="#cb4-2"></a>    <span class="cf">return</span> torch.randint(low<span class="op">=</span><span class="dv">0</span>, high<span class="op">=</span>vocab_size, size<span class="op">=</span>(batch_size, seq_len), device<span class="op">=</span>device)</span>
<span id="cb4-3"><a href="#cb4-3"></a></span>
<span id="cb4-4"><a href="#cb4-4"></a></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="kw">def</span> sorted_ground_truth(prompt: torch.Tensor) <span class="op">-&gt;</span> torch.Tensor:</span>
<span id="cb4-6"><a href="#cb4-6"></a>    <span class="cf">return</span> torch.sort(prompt, dim<span class="op">=-</span><span class="dv">1</span>).values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="reward" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="reward"><span class="header-section-number">5.2</span> Reward</h2>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å®šä¹‰ reward å‡½æ•°ã€‚Lecture é‡Œå¼ºè°ƒï¼šå¦‚æœ reward åªç»™ <code>0/1</code>ï¼ˆå®Œå…¨æ­£ç¡®/é”™è¯¯ï¼‰ï¼Œä¼šå¯¼è‡´<strong>ç¨€ç–å¥–åŠ±</strong>ï¼Œè®­ç»ƒå¾ˆå®¹æ˜“å¡ä½ã€‚å› æ­¤è¿™é‡Œä½¿ç”¨ <strong>partial credit</strong>æ¥è®©å­¦ä¹ æ›´å¹³æ»‘ã€‚</p>
<section id="reward-v2inclusion-adjacent-sorted-pairsè¯¾å ‚é‡‡ç”¨çš„æ›´ç»†å¥–åŠ±" class="level3" data-number="5.2.1">
<h3 data-number="5.2.1" class="anchored" data-anchor-id="reward-v2inclusion-adjacent-sorted-pairsè¯¾å ‚é‡‡ç”¨çš„æ›´ç»†å¥–åŠ±"><span class="header-section-number">5.2.1</span> Reward v2ï¼šInclusion + Adjacent Sorted Pairsï¼ˆè¯¾å ‚é‡‡ç”¨çš„æ›´ç»†å¥–åŠ±ï¼‰</h3>
<p>ç»™å®š prompt <span class="math inline">\(x\)</span> å’Œ response <span class="math inline">\(y\)</span>ï¼š</p>
<ol type="1">
<li><strong>Inclusion reward</strong>ï¼šprompt é‡Œçš„ token åœ¨ response é‡Œå‡ºç°å°±ç»™åˆ†ï¼ˆæŒ‰è®¡æ•°ï¼Œå¤šé‡é›†ï¼‰</li>
</ol>
<p><span id="eq-reward-inclusion"><span class="math display">\[
\text{Inclusion reward:} \quad R_{\text{inc}}(x,y)=\sum_{t} \min(\text{count}_x(t), \text{count}_y(t))
\tag{11}\]</span></span></p>
<ol start="2" type="1">
<li><strong>Adjacent sorted pairs</strong>ï¼šç»Ÿè®¡ response ä¸­ç›¸é‚»å¯¹æ»¡è¶³éé™åºçš„ä¸ªæ•°</li>
</ol>
<p><span id="eq-reward-adjacent-sorted-pairs"><span class="math display">\[
\text{Adjacent sorted pairs:} \quad R_{\text{adj}}(y)=\sum_{i=1}^{L-1}\mathbb{I}[y_i \le y_{i+1}]
\tag{12}\]</span></span></p>
<p>æ€» rewardï¼š</p>
<p><span id="eq-reward-total"><span class="math display">\[
\text{Total reward:} \quad R(x,y)=R_{\text{inc}}(x,y)+R_{\text{adj}}(y)
\tag{13}\]</span></span></p>
<div class="highlight">
<p>è¯¾å ‚ä¹Ÿæåˆ°ï¼šè¿™ç§ reward å¯èƒ½å­˜åœ¨â€œæ¼æ´â€ï¼ˆreward hackï¼‰ï¼Œå› æ­¤ reward è®¾è®¡æœ¬èº«å°±æ˜¯ RL çš„éš¾ç‚¹ä¹‹ä¸€ã€‚</p>
</div>
<div class="sourceCode" id="cb5" data-code-line-numbers=""><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">def</span> sort_distance_reward(prompt: <span class="bu">list</span>[<span class="bu">int</span>], response: <span class="bu">list</span>[<span class="bu">int</span>]) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb5-2"><a href="#cb5-2"></a>    <span class="cf">assert</span> <span class="bu">len</span>(prompt) <span class="op">==</span> <span class="bu">len</span>(response)</span>
<span id="cb5-3"><a href="#cb5-3"></a>    ground_truth <span class="op">=</span> <span class="bu">sorted</span>(prompt)</span>
<span id="cb5-4"><a href="#cb5-4"></a>    <span class="cf">return</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> x, y <span class="kw">in</span> <span class="bu">zip</span>(response, ground_truth) <span class="cf">if</span> x <span class="op">==</span> y)</span>
<span id="cb5-5"><a href="#cb5-5"></a></span>
<span id="cb5-6"><a href="#cb5-6"></a></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="kw">def</span> sort_inclusion_ordering_reward(prompt: <span class="bu">list</span>[<span class="bu">int</span>], response: <span class="bu">list</span>[<span class="bu">int</span>]) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb5-8"><a href="#cb5-8"></a>    <span class="co">"""</span></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="co">    Return how close response is to ground_truth = sorted(prompt).</span></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="co">    """</span></span>
<span id="cb5-11"><a href="#cb5-11"></a>    <span class="cf">assert</span> <span class="bu">len</span>(prompt) <span class="op">==</span> <span class="bu">len</span>(response)</span>
<span id="cb5-12"><a href="#cb5-12"></a>    <span class="co"># Give one point for each token in the prompt that shows up in the response</span></span>
<span id="cb5-13"><a href="#cb5-13"></a>    inclusion_reward <span class="op">=</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> x <span class="kw">in</span> prompt <span class="cf">if</span> x <span class="kw">in</span> response)  <span class="co"># @inspect inclusion_reward</span></span>
<span id="cb5-14"><a href="#cb5-14"></a>    <span class="co"># Give one point for each adjacent pair in response that's sorted</span></span>
<span id="cb5-15"><a href="#cb5-15"></a>    ordering_reward <span class="op">=</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> x, y <span class="kw">in</span> <span class="bu">zip</span>(response, response[<span class="dv">1</span>:]) <span class="cf">if</span> x <span class="op">&lt;=</span> y)  <span class="co"># @inspect ordering_reward</span></span>
<span id="cb5-16"><a href="#cb5-16"></a>    <span class="cf">return</span> inclusion_reward <span class="op">+</span> ordering_reward</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="model" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="model"><span class="header-section-number">5.3</span> Model</h2>
<p>å¯¹äºè¿™ä¸ªä»»åŠ¡ï¼Œæˆ‘ä»¬å°±å®šä¸€ä¸ªç®€å•çš„æ¨¡å‹ï¼š</p>
<div class="sourceCode" id="cb6" data-code-line-numbers=""><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw">class</span> ToySortPolicy(nn.Module):</span>
<span id="cb6-2"><a href="#cb6-2"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, vocab_size: <span class="bu">int</span>, embedding_dim: <span class="bu">int</span>, prompt_length: <span class="bu">int</span>, response_length: <span class="bu">int</span>):</span>
<span id="cb6-3"><a href="#cb6-3"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb6-4"><a href="#cb6-4"></a></span>
<span id="cb6-5"><a href="#cb6-5"></a>        <span class="va">self</span>.embedding_dim <span class="op">=</span> embedding_dim</span>
<span id="cb6-6"><a href="#cb6-6"></a>        <span class="va">self</span>.emb <span class="op">=</span> nn.Embedding(vocab_size, embedding_dim)</span>
<span id="cb6-7"><a href="#cb6-7"></a>        <span class="va">self</span>.enc <span class="op">=</span> nn.Parameter(</span>
<span id="cb6-8"><a href="#cb6-8"></a>            torch.randn(prompt_length, embedding_dim, embedding_dim) <span class="op">/</span> math.sqrt(embedding_dim)</span>
<span id="cb6-9"><a href="#cb6-9"></a>        )</span>
<span id="cb6-10"><a href="#cb6-10"></a>        <span class="va">self</span>.dec <span class="op">=</span> nn.Parameter(</span>
<span id="cb6-11"><a href="#cb6-11"></a>            torch.randn(response_length, embedding_dim, embedding_dim) <span class="op">/</span> math.sqrt(embedding_dim)</span>
<span id="cb6-12"><a href="#cb6-12"></a>        )</span>
<span id="cb6-13"><a href="#cb6-13"></a>        <span class="va">self</span>.out <span class="op">=</span> nn.Linear(embedding_dim, vocab_size)</span>
<span id="cb6-14"><a href="#cb6-14"></a></span>
<span id="cb6-15"><a href="#cb6-15"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, prompt):</span>
<span id="cb6-16"><a href="#cb6-16"></a>        x <span class="op">=</span> <span class="va">self</span>.emb(prompt)  <span class="co"># (B,L,d1)</span></span>
<span id="cb6-17"><a href="#cb6-17"></a>        h <span class="op">=</span> torch.einsum(<span class="st">"bld,ldm-&gt;bm"</span>, x, <span class="va">self</span>.enc)  <span class="co"># (B,d2)</span></span>
<span id="cb6-18"><a href="#cb6-18"></a>        z <span class="op">=</span> torch.einsum(<span class="st">"bm,lmd-&gt;bld"</span>, h, <span class="va">self</span>.dec)  <span class="co"># (B,L,d1)</span></span>
<span id="cb6-19"><a href="#cb6-19"></a>        <span class="cf">return</span> <span class="va">self</span>.out(z)  <span class="co"># (B,L,V)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="algorithm" class="level2" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="algorithm"><span class="header-section-number">5.4</span> Algorithm</h2>
<div class="sourceCode" id="cb7" data-code-line-numbers=""><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">def</span> grpo(cfg: GRPOCfg <span class="op">=</span> GRPOCfg()):</span>
<span id="cb7-2"><a href="#cb7-2"></a>    dev <span class="op">=</span> get_device()</span>
<span id="cb7-3"><a href="#cb7-3"></a>    set_seed(cfg.seed)</span>
<span id="cb7-4"><a href="#cb7-4"></a></span>
<span id="cb7-5"><a href="#cb7-5"></a>    policy <span class="op">=</span> ToySortPolicy(cfg.V, cfg.L, cfg.L, cfg.L).to(dev)</span>
<span id="cb7-6"><a href="#cb7-6"></a>    opt <span class="op">=</span> torch.optim.Adam(policy.parameters(), lr<span class="op">=</span>cfg.lr)</span>
<span id="cb7-7"><a href="#cb7-7"></a></span>
<span id="cb7-8"><a href="#cb7-8"></a>    reward_fn <span class="op">=</span> REWARD_FN_MAP[cfg.reward_fn]</span>
<span id="cb7-9"><a href="#cb7-9"></a></span>
<span id="cb7-10"><a href="#cb7-10"></a>    <span class="co"># reference model (slow-moving anchor for KL)</span></span>
<span id="cb7-11"><a href="#cb7-11"></a>    ref <span class="op">=</span> ToySortPolicy(cfg.V, cfg.L, cfg.L, cfg.L).to(dev)</span>
<span id="cb7-12"><a href="#cb7-12"></a>    ref.load_state_dict(policy.state_dict())</span>
<span id="cb7-13"><a href="#cb7-13"></a>    ref.<span class="bu">eval</span>()</span>
<span id="cb7-14"><a href="#cb7-14"></a></span>
<span id="cb7-15"><a href="#cb7-15"></a>    <span class="cf">for</span> it <span class="kw">in</span> <span class="bu">range</span>(cfg.outer_iters):</span>
<span id="cb7-16"><a href="#cb7-16"></a>        <span class="co"># update reference model slowly</span></span>
<span id="cb7-17"><a href="#cb7-17"></a>        <span class="cf">if</span> cfg.use_kl <span class="kw">and</span> it <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> (it <span class="op">%</span> cfg.ref_update_every <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb7-18"><a href="#cb7-18"></a>            ref.load_state_dict(policy.state_dict())</span>
<span id="cb7-19"><a href="#cb7-19"></a>            ref.<span class="bu">eval</span>()</span>
<span id="cb7-20"><a href="#cb7-20"></a></span>
<span id="cb7-21"><a href="#cb7-21"></a>        <span class="co"># ---------- OUTER: rollout + rewards + deltas + freeze old/ref logps</span></span>
<span id="cb7-22"><a href="#cb7-22"></a>        prompt <span class="op">=</span> gen_prompts(cfg.B, cfg.L, cfg.V, dev)  <span class="co"># (B,L)</span></span>
<span id="cb7-23"><a href="#cb7-23"></a></span>
<span id="cb7-24"><a href="#cb7-24"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb7-25"><a href="#cb7-25"></a>            responses <span class="op">=</span> sample_responses(policy, prompt, cfg.K, cfg.temperature)  <span class="co"># (B,K,L)</span></span>
<span id="cb7-26"><a href="#cb7-26"></a>            rewards <span class="op">=</span> compute_reward(prompt, responses, reward_fn)  <span class="co"># (B,K)</span></span>
<span id="cb7-27"><a href="#cb7-27"></a>            deltas <span class="op">=</span> compute_deltas(rewards, cfg.delta_mode)  <span class="co"># (B,K)</span></span>
<span id="cb7-28"><a href="#cb7-28"></a></span>
<span id="cb7-29"><a href="#cb7-29"></a>            <span class="co"># IMPORTANT: freeze old logps (detach)</span></span>
<span id="cb7-30"><a href="#cb7-30"></a>            old_logp_token <span class="op">=</span> compute_log_probs(prompt, responses, policy).detach()  <span class="co"># (B,K,L)</span></span>
<span id="cb7-31"><a href="#cb7-31"></a></span>
<span id="cb7-32"><a href="#cb7-32"></a>            <span class="co"># freeze ref logps for KL (detach)</span></span>
<span id="cb7-33"><a href="#cb7-33"></a>            ref_logp_token <span class="op">=</span> compute_log_probs(prompt, responses, ref).detach() <span class="cf">if</span> cfg.use_kl <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb7-34"><a href="#cb7-34"></a></span>
<span id="cb7-35"><a href="#cb7-35"></a>        <span class="co"># ---------- INNER: multiple gradient steps on same samples</span></span>
<span id="cb7-36"><a href="#cb7-36"></a>        <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(cfg.inner_steps):</span>
<span id="cb7-37"><a href="#cb7-37"></a>            opt.zero_grad(set_to_none<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-38"><a href="#cb7-38"></a></span>
<span id="cb7-39"><a href="#cb7-39"></a>            logp_token <span class="op">=</span> compute_log_probs(prompt, responses, policy)  <span class="co"># (B,K,L)</span></span>
<span id="cb7-40"><a href="#cb7-40"></a></span>
<span id="cb7-41"><a href="#cb7-41"></a>            loss <span class="op">=</span> compute_loss(</span>
<span id="cb7-42"><a href="#cb7-42"></a>                log_probs<span class="op">=</span>logp_token,</span>
<span id="cb7-43"><a href="#cb7-43"></a>                old_log_probs<span class="op">=</span>old_logp_token,</span>
<span id="cb7-44"><a href="#cb7-44"></a>                deltas<span class="op">=</span>deltas,</span>
<span id="cb7-45"><a href="#cb7-45"></a>                mode<span class="op">=</span>cfg.loss_mode,</span>
<span id="cb7-46"><a href="#cb7-46"></a>            )</span>
<span id="cb7-47"><a href="#cb7-47"></a></span>
<span id="cb7-48"><a href="#cb7-48"></a>            <span class="cf">if</span> cfg.use_kl:</span>
<span id="cb7-49"><a href="#cb7-49"></a>                loss <span class="op">=</span> loss <span class="op">+</span> cfg.kl_beta <span class="op">*</span> compute_kl_penalty(logp_token, ref_logp_token)</span>
<span id="cb7-50"><a href="#cb7-50"></a></span>
<span id="cb7-51"><a href="#cb7-51"></a>            loss.backward()</span>
<span id="cb7-52"><a href="#cb7-52"></a>            opt.step()</span>
<span id="cb7-53"><a href="#cb7-53"></a></span>
<span id="cb7-54"><a href="#cb7-54"></a>        <span class="cf">if</span> (it <span class="op">%</span> cfg.print_every) <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> it <span class="op">==</span> cfg.outer_iters <span class="op">-</span> <span class="dv">1</span>:</span>
<span id="cb7-55"><a href="#cb7-55"></a>            <span class="cf">with</span> torch.no_grad():</span>
<span id="cb7-56"><a href="#cb7-56"></a>                <span class="bu">print</span>(</span>
<span id="cb7-57"><a href="#cb7-57"></a>                    <span class="ss">f"iter </span><span class="sc">{</span>it<span class="sc">:04d}</span><span class="ss"> | "</span></span>
<span id="cb7-58"><a href="#cb7-58"></a>                    <span class="ss">f"reward mean </span><span class="sc">{</span>rewards<span class="sc">.</span>mean()<span class="sc">.</span>item()<span class="sc">:.3f}</span><span class="ss"> "</span></span>
<span id="cb7-59"><a href="#cb7-59"></a>                    <span class="ss">f"(min </span><span class="sc">{</span>rewards<span class="sc">.</span><span class="bu">min</span>()<span class="sc">.</span>item()<span class="sc">:.1f}</span><span class="ss">, max </span><span class="sc">{</span>rewards<span class="sc">.</span><span class="bu">max</span>()<span class="sc">.</span>item()<span class="sc">:.1f}</span><span class="ss">) | "</span></span>
<span id="cb7-60"><a href="#cb7-60"></a>                    <span class="ss">f"loss </span><span class="sc">{</span>loss<span class="sc">.</span>item()<span class="sc">:.4f}</span><span class="ss">"</span></span>
<span id="cb7-61"><a href="#cb7-61"></a>                )</span>
<span id="cb7-62"><a href="#cb7-62"></a></span>
<span id="cb7-63"><a href="#cb7-63"></a>    <span class="cf">return</span> policy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="training" class="level2" data-number="5.5">
<h2 data-number="5.5" class="anchored" data-anchor-id="training"><span class="header-section-number">5.5</span> Training</h2>
<div class="sourceCode" id="cb8" data-code-line-numbers=""><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"></a><span class="at">@dataclass</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="kw">class</span> GRPOCfg:</span>
<span id="cb8-3"><a href="#cb8-3"></a>    V: <span class="bu">int</span> <span class="op">=</span> <span class="dv">10</span>  <span class="co"># vocab size (token values 0..V-1)</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>    L: <span class="bu">int</span> <span class="op">=</span> <span class="dv">4</span>  <span class="co"># sequence length</span></span>
<span id="cb8-5"><a href="#cb8-5"></a>    B: <span class="bu">int</span> <span class="op">=</span> <span class="dv">128</span>  <span class="co"># batch prompts per outer iter</span></span>
<span id="cb8-6"><a href="#cb8-6"></a>    K: <span class="bu">int</span> <span class="op">=</span> <span class="dv">8</span>  <span class="co"># responses per prompt (group size)</span></span>
<span id="cb8-7"><a href="#cb8-7"></a>    outer_iters: <span class="bu">int</span> <span class="op">=</span> <span class="dv">200</span></span>
<span id="cb8-8"><a href="#cb8-8"></a>    inner_steps: <span class="bu">int</span> <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb8-9"><a href="#cb8-9"></a></span>
<span id="cb8-10"><a href="#cb8-10"></a>    lr: <span class="bu">float</span> <span class="op">=</span> <span class="fl">2e-2</span></span>
<span id="cb8-11"><a href="#cb8-11"></a>    temperature: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb8-12"><a href="#cb8-12"></a></span>
<span id="cb8-13"><a href="#cb8-13"></a>    delta_mode: Literal[<span class="st">"raw"</span>, <span class="st">"centered_rewards"</span>, <span class="st">"normalized_rewards"</span>, <span class="st">"max_rewards"</span>] <span class="op">=</span> <span class="st">"centered_rewards"</span></span>
<span id="cb8-14"><a href="#cb8-14"></a>    loss_mode: Literal[<span class="st">"naive"</span>, <span class="st">"unclipped"</span>, <span class="st">"clipped"</span>] <span class="op">=</span> <span class="st">"clipped"</span></span>
<span id="cb8-15"><a href="#cb8-15"></a>    clip_eps: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.2</span></span>
<span id="cb8-16"><a href="#cb8-16"></a></span>
<span id="cb8-17"><a href="#cb8-17"></a>    use_kl: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span></span>
<span id="cb8-18"><a href="#cb8-18"></a>    kl_beta: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.02</span></span>
<span id="cb8-19"><a href="#cb8-19"></a>    ref_update_every: <span class="bu">int</span> <span class="op">=</span> <span class="dv">30</span></span>
<span id="cb8-20"><a href="#cb8-20"></a></span>
<span id="cb8-21"><a href="#cb8-21"></a>    seed: <span class="bu">int</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb8-22"><a href="#cb8-22"></a>    print_every: <span class="bu">int</span> <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb8-23"><a href="#cb8-23"></a></span>
<span id="cb8-24"><a href="#cb8-24"></a>    reward_fn: Literal[<span class="st">"distance"</span>, <span class="st">"inclusion_ordering"</span>] <span class="op">=</span> <span class="st">"inclusion_ordering"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="results" class="level2" data-number="5.6">
<h2 data-number="5.6" class="anchored" data-anchor-id="results"><span class="header-section-number">5.6</span> Results</h2>
<pre class="text" data-code-line-numbers=""><code>iter 0000 | reward mean 3.070 (min 0.0, max 7.0) | loss 0.0138
iter 0020 | reward mean 3.250 (min 0.0, max 6.0) | loss 0.0034
iter 0040 | reward mean 3.396 (min 0.0, max 7.0) | loss 0.0008
iter 0060 | reward mean 3.625 (min 0.0, max 7.0) | loss 0.0016
iter 0080 | reward mean 3.813 (min 1.0, max 7.0) | loss 0.0059
iter 0100 | reward mean 4.071 (min 1.0, max 7.0) | loss 0.0043
iter 0120 | reward mean 4.278 (min 1.0, max 7.0) | loss 0.0030
iter 0140 | reward mean 4.497 (min 1.0, max 7.0) | loss 0.0058
iter 0160 | reward mean 4.710 (min 1.0, max 7.0) | loss 0.0058
iter 0180 | reward mean 4.859 (min 2.0, max 7.0) | loss 0.0033
iter 0199 | reward mean 4.964 (min 2.0, max 7.0) | loss 0.0067


=== sample check ===
prompt: [4, 2, 4, 4] | pred: [0, 2, 4, 6] | gt: [2, 4, 4, 4] | sort reward: 1 | inclusion+ordering reward: 7
prompt: [6, 8, 1, 9] | pred: [8, 9, 1, 1] | gt: [1, 6, 8, 9] | sort reward: 0 | inclusion+ordering reward: 5
prompt: [4, 3, 8, 7] | pred: [0, 3, 6, 7] | gt: [3, 4, 7, 8] | sort reward: 0 | inclusion+ordering reward: 5
prompt: [6, 0, 5, 6] | pred: [0, 5, 7, 9] | gt: [0, 5, 6, 6] | sort reward: 2 | inclusion+ordering reward: 5
prompt: [3, 1, 4, 6] | pred: [1, 1, 4, 7] | gt: [1, 3, 4, 6] | sort reward: 2 | inclusion+ordering reward: 5
prompt: [2, 7, 8, 0] | pred: [3, 7, 7, 8] | gt: [0, 2, 7, 8] | sort reward: 2 | inclusion+ordering reward: 5
prompt: [7, 9, 1, 2] | pred: [9, 9, 1, 9] | gt: [1, 2, 7, 9] | sort reward: 1 | inclusion+ordering reward: 4
prompt: [3, 6, 0, 2] | pred: [1, 1, 3, 7] | gt: [0, 2, 3, 6] | sort reward: 1 | inclusion+ordering reward: 4</code></pre>
<p>å…¨éƒ¨çš„ä»£ç å¯ä»¥åœ¨è¿™ä¸ª<a href="https://github.com/YYZhang2025/Stanford-CS336/blob/main/assignment5-alignment/simple_grpo.ipynb">Notebook</a>ä¸­çœ‹åˆ°</p>
</section>
</section>
<section id="summary" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Summary</h1>
<p>åœ¨è¿™ç¯‡ç¬”è®°ä¸­ï¼Œæˆ‘å°† Lecture 16 ä¸ Lecture 17 åˆå¹¶æ•´ç†ï¼Œå›´ç»•ä¸€ä¸ªæ ¸å¿ƒé—®é¢˜å±•å¼€ï¼šä¸ºä»€ä¹ˆä¼ ç»Ÿçš„ PPO ä¸ DPO å·²ä¸è¶³ä»¥æ”¯æ’‘æ¨ç†å‹ LLM çš„å¼ºåŒ–å­¦ä¹ ï¼Œä»¥åŠ RLVRï¼ˆReinforcement Learning from Verified Rewardsï¼‰å¦‚ä½•æˆä¸ºæ–°çš„çªç ´å£ã€‚æˆ‘é¦–å…ˆå›é¡¾äº† PPOã€DPO åœ¨æ¨ç†åœºæ™¯ä¸­çš„å·¥ç¨‹å¤æ‚åº¦ä¸æ•°æ®å½¢æ€å±€é™ï¼Œå¹¶ç”±æ­¤å¼•å‡º GRPO è¿™ä¸€ä»£è¡¨æ€§ç®—æ³•ï¼Œç³»ç»Ÿæ¢³ç†äº†å…¶ç›®æ ‡å‡½æ•°ã€åŸºäº group çš„ç›¸å¯¹ advantage è®¡ç®—ã€clip ratioã€KL çº¦æŸä»¥åŠé•¿åº¦å½’ä¸€åŒ–ç­‰å…³é”®è®¾è®¡ã€‚åœ¨æ­¤åŸºç¡€ä¸Šï¼Œæˆ‘è¿›ä¸€æ­¥åˆ†æäº† GRPO ä¸­ä¸¤ä¸ªé‡è¦ä½†å®¹æ˜“è¢«å¿½ç•¥çš„åç½®æ¥æºï¼šä¸€æ˜¯ç”±ç»„å†…å¥–åŠ±æ ‡å‡†å·®å¼•å…¥çš„ biased gradientï¼ŒäºŒæ˜¯æŒ‰å›ç­”é•¿åº¦å½’ä¸€åŒ–å¯¼è‡´çš„ length biasï¼Œå¹¶ç»“åˆ Dr.GRPO å±•ç¤ºäº†é€šè¿‡å»é™¤ 1/ä¸ length normalization æ¥ç¼“è§£è¿™äº›é—®é¢˜çš„æ€è·¯ã€‚æœ€åï¼Œæˆ‘ä»è¯¾ç¨‹è§†è§’æ€»ç»“äº† DeepSeek-R1ã€Kimi 1.5 ä¸ Qwen3 åœ¨ RLVR å®è·µä¸­çš„ä¸åŒå–å‘ï¼Œå¹¶é€šè¿‡ä¸€ä¸ªæ’åºä»»åŠ¡çš„ toy ç¤ºä¾‹ï¼Œå®Œæ•´å®ç°äº† GRPO çš„æ•°æ®ç”Ÿæˆã€å¥–åŠ±è®¾è®¡ã€æ¨¡å‹ç»“æ„ä¸è®­ç»ƒæµç¨‹ï¼Œå°†ç®—æ³•ä»å…¬å¼æ¨å¯¼çœŸæ­£è½åˆ°å¯è¿è¡Œçš„ä»£ç å±‚é¢ã€‚ # Further åœ¨å®Œæˆäº†è¿™ä¸‰èŠ‚è¯¾ç¨‹ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹Assignment05çš„å®ç°ï¼Œåœ¨Assignment05ä¸­ï¼Œæˆ‘ä»¬ä¼šå®ç°3ä¸­ç®—æ³•ï¼š</p>
<ul>
<li>SFT</li>
<li>Expert Iteration</li>
<li>GRPO</li>
</ul>
<p>å¹¶ä¸”æ¯”è¾ƒå®ƒä»¬çš„ä¸åŒï¼Œå…·ä½“çš„ä»£ç å®ç°å¯ä»¥å‚è€ƒ<a href="https://github.com/YYZhang2025/Stanford-CS336/tree/main/assignment5-alignment">GitHub</a>ï¼Œ ä»¥åŠå¯¹åº”çš„<a href="https://yyzhang2025.github.io/posts/LearningNotes/CS336/Assignments/Ass05/ass05.html">ç¬”è®°</a>ã€‚</p>
</section>
<section id="in-the-end" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> In the End</h1>
<p>æœ€åï¼Œæ„Ÿè°¢ä½ ä¸€è·¯åšæŒåˆ°è¿™é‡Œï¼åˆ›ä½œä¸æ˜“ï¼Œå¦‚æœä½ è§‰å¾—å†…å®¹å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿è¯·æˆ‘<strong>å–æ¯å’–å•¡/æ”¯ä»˜å®çº¢åŒ…</strong>ï¼Œæ”¯æŒæˆ‘ç»§ç»­åˆ›ä½œï¼ä½ ä»¬çš„æ”¯æŒæ˜¯æˆ‘æœ€å¤§çš„åŠ¨åŠ›ï¼ :) <br></p>
<p><img src="../../../style/AliPay.jpg" class="img-fluid" width="300"></p>



</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-DeepSeekR1IncentivizingReasoning2025deepseek-ai" class="csl-entry" role="listitem">
DeepSeek-AI, Daya Guo, Dejian Yang, Haowei Zhang, Junxiao Song, Peiyi Wang, Qihao Zhu, et al. 2025. <span>â€œ<span>DeepSeek-R1</span>: <span>Incentivizing Reasoning Capability</span> in <span>LLMs</span> via <span>Reinforcement Learning</span>.â€</span> <em>Nature</em> 645 (8081): 633â€“38. <a href="https://doi.org/10.1038/s41586-025-09422-z">https://doi.org/10.1038/s41586-025-09422-z</a>.
</div>
<div id="ref-UnderstandingR1ZeroLikeTraining2025liu" class="csl-entry" role="listitem">
Liu, Zichen, Changyu Chen, Wenjun Li, Penghui Qi, Tianyu Pang, Chao Du, Wee Sun Lee, and Min Lin. 2025. <span>â€œUnderstanding <span>R1-Zero-Like Training</span>: <span>A Critical Perspective</span>.â€</span> October 6, 2025. <a href="https://doi.org/10.48550/arXiv.2503.20783">https://doi.org/10.48550/arXiv.2503.20783</a>.
</div>
<div id="ref-DeepSeekMathPushingLimits2024shao" class="csl-entry" role="listitem">
Shao, Zhihong, Peiyi Wang, Qihao Zhu, Runxin Xu, Junxiao Song, Xiao Bi, Haowei Zhang, et al. 2024. <span>â€œ<span>DeepSeekMath</span>: <span>Pushing</span> the <span>Limits</span> of <span>Mathematical Reasoning</span> in <span>Open Language Models</span>.â€</span> April 27, 2024. <a href="https://doi.org/10.48550/arXiv.2402.03300">https://doi.org/10.48550/arXiv.2402.03300</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/yyzhang2025\.github\.io\/LearningNotes");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark_dimmed">
<script>
  function loadGiscus() {
    // Function to get the theme based on body class
    const getTheme = () => {
      let baseTheme = document.getElementById('giscus-base-theme').value;
      let altTheme = document.getElementById('giscus-alt-theme').value;
      if (authorPrefersDark) {
          [baseTheme, altTheme] = [altTheme, baseTheme];
      }
      return document.body.classList.contains('quarto-dark') ? altTheme : baseTheme;
    };
    const script = document.createElement("script");
    script.src = "https://giscus.app/client.js";
    script.async = true;
    script.dataset.repo = "YYZhang2025/YYZhang2025.github.io";
    script.dataset.repoId = "R_kgDOQlDTcQ";
    script.dataset.category = "General";
    script.dataset.categoryId = "DIC_kwDOQlDTcc4C2MRz";
    script.dataset.mapping = "title";
    script.dataset.reactionsEnabled = "1";
    script.dataset.emitMetadata = "0";
    script.dataset.inputPosition = "top";
    script.dataset.theme = getTheme();
    script.dataset.lang = "en";
    script.crossOrigin = "anonymous";
    // Append the script to the desired div instead of at the end of the body
    document.getElementById("quarto-content").appendChild(script);
  }
  loadGiscus();
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../../posts/CS336/Lecture15/lec15.html" class="pagination-link" aria-label="Lecture 15: LLM Alignment SFT &amp; RLHF(PPO, DPO)">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Lecture 15: LLM Alignment SFT &amp; RLHF(PPO, DPO)</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../../posts/CS336/Ass01/ass01.html" class="pagination-link" aria-label="Assignment 01: BPE Tokenizer &amp; Transformer LM">
        <span class="nav-page-text">Assignment 01: BPE Tokenizer &amp; Transformer LM</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Â© CC-By Yuyang, 2025</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>This page is built with â¤ï¸ and <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>
    <script type="text/javascript">
    (function(d) {
      d.querySelectorAll(".pseudocode-container").forEach(function(el) {
        let pseudocodeOptions = {
          indentSize: el.dataset.indentSize,
          commentDelimiter: el.dataset.commentDelimiter,
          lineNumber: el.dataset.lineNumber.toLowerCase() === "true",
          lineNumberPunc: el.dataset.lineNumberPunc,
          noEnd: el.dataset.noEnd.toLowerCase() === "true",
          titlePrefix: el.dataset.captionPrefix
        };
        pseudocode.renderElement(el.querySelector(".pseudocode"), pseudocodeOptions);
      });
    })(document);
    (function(d) {
      d.querySelectorAll(".pseudocode-container").forEach(function(el) {
        let captionSpan = el.querySelector(".ps-root > .ps-algorithm > .ps-line > .ps-keyword")
        if (captionSpan !== null) {
          let captionPrefix = el.dataset.captionPrefix + " ";
          let captionNumber = "";
          if (el.dataset.pseudocodeNumber) {
            captionNumber = el.dataset.pseudocodeNumber + " ";
            if (el.dataset.chapterLevel) {
              captionNumber = el.dataset.chapterLevel + "." + captionNumber;
            }
          }
          captionSpan.innerHTML = captionPrefix + captionNumber;
        }
      });
    })(document);
    </script>
  




<script src="../../../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.js" defer="true"></script>
</body></html>